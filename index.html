<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Keep all your existing head content] -->
    <script src="config.js"></script>
    <style>
        /* [Keep all your existing styles] */
        
        /* Add these new styles */
        .image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: #f8fafc;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }
        .image-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- [Keep all your existing body content] -->

    <script>
        // Image management system
        const imageCache = new Map();
        let imageMapping = {};

        // Load image mapping from cache or initialize
        function initImageSystem() {
            const cached = localStorage.getItem(CONFIG.CACHE_KEY);
            if (cached) {
                try {
                    imageMapping = JSON.parse(cached).data;
                    console.log('Loaded image mapping from cache');
                } catch (e) {
                    console.error('Failed to parse image cache', e);
                }
            }
        }

        // Enhanced image loader
        function loadProductImage(imgElement, sku) {
            const cacheKey = `img_${sku}`;
            
            // Use cached image if available
            if (imageCache.has(cacheKey)) {
                imgElement.src = imageCache.get(cacheKey);
                return;
            }
            
            // Show loading state
            imgElement.style.opacity = '0';
            const loader = document.createElement('div');
            loader.className = 'image-loading';
            loader.innerHTML = '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>';
            imgElement.parentNode.appendChild(loader);
            
            // Load image
            const img = new Image();
            img.onload = function() {
                imageCache.set(cacheKey, this.src);
                imgElement.src = this.src;
                imgElement.style.opacity = '1';
                loader.remove();
            };
            img.onerror = function() {
                imgElement.src = `https://via.placeholder.com/300x200/e2e8f0/64748b?text=${sku}`;
                imgElement.style.opacity = '1';
                loader.remove();
            };
            
            // Use mapped URL or fallback
            img.src = imageMapping[sku]?.url || `https://via.placeholder.com/300x200/e2e8f0/64748b?text=${sku}`;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initImageSystem();
            initializeCatalog(); // Your existing catalog init
        });

        // [Keep all your existing catalog functions]
        // Modify your displayProducts() function to use loadProductImage()

        function displayProducts() {
            // [Your existing display logic]
            
            // Replace image loading code with:
            const productCards = filteredProducts.map(product => `
                <div class="product-card">
                    <div class="relative">
                        <div class="image-container">
                            <img data-sku="${product.sku}" 
                                 class="product-image" 
                                 alt="${product.description}">
                        </div>
                        <!-- [Rest of your card HTML] -->
                    </div>
                </div>
            `).join('');
            
            // [Rest of your display logic]
            
            // Load images after rendering
            document.querySelectorAll('.product-image').forEach(img => {
                loadProductImage(img, img.dataset.sku);
            });
        }
    </script>
</body>
</html>
