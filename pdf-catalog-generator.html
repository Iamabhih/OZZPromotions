<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZZ Professional Catalog Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f0f2f5; color: #1a1a1a; line-height: 1.4; }
        .control-panel { max-width: 900px; margin: 20px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); }
        .logo-header { text-align: center; margin-bottom: 30px; }
        .logo-header h1 { font-size: 32px; color: #1a1a1a; font-weight: 700; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin: 30px 0; flex-wrap: wrap; }
        button { background: #1a1a1a; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background: #333; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status-box { background: #f8f9fa; border-left: 4px solid #0066cc; padding: 15px 20px; border-radius: 4px; margin: 20px 0; }
        .category-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .category-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px; cursor: pointer; }
        .image-status { margin-top: 20px; padding: 15px; background: #e8f5e8; border-left: 4px solid #28a745; border-radius: 4px; }
        .image-status.loading { background: #fff3cd; border-color: #ffc107; }
        .image-status.error { background: #f8d7da; border-color: #dc3545; }
        #pagePreviewSection .category-item:hover { border-color: #007bff !important; background: #f8f9ff !important; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: all 0.2s ease; }
        #useExcelPages { transform: scale(1.2); accent-color: #007bff; }
        
        /* Export Section Styles */
        .export-section { 
            margin-top: 20px; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-radius: 8px; 
            color: white; 
        }
        .export-section h4 { margin-bottom: 15px; font-size: 18px; }
        .export-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .export-controls select { 
            padding: 10px; 
            border: none; 
            border-radius: 4px; 
            background: white; 
            color: #333; 
            font-size: 14px; 
        }
        .export-controls button { 
            background: rgba(255,255,255,0.2); 
            border: 2px solid white; 
        }
        .export-controls button:hover { 
            background: white; 
            color: #764ba2; 
        }
        
        /* Page Selector Modal */
        .page-selector-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .page-selector-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        .page-thumbnails {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .page-thumbnail {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-thumbnail:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }
        .page-thumbnail.selected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        /* Image Background Options */
        .image-bg-selector {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .image-bg-selector h5 { margin-bottom: 10px; color: #333; }
        .bg-option {
            display: inline-block;
            margin-right: 15px;
        }
        .bg-option input[type="radio"] {
            margin-right: 5px;
        }
        
        /* Image Preview Styles */
        #imagePreviewSection button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        #imagePreviewContainer img {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        #skuInput:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        /* Layout and Card Options */
        .layout-option { border: 2px solid #ddd; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .layout-option:hover { border-color: #007bff; background: #f8f9ff; }
        .layout-option input[type="radio"]:checked + div { color: #007bff; font-weight: bold; }
        .card-style-section { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; }
        .card-style-option { border: 2px solid #ddd; border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .card-style-option:hover { border-color: #007bff; background: #f8f9ff; }
        .card-style-option input[type="radio"]:checked + div { color: #007bff; font-weight: bold; }
        @media print {
            body { margin: 0; padding: 0; background: white; }
            .control-panel { display: none; }
            
            .page {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
                page-break-after: always;
                page-break-inside: avoid;
                position: relative;
                background: white;
                overflow: hidden;
            }
            
            .page:last-child { page-break-after: avoid; }
            
            .page-inner {
                position: absolute;
                top: 15mm;
                left: 15mm;
                right: 15mm;
                bottom: 15mm;
                display: flex;
                flex-direction: column;
                height: calc(297mm - 30mm);
                width: calc(210mm - 30mm);
            }
            
            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 3mm;
                margin-bottom: 3mm;
                border-bottom: 2px solid #1a1a1a;
                flex-shrink: 0;
                height: 12mm;
            }
            
            .header-left { display: flex; align-items: center; gap: 3mm; }
            .header-logo { height: 8mm; width: auto; }
            .header-title { font-size: 12pt; font-weight: 700; color: #1a1a1a; }
            .page-number { font-size: 10pt; color: #666; font-weight: 500; }
            
            .page-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
                margin-bottom: 5mm;
                overflow: hidden;
            }
            
            .category-header {
                background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 100%);
                color: white;
                padding: 4mm 6mm;
                margin: 0 -5mm 5mm -5mm;
                font-size: 14pt;
                font-weight: 800;
                letter-spacing: 1px;
                text-transform: uppercase;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                box-shadow: 0 1mm 3mm rgba(0,0,0,0.15);
                height: 12mm;
            }
            
            .category-header::before {
                content: '';
                width: 4mm;
                height: 4mm;
                background: #cc0000;
                margin-right: 4mm;
                display: block;
            }
            
            .category-header.excel-page {
                background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%) !important;
            }
            
            .category-header.excel-page::before {
                background: #ff9800 !important;
            }
            
            .products-container {
                flex: 1;
                min-height: 0;
                display: flex;
                align-items: flex-start;
                height: 100%;
            }
            
            .products-grid {
                display: grid;
                grid-template-columns: repeat(var(--grid-columns, 2), 1fr);
                grid-template-rows: repeat(var(--grid-rows, 4), 1fr);
                gap: var(--grid-gap, 4mm);
                width: 100%;
                height: 100%;
            }
            
            /* Grid Layout Definitions */
            .products-grid.compact { --grid-columns: 3; --grid-rows: 4; --grid-gap: 3mm; }
            .products-grid.dense { --grid-columns: 2; --grid-rows: 5; --grid-gap: 3mm; }
            .products-grid.ultra-compact { --grid-columns: 3; --grid-rows: 5; --grid-gap: 2.5mm; }
            .products-grid.high-density { --grid-columns: 4; --grid-rows: 5; --grid-gap: 2.5mm; }
            .products-grid.maximum { --grid-columns: 4; --grid-rows: 6; --grid-gap: 2mm; }
            
            /* Base Product Card */
            .product-card {
                background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
                display: flex;
                flex-direction: row;
                overflow: hidden;
                height: 100%;
                border-radius: 3mm;
                box-shadow: 0 1mm 3mm rgba(0,0,0,0.12), 0 0.5mm 2mm rgba(0,0,0,0.08);
                border: 0.5px solid rgba(0,0,0,0.08);
                position: relative;
                min-height: 40mm;
            }
            
            /* NEW: Overlay Style Cards */
            .product-card.overlay-minimal,
            .product-card.overlay-corners,
            .product-card.overlay-price-tag {
                flex-direction: column;
                padding: 0;
                background: white;
            }
            
            .product-card.overlay-minimal .product-image-container,
            .product-card.overlay-corners .product-image-container,
            .product-card.overlay-price-tag .product-image-container {
                position: relative;
                width: 100%;
                height: 100%;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 3mm;
            }
            
            /* Dynamic background for images */
            .product-image-container.bg-transparent {
                background: transparent !important;
            }
            
            .product-image-container.bg-subtle {
                background: white !important;
                box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
            }
            
            .product-card .product-image-container img {
                max-width: 100%;
                max-height: 100%;
                width: auto;
                height: auto;
                object-fit: contain;
                display: block;
            }
            
            /* Floating Badges with overflow control */
            .floating-badge {
                position: absolute;
                background: rgba(26, 26, 26, 0.95);
                color: white;
                padding: 1.5mm 3mm;
                border-radius: 10px;
                font-size: 6pt;
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                max-width: 70%;
                z-index: 10;
                backdrop-filter: blur(5px);
            }
            
            .floating-badge.name-badge {
                top: 2mm;
                left: 2mm;
                background: rgba(26, 26, 26, 0.9);
                font-size: 5.5pt;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .floating-badge.sku-badge {
                bottom: 2mm;
                left: 2mm;
                background: rgba(0, 107, 107, 0.95);
                font-size: 5pt;
                border-radius: 5px;
                padding: 1mm 2mm;
            }
            
            .floating-badge.price-badge {
                bottom: 2mm;
                right: 2mm;
                background: rgba(204, 0, 0, 0.95);
                font-size: 8pt;
                padding: 2mm 3mm;
                font-weight: 900;
                border-radius: 8px;
            }
            
            /* Price Tag Style Specific */
            .overlay-price-tag .price-badge {
                clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%);
                border-radius: 0;
                padding-right: 4mm;
            }
            
            /* Standard and image-bottom layouts remain unchanged */
            .product-card.image-bottom {
                flex-direction: column !important;
            }
            
            .product-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 0.5mm;
                background: linear-gradient(90deg, #006b6b 0%, #cc0000 50%, #006b6b 100%);
                opacity: 0.6;
            }
            
            /* Product Image for standard layouts */
            .product-image {
                width: 65%;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2mm;
                position: relative;
                border-right: 1px solid rgba(0,0,0,0.06);
                overflow: hidden;
                flex-shrink: 0;
            }
            
            /* Dynamic backgrounds for standard layout */
            .product-image.bg-transparent {
                background: transparent !important;
            }
            
            .product-image.bg-subtle {
                background: white !important;
                box-shadow: inset 0 0 20px rgba(0,0,0,0.03);
            }
            /* Image-bottom layout adjustments */
            .product-card.image-bottom .product-image {
                width: 100% !important;
                height: auto !important;
                flex: 1 1 auto !important;
                border-right: none !important;
                border-top: 1px solid rgba(0,0,0,0.06) !important;
                min-height: 25mm !important;
                padding: 1mm !important;
                background: white !important;
            }
            
            .product-image img {
                max-width: 100% !important;
                max-height: 100% !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain !important;
                filter: drop-shadow(0 2mm 4mm rgba(0,0,0,0.15)) drop-shadow(0 1mm 2mm rgba(0,0,0,0.1));
                border-radius: 1mm;
                position: relative;
                z-index: 2;
                display: block !important;
            }
            
            .no-image {
                text-align: center;
                color: #bbb;
                padding: 2mm;
                position: relative;
                z-index: 2;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            .no-image-icon { font-size: 28pt; margin-bottom: 2mm; opacity: 0.4; }
            .no-image-text { font-size: 6pt; text-transform: uppercase; letter-spacing: 0.8px; color: #999; font-weight: 700; }
            
            /* SKU Overlay for images */
            .sku-overlay {
                position: absolute;
                bottom: 1mm;
                right: 1mm;
                background: rgba(0, 107, 107, 0.9);
                color: white;
                padding: 1mm 2mm;
                font-size: 5pt;
                font-weight: 700;
                border-radius: 1mm;
                box-shadow: 0 1px 2px rgba(0,0,0,0.3);
                z-index: 3;
                line-height: 1;
                letter-spacing: 0.2px;
            }

            /* Make sure overlay works for both card styles */
            .product-card.image-bottom .sku-overlay,
            .product-card .sku-overlay {
                position: absolute;
                bottom: 1mm;
                right: 1mm;
            }

            /* For high-density layouts, make SKU slightly smaller */
            .products-grid.high-density .sku-overlay,
            .products-grid.maximum .sku-overlay {
                font-size: 4pt;
                padding: 0.8mm 1.5mm;
            }
            
            /* Adjustments for overlay styles in high-density */
            .products-grid.high-density .floating-badge {
                font-size: 5pt;
                padding: 1mm 2mm;
            }
            
            .products-grid.high-density .floating-badge.price-badge {
                font-size: 7pt;
            }
            
            .products-grid.high-density .floating-badge.name-badge {
                font-size: 4.5pt;
            }
            
            /* Product Details */
            .product-details {
                width: 35%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                height: 100%;
                flex-shrink: 0;
            }
            
            .product-card.image-bottom .product-details {
                width: 100% !important;
                flex: 0 0 auto !important;
                height: auto !important;
                min-height: auto !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .product-header {
                background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%);
                color: white;
                padding: 2mm;
                flex-shrink: 0;
                position: relative;
                box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                min-height: 15mm;
            }

            .product-card.image-bottom .product-header {
                min-height: 10mm !important;
                padding: 1.5mm !important;
            }

            .product-card.image-bottom .product-name {
                font-size: 6pt !important;
                -webkit-line-clamp: 2 !important;
                line-height: 1.1 !important;
            }
            
            .product-name {
                font-size: 7pt;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 0.2px;
                line-height: 1.2;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
                text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                color: #ffffff;
                text-align: center;
                margin: 0;
            }
            
            .product-specs {
                background: white;
                padding: 2mm;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                min-height: 0;
            }
            
            .product-card.image-bottom .product-specs {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 0 !important;
                justify-content: flex-start !important;
                flex: 0 0 auto !important;
                min-height: auto !important;
                padding: 1mm !important;
                background: #f8f9fa !important;
            }
            
            .spec-item {
                font-size: 6pt;
                color: #333;
                margin-bottom: 1mm;
                display: flex;
                align-items: baseline;
                line-height: 1.1;
                justify-content: center;
            }
            
            .product-card.image-bottom .spec-item {
                margin-bottom: 0 !important;
                flex: 0 0 auto !important;
                justify-content: flex-start !important;
                font-size: 5pt !important;
                line-height: 1.2 !important;
                padding: 0.5mm 0 !important;
            }
            
            .spec-item:last-child { margin-bottom: 0; }
            .spec-bullet { color: #006b6b; font-size: 7pt; margin-right: 1mm; line-height: 1; flex-shrink: 0; }
            .spec-label { font-weight: 700; color: #666; margin-right: 1mm; flex-shrink: 0; font-size: 6pt; }
            .spec-value { color: #1a1a1a; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; font-size: 6pt; }
            
            .price-badge {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
                padding: 3mm 2mm;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
                box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.2);
                position: relative;
                min-height: 18mm;
            }
            
            .product-card.image-bottom .price-badge {
                flex: 0 0 auto !important;
                min-height: 10mm !important;
                max-height: 10mm !important;
                padding: 1mm !important;
                margin: 0 !important;
            }

            .product-card.image-bottom .price-amount {
                font-size: 10pt !important;
                margin-bottom: 0.5mm !important;
            }

            .product-card.image-bottom .price-unit {
                font-size: 5pt !important;
            }
            
            .price-amount {
                font-size: 14pt;
                font-weight: 900;
                line-height: 1;
                letter-spacing: -0.3px;
                margin-bottom: 1mm;
                text-shadow: 0 1px 2px rgba(0,0,0,0.4), 0 0 4px rgba(255,255,255,0.1);
                color: #ffffff;
            }
            
            .price-currency { font-size: 10pt; font-weight: 800; color: #ffffff; }
            .price-cents { font-size: 8pt; vertical-align: super; font-weight: 800; margin-left: 0.3mm; color: #ffffff; }
            .price-unit { font-size: 6pt; text-transform: uppercase; letter-spacing: 0.8px; opacity: 0.95; font-weight: 700; color: rgba(255,255,255,0.95); }
            
            /* High-density layout adjustments - keep existing */
            .products-grid.high-density .product-card { min-height: 35mm; }
            .products-grid.high-density .product-image { width: 60%; }
            .products-grid.high-density .product-details { width: 40%; }
            .products-grid.high-density .product-header { min-height: 12mm; }
            .products-grid.high-density .product-name { font-size: 6pt; -webkit-line-clamp: 2; }
            .products-grid.high-density .spec-item { font-size: 5pt; }
            .products-grid.high-density .spec-label, .products-grid.high-density .spec-value { font-size: 5pt; }
            .products-grid.high-density .price-badge { min-height: 15mm; padding: 2mm; }
            .products-grid.high-density .price-amount { font-size: 11pt; }
            
            /* Footer and Page Styles */
            .page-footer {
                border-top: 1px solid #e0e0e0;
                padding-top: 3mm;
                font-size: 7pt;
                color: #666;
                line-height: 1.4;
                flex-shrink: 0;
                height: 20mm;
            }
            
            .disclaimer { margin-bottom: 2mm; text-align: justify; }
            .footer-info { display: flex; justify-content: space-between; align-items: center; font-size: 8pt; }
            .footer-left { font-weight: 600; color: #333; }
            .footer-right { text-align: right; }
            
            /* Hero page styles - keep existing */
            .hero-page .page-inner { display: flex; flex-direction: column; justify-content: flex-start; padding-top: 10mm; }
            .hero-content { text-align: center; flex: 1; }
            .hero-logo { height: 25mm; margin-bottom: 8mm; }
            .hero-title { font-size: 36pt; font-weight: 900; color: #cc0000; margin-bottom: 4mm; letter-spacing: -1.5px; }
            .hero-subtitle { font-size: 14pt; color: #444; margin-bottom: 8mm; font-weight: 300; letter-spacing: 0.5px; }
            
            .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4mm; margin: 5mm 0; }
            .info-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 4mm; border-radius: 3mm; text-align: center; box-shadow: 0 1mm 3mm rgba(0,0,0,0.05); }
            .info-label { font-size: 7pt; color: #666; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 1mm; font-weight: 600; }
            .info-value { font-size: 10pt; font-weight: 800; color: #1a1a1a; }
            .address-section { background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%); color: white; padding: 6mm; border-radius: 4mm; margin: 5mm 0; text-align: left; box-shadow: 0 2mm 5mm rgba(0,0,0,0.1); }
            .address-title { font-size: 14pt; font-weight: 800; margin-bottom: 3mm; letter-spacing: 0.5px; }
            .address-section div { line-height: 1.6; font-size: 10pt; }
            .collection-notice { background: linear-gradient(135deg, #fff8dc 0%, #ffedd5 100%); border-left: 4mm solid #ff6b35; padding: 4mm 6mm; margin: 3mm 0; font-size: 9pt; border-radius: 0 3mm 3mm 0; box-shadow: 0 1mm 3mm rgba(0,0,0,0.08); }
            .notice-title { font-weight: 800; margin-bottom: 2mm; color: #d84315; font-size: 10pt; }
        }
        @page { size: A4; margin: 0; }
        @media screen {
            .page { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; width: 210mm; min-height: 297mm; }
            .page-inner { padding: 15mm; }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="logo-header">
            <h1>OZZ Professional Catalog Generator</h1>
            <p>Create beautiful retail-quality promotional catalogs with images</p>
        </div>
        
        <div class="button-group">
            <button onclick="loadCatalog()" id="loadBtn">üìÅ Load JULY PROMO.xlsx</button>
            <button onclick="initializeImages()" id="imageBtn" disabled>üì∏ Initialize Images</button>
            <button onclick="generateCatalog()" id="generateBtn" disabled>üìÑ Generate Catalog</button>
            <button onclick="window.print()" id="printBtn" disabled>üñ®Ô∏è Print / Save PDF</button>
        </div>
        
        <!-- NEW: Export Section -->
        <div class="export-section" style="display: none;" id="exportSection">
            <h4>üì∏ Export Options</h4>
            <div class="export-controls">
                <button onclick="exportAllPages()" id="exportAllBtn">üì¶ Export All Pages</button>
                <button onclick="showPageSelector()" id="exportIndividualBtn">üìÑ Select Pages to Export</button>
                <select id="exportFormat">
                    <option value="png">PNG (Best Quality)</option>
                    <option value="jpg">JPG (Smaller Size)</option>
                </select>
                <select id="exportQuality">
                    <option value="3">High (300 DPI)</option>
                    <option value="2">Medium (200 DPI)</option>
                    <option value="4">Ultra (400 DPI)</option>
                </select>
            </div>
        </div>
        <div class="status-box" id="status">Ready to load catalog data...</div>
        <div class="image-status" id="imageStatus" style="display: none;">
            <div id="imageStatusText">üì∏ Image system not initialized</div>
            <div id="imageStats" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>

        <!-- Image Preview Section -->
        <div id="imagePreviewSection" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
            <h3 style="margin-bottom: 15px; color: #333;">üñºÔ∏è Product Image Preview</h3>
            <div style="display: flex; gap: 20px; align-items: flex-start;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                        Enter SKU to preview image:
                        <input type="text" id="skuInput" placeholder="e.g., 206, 1234" 
                               style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">
                    </label>
                    <button onclick="previewImage()" style="background: #007bff; color: white; margin-right: 10px;">
                        üîç Preview Image
                    </button>
                    <button onclick="refreshImageCache()" style="background: #28a745; color: white;">
                        üîÑ Refresh Image Cache
                    </button>
                </div>
                <div style="flex: 1; text-align: center;">
                    <div id="imagePreviewContainer" style="min-height: 200px; border: 2px dashed #ddd; border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center;">
                        <p style="color: #999;">Enter a SKU and click Preview to see the image</p>
                    </div>
                    <div id="imagePreviewInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
        </div>

        <div id="customizationPanel" class="category-section" style="display: none;">
          <h3>üé® Catalog Customization</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üé® Color Scheme</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        Header Color:
                        <input type="color" id="headerColor" value="#006b6b" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Price Color:
                        <input type="color" id="priceColor" value="#cc0000" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Accent Color:
                        <input type="color" id="accentColor" value="#1a1a1a" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <button onclick="applyColorScheme()" style="width: 100%; margin-top: 8px; background: #28a745; color: white;">Apply Colors</button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üìù Typography</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        Font Family:
                        <select id="fontFamily" style="width: 100%; padding: 4px; margin-top: 4px;">
                            <option value="system">System Default</option>
                            <option value="arial">Arial</option>
                            <option value="helvetica">Helvetica</option>
                            <option value="times">Times New Roman</option>
                            <option value="georgia">Georgia</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Text Style:
                        <select id="textStyle" style="width: 100%; padding: 4px; margin-top: 4px;">
                            <option value="uppercase" selected>UPPERCASE</option>
                            <option value="capitalize">Capitalize</option>
                            <option value="normal">Normal</option>
                        </select>
                    </label>
                    <button onclick="applyTypography()" style="width: 100%; margin-top: 8px; background: #007bff; color: white;">Apply Typography</button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üé≠ Preset Themes</h4>
                    <button onclick="applyTheme('ozz-classic')" style="width: 100%; margin-bottom: 8px; background: #006b6b; color: white;">OZZ Classic</button>
                    <button onclick="applyTheme('modern-blue')" style="width: 100%; margin-bottom: 8px; background: #0056b3; color: white;">Modern Blue</button>
                    <button onclick="applyTheme('elegant-black')" style="width: 100%; margin-bottom: 8px; background: #2c3e50; color: white;">Elegant Black</button>
                    <button onclick="resetToDefault()" style="width: 100%; background: #6c757d; color: white;">Reset to Default</button>
                </div>
            </div>
            
            <!-- NEW: Image Background Options -->
            <div class="image-bg-selector">
                <h5>üñºÔ∏è Product Image Background:</h5>
                <div class="bg-option">
                    <input type="radio" name="imageBg" value="white" id="bgWhite" checked>
                    <label for="bgWhite">Pure White</label>
                </div>
                <div class="bg-option">
                    <input type="radio" name="imageBg" value="transparent" id="bgTransparent">
                    <label for="bgTransparent">Transparent</label>
                </div>
                <div class="bg-option">
                    <input type="radio" name="imageBg" value="subtle" id="bgSubtle">
                    <label for="bgSubtle">Subtle Shadow</label>
                </div>
            </div>
        </div>

        <div id="introPageCustomization" class="category-section" style="display: none;">
            <h3>üìÑ Cover Page Content Customization</h3>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Customize the content that appears on the cover page of your catalog.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Page Title:
                            <input type="text" id="introTitle" value="Welcome to Our July 2025 Promotion" 
                                   style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Subtitle:
                            <input type="text" id="introSubtitle" value="Exclusive deals on premium home & kitchen products" 
                                   style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Special Message:
                            <textarea id="introMessage" rows="4" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">Thank you for choosing OZZ Cash & Carry for your home and kitchen needs. This July, we're offering exceptional deals on premium products to help you create the perfect living space.</textarea>
                        </label>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Promotion Details:
                            <textarea id="promoDetails" rows="3" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">‚Ä¢ Valid for July 2025 only
- Limited quantities available
- Collection only at our Durban store
- Delivery available at additional cost</textarea>
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Additional Information:
                            <textarea id="additionalInfo" rows="3" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">Store Hours:
Monday - Friday: 8:00 AM - 5:00 PM
Saturday: 8:00 AM - 1:00 PM
Sunday: Closed

Visit our showroom to see the full range!</textarea>
                        </label>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="previewCoverPage()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
                        üìã Preview Cover Page
                    </button>
                    <button onclick="resetCoverPage()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px;">
                        üîÑ Reset to Default
                    </button>
                </div>
            </div>
        </div>
        
        <div id="layoutOptions" class="category-section" style="display: none;">
            <h3>üìê Page Layout Options:</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                <label class="layout-option">
                    <input type="radio" name="layout" value="standard" checked>
                    <div><strong>Standard</strong><br><small>2√ó4 = 8 products/page</small></div>
                </label>
                <label class="layout-option">
                    <input type="radio" name="layout" value="compact">
                    <div><strong>Compact</strong><br><small>3√ó4 = 12 products/page</small></div>
                </label>
                <label class="layout-option">
                    <input type="radio" name="layout" value="dense">
                    <div><strong>Dense</strong><br><small>2√ó5 = 10 products/page</small></div>
                </label>
                <label class="layout-option">
                    <input type="radio" name="layout" value="ultra-compact">
                    <div><strong>Ultra Compact</strong><br><small>3√ó5 = 15 products/page</small></div>
                </label>
                <label class="layout-option">
                    <input type="radio" name="layout" value="high-density">
                    <div><strong>High Density</strong><br><small>4√ó5 = 20 products/page</small></div>
                </label>
                <label class="layout-option">
                    <input type="radio" name="layout" value="maximum">
                    <div><strong>Maximum</strong><br><small>4√ó6 = 24 products/page</small></div>
                </label>
            </div>

            <div class="card-style-section">
                <h4 style="margin-bottom: 15px; color: #333;">üÉè Product Card Style:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <label class="card-style-option">
                        <input type="radio" name="cardStyle" value="standard" checked>
                        <div><strong>Standard</strong><br><small>Image left, details right</small></div>
                    </label>
                    <label class="card-style-option">
                        <input type="radio" name="cardStyle" value="image-bottom">
                        <div><strong>Details Top</strong><br><small>Details top, image bottom</small></div>
                    </label>
                    <label class="card-style-option">
                        <input type="radio" name="cardStyle" value="overlay-minimal">
                        <div><strong>Minimal Corners</strong><br><small>Name top, SKU & price bottom</small></div>
                    </label>
                    <label class="card-style-option">
                        <input type="radio" name="cardStyle" value="overlay-price-tag">
                        <div><strong>Price Tag</strong><br><small>Price tag style badge</small></div>
                    </label>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    Choose how product information and images are arranged on each card
                </p>
            </div>
        </div>
        
        <div id="categorySection" class="category-section" style="display: none;">
            <h3>Select Categories to Include:</h3>
            <div id="categoryList" class="category-grid"></div>
        </div>
    </div>
    
    <div id="printContent" class="print-preview"></div>
    <script>
        let allProducts = [];
        let categories = [];
        let driveImageManager = null;
        
        class DriveImageManager {
            constructor() {
                this.imageCache = new Map();
                this.isInitialized = false;
                this.cacheVersion = '1.0';
                this.cacheExpiryHours = 1;
                this.folderId = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';
                this.apiKey = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
                this.progressCallback = null;
            }

            async initializeGAPI() {
                if (this.isInitialized) return true;
                try {
                    this.updateProgress('Loading Google APIs...');
                    await this.loadGoogleAPISafe();
                    this.updateProgress('Initializing Drive client...');
                    await this.initializeClient();
                    this.isInitialized = true;
                    console.log('‚úÖ Google Drive API initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Failed to initialize Google Drive API:', error);
                    this.updateProgress('‚ùå API Error: ' + error.message);
                    return false;
                }
            }

            async loadGoogleAPISafe() {
                if (window.gapi) return;
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.async = true;
                    script.defer = true;
                    script.addEventListener('load', resolve);
                    script.addEventListener('error', () => reject(new Error('Failed to load Google APIs')));
                    document.head.appendChild(script);
                });
            }

            async initializeClient() {
                return new Promise((resolve, reject) => {
                    const loadCallback = () => {
                        gapi.client.init({
                            apiKey: this.apiKey,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                        }).then(resolve).catch(reject);
                    };
                    gapi.load('client', { callback: loadCallback, onerror: () => reject(new Error('Failed to load GAPI client')) });
                });
            }

            updateProgress(message) {
                console.log('üìä ' + message);
                if (this.progressCallback) this.progressCallback(message);
            }

            setProgressCallback(callback) {
                this.progressCallback = callback;
            }

            getCacheKey(type) {
                return 'ozz_pdf_' + type + '_v' + this.cacheVersion;
            }

            loadCacheFromStorage() {
                try {
                    const cacheMetaKey = this.getCacheKey('meta');
                    const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                    if (!cacheMetaStr) return false;
                    
                    const cacheMeta = JSON.parse(cacheMetaStr);
                    const cacheAge = Date.now() - cacheMeta.timestamp;
                    const maxAge = this.cacheExpiryHours * 60 * 60 * 1000;
                    if (cacheAge > maxAge) {
                        this.clearCache();
                        return false;
                    }
                    
                    const imageCacheKey = this.getCacheKey('images');
                    const imageCacheStr = localStorage.getItem(imageCacheKey);
                    if (!imageCacheStr) return false;
                    
                    const imageData = JSON.parse(imageCacheStr);
                    this.imageCache = new Map(Object.entries(imageData));
                    console.log('‚úÖ Cache loaded: ' + this.imageCache.size + ' images');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error loading cache:', error);
                    this.clearCache();
                    return false;
                }
            }

            saveCacheToStorage() {
                try {
                    const cacheMeta = { timestamp: Date.now(), version: this.cacheVersion, totalImages: this.imageCache.size };
                    localStorage.setItem(this.getCacheKey('meta'), JSON.stringify(cacheMeta));
                    const imageData = Object.fromEntries(this.imageCache);
                    localStorage.setItem(this.getCacheKey('images'), JSON.stringify(imageData));
                    console.log('‚úÖ Cache saved: ' + this.imageCache.size + ' images');
                } catch (error) {
                    console.error('‚ùå Error saving cache:', error);
                }
            }

            clearCache() {
                const keys = ['meta', 'images'];
                for (let i = 0; i < keys.length; i++) {
                    localStorage.removeItem(this.getCacheKey(keys[i]));
                }
            }

            async scanFolderForImages(forceRefresh) {
                if (forceRefresh === undefined) forceRefresh = false;
                
                if (!forceRefresh && this.loadCacheFromStorage()) {
                    this.updateProgress('‚úÖ Using cached images');
                    return;
                }
                
                this.updateProgress('üîç Scanning Google Drive...');
                try {
                    const images = await this.fetchImagesFromFolder();
                    if (images.length === 0) {
                        this.updateProgress('‚ö†Ô∏è No images found');
                        return;
                    }
                    this.updateProgress('üì∏ Processing ' + images.length + ' images...');
                    this.buildImageMapping(images);
                    this.saveCacheToStorage();
                    this.updateProgress('‚úÖ Mapped ' + this.imageCache.size + ' images');
                } catch (error) {
                    console.error('‚ùå Error scanning folder:', error);
                    throw error;
                }
            }
        async fetchImagesFromFolder(pageToken, allFiles) {
                if (pageToken === undefined) pageToken = null;
                if (allFiles === undefined) allFiles = [];
                
                try {
                    const response = await gapi.client.drive.files.list({
                        q: "'" + this.folderId + "' in parents and (mimeType contains 'image/jpeg' or mimeType contains 'image/png' or mimeType contains 'image/gif')",
                        fields: 'nextPageToken, files(id, name, mimeType)',
                        pageSize: 100,
                        pageToken: pageToken
                    });
                    const files = response.result.files || [];
                    allFiles.push.apply(allFiles, files);
                    if (response.result.nextPageToken) {
                        return await this.fetchImagesFromFolder(response.result.nextPageToken, allFiles);
                    }
                    return allFiles;
                } catch (error) {
                    console.error('Error fetching files:', error);
                    return [];
                }
            }

            buildImageMapping(images) {
                this.imageCache.clear();
                var self = this;
                images.forEach(function(image) {
                    const codes = self.extractProductCodes(image.name);
                    codes.forEach(function(code) {
                        if (!self.imageCache.has(code)) {
                            self.imageCache.set(code, {
                                id: image.id,
                                name: image.name,
                                directLink: 'https://lh3.googleusercontent.com/d/' + image.id + '=w800-h800-c'
                            });
                        }
                    });
                });
                
                console.log('üîç Debug: Checking for product 206...');
                const product206Variations = ['206', '0206', 'product206', 'item206'];
                product206Variations.forEach(function(variation) {
                    if (self.imageCache.has(variation)) {
                        console.log('‚úÖ Found product 206 with key:', variation, self.imageCache.get(variation));
                    }
                });
                
                images.forEach(function(image) {
                    if (image.name.toLowerCase().includes('206')) {
                        console.log('üì∏ Image containing "206":', image.name, 'ID:', image.id);
                        console.log('  Extracted codes:', self.extractProductCodes(image.name));
                    }
                });
            }

            extractProductCodes(filename) {
                const codes = [];
                const nameWithoutExt = filename.replace(/\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/i, '');
                
                const numericCodes = nameWithoutExt.match(/\b\d{3,6}\b/g);
                if (numericCodes) codes.push.apply(codes, numericCodes);
                
                const alphanumericCodes = nameWithoutExt.match(/\b[A-Z0-9]{3,8}\b/gi);
                if (alphanumericCodes) {
                    var lowercaseCodes = alphanumericCodes.map(function(code) { return code.toLowerCase(); });
                    codes.push.apply(codes, lowercaseCodes);
                }
                
                const parts = nameWithoutExt.split(/[-_\s\.]+/);
                for (var i = 0; i < parts.length; i++) {
                    const cleanPart = parts[i].trim();
                    if (/^\d{3,6}$/.test(cleanPart) || /^[A-Z0-9]{3,8}$/i.test(cleanPart)) {
                        codes.push(cleanPart.toLowerCase());
                    }
                }
                
                codes.forEach(function(code) {
                    if (code === '206') {
                        codes.push('0206');
                    }
                });
                
                return codes.filter(function(value, index, self) {
                    return self.indexOf(value) === index;
                });
            }

            getProductImage(productCode) {
                const normalizedCode = productCode.toString().toLowerCase().trim();
                
                let imageData = this.imageCache.get(normalizedCode);
                if (imageData) {
                    console.log('‚úÖ Image found for', productCode, ':', imageData.name);
                    return { url: imageData.directLink, found: true };
                }
                
                if (normalizedCode === '206') {
                    const variations = ['0206', 'product206', 'item206', 'sku206'];
                    for (let i = 0; i < variations.length; i++) {
                        imageData = this.imageCache.get(variations[i]);
                        if (imageData) {
                            console.log('‚úÖ Image found for 206 using variation', variations[i], ':', imageData.name);
                            return { url: imageData.directLink, found: true };
                        }
                    }
                    console.log('‚ùå No image found for product 206 despite variations');
                }
                
                return { url: null, found: false };
            }

            getStats() {
                const cacheMetaKey = this.getCacheKey('meta');
                const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                let cacheInfo = null;
                if (cacheMetaStr) {
                    try {
                        const cacheMeta = JSON.parse(cacheMetaStr);
                        const cacheAge = Date.now() - cacheMeta.timestamp;
                        cacheInfo = {
                            age: Math.round(cacheAge / (60 * 1000)),
                            timestamp: new Date(cacheMeta.timestamp).toLocaleString()
                        };
                    } catch (error) {
                        console.warn('Could not parse cache metadata');
                    }
                }
                return { mappedProducts: this.imageCache.size, cacheInfo: cacheInfo };
            }
        }

        // NEW: Export Functions with error handling
        async function exportAllPages() {
            if (typeof html2canvas === 'undefined') {
                showNotification('Export library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            const format = document.getElementById('exportFormat').value;
            const scale = parseInt(document.getElementById('exportQuality').value);
            const pages = document.querySelectorAll('.page');
            
            if (pages.length === 0) {
                showNotification('Please generate catalog first', 'error');
                return;
            }
            
            showNotification(`Exporting ${pages.length} pages as ${format.toUpperCase()}...`, 'info');
            
            for (let i = 0; i < pages.length; i++) {
                await exportSinglePage(pages[i], i + 1, format, scale);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showNotification(`Successfully exported ${pages.length} pages!`, 'success');
        }

        async function exportSinglePage(pageElement, pageNum, format, scale) {
            if (typeof html2canvas === 'undefined') {
                showNotification('Export library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            try {
                const canvas = await html2canvas(pageElement, {
                    scale: scale,
                    backgroundColor: format === 'png' ? null : '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 15000
                });
                
                const link = document.createElement('a');
                link.download = `OZZ-catalog-page-${pageNum}.${format}`;
                link.href = canvas.toDataURL(`image/${format === 'png' ? 'png' : 'jpeg'}`, format === 'jpg' ? 0.95 : 1.0);
                link.click();
            } catch (error) {
                console.error('Error exporting page:', error);
                showNotification(`Error exporting page ${pageNum}`, 'error');
            }
        }

        function showPageSelector() {
            const pages = document.querySelectorAll('.page');
            if (pages.length === 0) {
                showNotification('Please generate catalog first', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'page-selector-modal';
            modal.innerHTML = `
                <div class="page-selector-content">
                    <h3>Select Pages to Export</h3>
                    <div style="margin: 15px 0;">
                        <button onclick="selectAllPages()" style="margin-right: 10px;">Select All</button>
                        <button onclick="selectNoPages()">Select None</button>
                    </div>
                    <div class="page-thumbnails" id="pageThumbnails"></div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="exportSelectedPages()" style="background: #28a745; color: white; margin-right: 10px;">
                            Export Selected
                        </button>
                        <button onclick="closePageSelector()" style="background: #6c757d; color: white;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const thumbnailsContainer = document.getElementById('pageThumbnails');
            pages.forEach((page, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'page-thumbnail';
                thumbnail.dataset.pageIndex = index;
                thumbnail.innerHTML = `
                    <input type="checkbox" id="page-${index}" checked>
                    <label for="page-${index}">Page ${index + 1}</label>
                `;
                thumbnailsContainer.appendChild(thumbnail);
            });
        }

        function selectAllPages() {
            document.querySelectorAll('.page-thumbnail input').forEach(cb => cb.checked = true);
        }

        function selectNoPages() {
            document.querySelectorAll('.page-thumbnail input').forEach(cb => cb.checked = false);
        }

        async function exportSelectedPages() {
            if (typeof html2canvas === 'undefined') {
                showNotification('Export library not loaded. Please refresh the page.', 'error');
                closePageSelector();
                return;
            }
            
            const format = document.getElementById('exportFormat').value;
            const scale = parseInt(document.getElementById('exportQuality').value);
            const pages = document.querySelectorAll('.page');
            const selected = [];
            
            document.querySelectorAll('.page-thumbnail input:checked').forEach(cb => {
                const index = parseInt(cb.id.replace('page-', ''));
                selected.push(index);
            });
            
            if (selected.length === 0) {
                showNotification('Please select at least one page', 'error');
                return;
            }
            
            closePageSelector();
            showNotification(`Exporting ${selected.length} pages...`, 'info');
            
            for (const index of selected) {
                await exportSinglePage(pages[index], index + 1, format, scale);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showNotification(`Successfully exported ${selected.length} pages!`, 'success');
        }

        function closePageSelector() {
            const modal = document.querySelector('.page-selector-modal');
            if (modal) modal.remove();
        }

        async function loadCatalog() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            
            loadBtn.disabled = true;
            status.innerHTML = '‚è≥ Loading Excel file with page organization...';
            
            try {
                const response = await fetch('./JULY PROMO.xlsx');
                if (!response.ok) {
                    throw new Error('Could not find JULY PROMO.xlsx in the same folder');
                }
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                const pageData = {};
                let currentPage = null;
                let pageProducts = [];
                
                rawData.forEach(function(row, index) {
                    if (!row || row.length === 0) return;
                    
                    const pageMatch = row.find(function(cell) {
                        return cell && String(cell).toUpperCase().includes('PAGE');
                    });
                    
                    if (pageMatch) {
                        if (currentPage && pageProducts.length > 0) {
                            pageData[currentPage] = pageProducts.slice();
                        }
                        
                        currentPage = String(pageMatch).toUpperCase();
                        pageProducts = [];
                    }
                    else if (row[1] && typeof row[1] === 'number' && row[2] && row[3]) {
                        const product = {
                            sku: String(row[1]).trim(),
                            description: String(row[2]).trim(),
                            price: parseFloat(row[3]) || 0,
                            category: String(row[4] || 'UNCATEGORIZED').trim().toUpperCase(),
                            pageNumber: currentPage ? parseInt(currentPage.replace('PAGE ', '')) : 1
                        };
                        
                        if (product.price > 0 && product.description) {
                            pageProducts.push(product);
                        }
                    }
                });
                
                if (currentPage && pageProducts.length > 0) {
                    pageData[currentPage] = pageProducts.slice();
                }
                
                allProducts = [];
                Object.keys(pageData).sort(function(a, b) {
                    const numA = parseInt(a.replace('PAGE ', ''));
                    const numB = parseInt(b.replace('PAGE ', ''));
                    return numA - numB;
                }).forEach(function(page) {
                    allProducts.push.apply(allProducts, pageData[page]);
                });
                
                window.pageOrganization = pageData;
                
                categories = allProducts.map(function(p) { return p.category; })
                    .filter(function(value, index, self) { return self.indexOf(value) === index; })
                    .sort();
                
                showCategories();
                showPagePreview();
                document.getElementById('customizationPanel').style.display = 'block';
                document.getElementById('introPageCustomization').style.display = 'block';
                document.getElementById('layoutOptions').style.display = 'block';
                document.getElementById('exportSection').style.display = 'block';
                
                document.getElementById('imageBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;
                
                const pageCount = Object.keys(pageData).length;
                status.innerHTML = '‚úÖ <strong>Loaded ' + allProducts.length + ' products organized in ' + pageCount + ' predefined pages</strong>';
                
            } catch (error) {
                status.innerHTML = '‚ùå <strong style="color: #dc3545;">Error: ' + error.message + '</strong>';
                console.error(error);
            } finally {
                loadBtn.disabled = false;
            }
        }

        async function initializeImages() {
            const imageBtn = document.getElementById('imageBtn');
            const imageStatus = document.getElementById('imageStatus');
            const imageStatusText = document.getElementById('imageStatusText');
            const imageStats = document.getElementById('imageStats');
            
            imageBtn.disabled = true;
            imageBtn.innerHTML = '‚è≥ Initializing...';
            imageStatus.style.display = 'block';
            imageStatus.className = 'image-status loading';
            imageStatusText.innerHTML = 'üîÑ Starting image system...';
            
            try {
                driveImageManager = new DriveImageManager();
                driveImageManager.setProgressCallback(function(message) {
                    imageStatusText.innerHTML = message;
                });
                
                const initSuccess = await Promise.race([
                    driveImageManager.initializeGAPI(),
                    new Promise(function(_, reject) {
                        setTimeout(function() { reject(new Error('API initialization timeout')); }, 20000);
                    })
                ]);
                
                if (!initSuccess) {
                    throw new Error('Failed to initialize Google Drive API');
                }
                
                imageStatusText.innerHTML = 'üì∏ Scanning for product images (this may take 30-60 seconds)...';
                
                await Promise.race([
                    driveImageManager.scanFolderForImages(),
                    new Promise(function(_, reject) {
                        setTimeout(function() { reject(new Error('Folder scan timeout - please try again')); }, 60000);
                    })
                ]);
                
                const stats = driveImageManager.getStats();
                imageStatus.className = 'image-status';
                imageStatusText.innerHTML = '‚úÖ Image system ready! Found ' + stats.mappedProducts + ' product images';
                
                if (stats.cacheInfo) {
                    imageStats.innerHTML = 'Cache: ' + stats.cacheInfo.age + ' minutes old ‚Ä¢ Last updated: ' + stats.cacheInfo.timestamp;
                } else {
                    imageStats.innerHTML = 'Images freshly loaded from Google Drive';
                }
                
                imageBtn.innerHTML = '‚úÖ Images Ready';
                showImageMappingPreview();
                document.getElementById('imagePreviewSection').style.display = 'block';
                showNotification('Found ' + stats.mappedProducts + ' product images!', 'success');
                
            } catch (error) {
                console.error('Image initialization failed:', error);
                imageStatus.className = 'image-status error';
                
                let errorMessage = '‚ùå Image system failed: ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Connection timeout - please check your internet and try again';
                } else if (error.message.includes('Access denied')) {
                    errorMessage += 'Access denied - check folder permissions';
                } else if (error.message.includes('Folder not found')) {
                    errorMessage += 'Folder not found - check folder ID';
                } else {
                    errorMessage += error.message;
                }
                
                imageStatusText.innerHTML = errorMessage;
                imageStats.innerHTML = 'Catalog will be generated without images. Check console for details.';
                imageBtn.innerHTML = '‚ùå Try Again';
                
            } finally {
                imageBtn.disabled = false;
            }
        }

        function previewImage() {
            const skuInput = document.getElementById('skuInput');
            const sku = skuInput.value.trim();
            
            if (!sku) {
                showNotification('Please enter a SKU', 'error');
                return;
            }
            
            if (!driveImageManager) {
                showNotification('Please initialize images first', 'error');
                return;
            }
            
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreviewInfo = document.getElementById('imagePreviewInfo');
            
            imagePreviewContainer.innerHTML = '<p style="color: #666;">üîÑ Loading image...</p>';
            imagePreviewInfo.innerHTML = '';
            
            const imageData = driveImageManager.getProductImage(sku);
            
            if (imageData.found) {
                imagePreviewContainer.innerHTML = '<img src="' + imageData.url + '" alt="SKU: ' + sku + '" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                
                const imageInfo = driveImageManager.imageCache.get(sku.toLowerCase());
                if (imageInfo) {
                    imagePreviewInfo.innerHTML = 
                        '<strong>‚úÖ Image Found</strong><br>' +
                        'File: ' + imageInfo.name + '<br>' +
                        'SKU: ' + sku;
                }
                
                showNotification('Image found for SKU: ' + sku, 'success');
            } else {
                imagePreviewContainer.innerHTML = 
                    '<div style="text-align: center; color: #999;">' +
                    '<div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>' +
                    '<p><strong>No image found for SKU: ' + sku + '</strong></p>' +
                    '<p style="font-size: 12px; margin-top: 10px;">Make sure the image filename contains this SKU</p>' +
                    '</div>';
                
                imagePreviewInfo.innerHTML = '<strong>‚ùå No image mapping found</strong>';
                
                const suggestions = findSimilarSKUs(sku);
                if (suggestions.length > 0) {
                    imagePreviewInfo.innerHTML += '<br><br>Similar SKUs with images:<br>' + 
                        suggestions.slice(0, 5).join(', ');
                }
                
                showNotification('No image found for SKU: ' + sku, 'error');
            }
        }

        function findSimilarSKUs(searchSKU) {
            if (!driveImageManager) return [];
            
            const searchLower = searchSKU.toLowerCase();
            const similar = [];
            
            driveImageManager.imageCache.forEach(function(value, key) {
                if (key.includes(searchLower) || searchLower.includes(key)) {
                    similar.push(key);
                }
            });
            
            return similar;
        }

        async function refreshImageCache() {
            if (!driveImageManager) {
                showNotification('Please initialize images first', 'error');
                return;
            }
            
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '‚è≥ Refreshing...';
            
            const imageStatusText = document.getElementById('imageStatusText');
            const originalStatus = imageStatusText.innerHTML;
            
            try {
                await driveImageManager.scanFolderForImages(true);
                
                const stats = driveImageManager.getStats();
                imageStatusText.innerHTML = '‚úÖ Image cache refreshed! Found ' + stats.mappedProducts + ' product images';
                
                showNotification('Image cache refreshed successfully!', 'success');
                
                document.getElementById('imagePreviewContainer').innerHTML = 
                    '<p style="color: #999;">Enter a SKU and click Preview to see the image</p>';
                document.getElementById('imagePreviewInfo').innerHTML = '';
                
                showImageMappingPreview();
                
            } catch (error) {
                console.error('Error refreshing cache:', error);
                showNotification('Failed to refresh image cache', 'error');
                imageStatusText.innerHTML = originalStatus;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const skuInput = document.getElementById('skuInput');
            if (skuInput) {
                skuInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        previewImage();
                    }
                });
            }
        });

        function showPagePreview() {
            const existingPreview = document.getElementById('pagePreviewSection');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            if (!window.pageOrganization) return;
            
            const pagePreviewSection = document.createElement('div');
            pagePreviewSection.id = 'pagePreviewSection';
            pagePreviewSection.className = 'category-section';
            pagePreviewSection.innerHTML = '<h3>üìÑ Excel Page Organization Preview</h3><div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;"><p style="margin-bottom: 15px; color: #666; font-size: 14px;">Your Excel file contains products organized in predefined pages. The catalog will be generated according to this arrangement.</p><div id="pagePreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;"></div><div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;"><label style="display: flex; align-items: center; margin-bottom: 10px;"><input type="checkbox" id="useExcelPages" checked style="margin-right: 8px;"><span style="font-weight: bold;">Use Excel page organization (Recommended)</span></label><p style="font-size: 12px; color: #666; margin: 0;">When checked, products will be arranged exactly as defined in your Excel file. When unchecked, products will be arranged by category as before.</p></div></div>';
            
            const layoutOptions = document.getElementById('layoutOptions');
            layoutOptions.parentNode.insertBefore(pagePreviewSection, layoutOptions.nextSibling);
            
            const pagePreviewGrid = document.getElementById('pagePreviewGrid');
            const sortedPages = Object.keys(window.pageOrganization).sort(function(a, b) {
                const numA = parseInt(a.replace('PAGE ', ''));
                const numB = parseInt(b.replace('PAGE ', ''));
                return numA - numB;
            });
            
            sortedPages.forEach(function(page) {
                const products = window.pageOrganization[page];
                const pageCard = document.createElement('div');
                pageCard.className = 'category-item';
                pageCard.style.cssText = 'border: 2px solid #ddd; border-radius: 8px; padding: 12px; background: white; flex-direction: column; align-items: flex-start;';
                
                const previewProducts = products.slice(0, 3).map(function(p) {
                    return '‚Ä¢ ' + p.description.substring(0, 25) + '...';
                }).join('<br>');
                
                const moreText = products.length > 3 ? '<br>‚Ä¢ ... and ' + (products.length - 3) + ' more' : '';
                
                pageCard.innerHTML = '<div style="font-weight: bold; color: #333; margin-bottom: 8px;">' + page + '</div><div style="font-size: 12px; color: #666; margin-bottom: 8px;">' + products.length + ' products</div><div style="font-size: 11px; color: #888; line-height: 1.3;">' + previewProducts + moreText + '</div>';
                
                pagePreviewGrid.appendChild(pageCard);
            });
        }

        function showImageMappingPreview() {
            if (!driveImageManager) return;
            
            let mappedCount = 0;
            let unmappedProducts = [];
            
            allProducts.forEach(function(product) {
                const imageData = driveImageManager.getProductImage(product.sku);
                if (imageData.found) {
                    mappedCount++;
                } else {
                    unmappedProducts.push(product.sku);
                }
            });
            
            const imageStats = document.getElementById('imageStats');
            const unmappedPreview = unmappedProducts.slice(0, 10).join(', ');
            const moreUnmapped = unmappedProducts.length > 10 ? ' and ' + (unmappedProducts.length - 10) + ' more...' : '';
            const unmappedSection = unmappedProducts.length > 0 ? '<details style="margin-top: 5px;"><summary style="cursor: pointer;">View unmapped SKUs</summary><div style="font-family: monospace; font-size: 12px; margin-top: 5px;">' + unmappedPreview + moreUnmapped + '</div></details>' : '';
            
            const mappingInfo = '<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;"><strong>Image Mapping Results:</strong><br>‚Ä¢ ' + mappedCount + ' products with images<br>‚Ä¢ ' + unmappedProducts.length + ' products without images<br>' + unmappedSection + '</div>';
            
            imageStats.innerHTML += mappingInfo;
        }

        function getImageUrl(sku) {
            if (!driveImageManager) {
                return null;
            }
            const imageData = driveImageManager.getProductImage(sku);
            return imageData.found ? imageData.url : null;
        }

        function getImageBackground() {
            const selectedBg = document.querySelector('input[name="imageBg"]:checked');
            if (!selectedBg) return '';
            
            switch(selectedBg.value) {
                case 'transparent': return 'bg-transparent';
                case 'subtle': return 'bg-subtle';
                case 'white': 
                default: return '';
            }
        }

        function getLayoutConfig(layout) {
            const configs = {
                'standard': { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 },
                'compact': { productsPerPage: 12, gridClass: 'compact', columns: 3, rows: 4 },
                'dense': { productsPerPage: 10, gridClass: 'dense', columns: 2, rows: 5 },
                'ultra-compact': { productsPerPage: 15, gridClass: 'ultra-compact', columns: 3, rows: 5 },
                'high-density': { productsPerPage: 20, gridClass: 'high-density', columns: 4, rows: 5 },
                'maximum': { productsPerPage: 24, gridClass: 'maximum', columns: 4, rows: 6 }
            };
            return configs[layout] || configs['standard'];
        }

        function showCategories() {
            const section = document.getElementById('categorySection');
            const list = document.getElementById('categoryList');
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            const explanationDiv = document.createElement('div');
            explanationDiv.innerHTML = '<p style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 14px;"><strong>Category Filtering:</strong> When "Use Excel page organization" is enabled above, these categories will filter products within each Excel page. When disabled, products will be grouped by these categories instead.</p>';
            list.appendChild(explanationDiv);
            
            const categoryGrid = document.createElement('div');
            categoryGrid.className = 'category-grid';
            
            categories.forEach(function(cat) {
                const count = allProducts.filter(function(p) { return p.category === cat; }).length;
                const item = document.createElement('label');
                item.className = 'category-item';
                item.innerHTML = '<input type="checkbox" checked value="' + cat + '" class="category-cb"><span>' + cat + '</span><span class="category-count">' + count + ' items</span>';
                categoryGrid.appendChild(item);
            });
            
            list.appendChild(categoryGrid);
            
            const buttonDiv = document.createElement('div');
            buttonDiv.style.cssText = 'margin-top: 15px; text-align: center;';
            buttonDiv.innerHTML = '<button onclick="selectAllCategories()" style="background: #28a745; color: white; margin-right: 10px;">Select All</button><button onclick="selectNoCategories()" style="background: #dc3545; color: white;">Select None</button>';
            list.appendChild(buttonDiv);
        }

        function selectAllCategories() {
            const checkboxes = document.querySelectorAll('.category-cb');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = true;
            }
            showNotification('All categories selected', 'success');
        }

        function selectNoCategories() {
            const checkboxes = document.querySelectorAll('.category-cb');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = false;
            }
            showNotification('All categories deselected', 'info');
        }

        function generateCatalog() {
            const useExcelPages = document.getElementById('useExcelPages');
            const selectedLayout = document.querySelector('input[name="layout"]:checked').value;
            const selectedCardStyle = document.querySelector('input[name="cardStyle"]:checked').value;
            const layoutConfig = getLayoutConfig(selectedLayout);
            
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = '';
            
            printContent.appendChild(createHeaderPage());
            let pageNum = 2;
            
            if (useExcelPages && useExcelPages.checked && window.pageOrganization) {
                const sortedPages = Object.keys(window.pageOrganization).sort(function(a, b) {
                    const numA = parseInt(a.replace('PAGE ', ''));
                    const numB = parseInt(b.replace('PAGE ', ''));
                    return numA - numB;
                });
                
                let filteredProducts = [];
                
                sortedPages.forEach(function(pageKey) {
                    const pageProducts = window.pageOrganization[pageKey];
                    
                    const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked')).map(function(cb) {
                        return cb.value;
                    });
                    const productsToShow = selectedCats.length > 0 
                        ? pageProducts.filter(function(p) { return selectedCats.includes(p.category); })
                        : pageProducts;
                    
                    if (productsToShow.length > 0) {
                        for (let i = 0; i < productsToShow.length; i += layoutConfig.productsPerPage) {
                            const pageProductSlice = productsToShow.slice(i, i + layoutConfig.productsPerPage);
                            
                            const excelPageNum = parseInt(pageKey.replace('PAGE ', ''));
                            printContent.appendChild(createProductPage(
                                pageProductSlice, 
                                'Excel ' + pageKey, 
                                i === 0,
                                pageNum++, 
                                layoutConfig,
                                selectedCardStyle
                            ));
                        }
                        
                        filteredProducts.push.apply(filteredProducts, productsToShow);
                    }
                });
                
                const totalPages = printContent.querySelectorAll('.page').length;
                const totalPagesElements = printContent.querySelectorAll('.total-pages');
                for (let i = 0; i < totalPagesElements.length; i++) {
                    totalPagesElements[i].textContent = totalPages;
                }
                
                document.getElementById('printBtn').disabled = false;
                
                let imageInfo = '';
                if (driveImageManager) {
                    const stats = driveImageManager.getStats();
                    let mappedCount = 0;
                    filteredProducts.forEach(function(product) {
                        const imageData = driveImageManager.getProductImage(product.sku);
                        if (imageData.found) mappedCount++;
                    });
                    imageInfo = ' (' + mappedCount + ' with images)';
                }
                
                document.getElementById('status').innerHTML = 
                    '‚úÖ <strong>Generated ' + totalPages + ' pages with ' + filteredProducts.length + ' products using Excel page organization and ' + selectedLayout + ' layout (' + selectedCardStyle + ' cards)</strong>';
                    
            } else {
                const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked')).map(function(cb) {
                    return cb.value;
                });
                
                if (selectedCats.length === 0) {
                    alert('Please select at least one category or enable Excel page organization');
                    return;
                }
                
                const filteredProducts = allProducts.filter(function(p) {
                    return selectedCats.includes(p.category);
                });
                filteredProducts.sort(function(a, b) {
                    if (a.category !== b.category) {
                        return a.category.localeCompare(b.category);
                    }
                    return a.description.localeCompare(b.description);
                });
                
                const grouped = {};
                filteredProducts.forEach(function(p) {
                    if (!grouped[p.category]) grouped[p.category] = [];
                    grouped[p.category].push(p);
                });
                
                Object.entries(grouped).forEach(function(entry) {
                    const category = entry[0];
                    const products = entry[1];
                    for (let i = 0; i < products.length; i += layoutConfig.productsPerPage) {
                        const pageProducts = products.slice(i, i + layoutConfig.productsPerPage);
                        const showCategoryHeader = i === 0;
                        printContent.appendChild(createProductPage(pageProducts, category, showCategoryHeader, pageNum++, layoutConfig, selectedCardStyle));
                    }
                });
                
                const totalPages = printContent.querySelectorAll('.page').length;
                const totalPagesElements = printContent.querySelectorAll('.total-pages');
                for (let i = 0; i < totalPagesElements.length; i++) {
                    totalPagesElements[i].textContent = totalPages;
                }
                
                document.getElementById('printBtn').disabled = false;
                
                let imageInfo = '';
                if (driveImageManager) {
                    const stats = driveImageManager.getStats();
                    let mappedCount = 0;
                    filteredProducts.forEach(function(product) {
                        const imageData = driveImageManager.getProductImage(product.sku);
                        if (imageData.found) mappedCount++;
                    });
                    imageInfo = ' (' + mappedCount + ' with images)';
                }
                
                document.getElementById('status').innerHTML = 
                    '‚úÖ <strong>Generated ' + totalPages + ' pages with ' + filteredProducts.length + ' products' + imageInfo + ' using ' + selectedLayout + ' layout (' + selectedCardStyle + ' cards) (category mode)</strong>';
            }
            
            printContent.scrollIntoView({ behavior: 'smooth' });
        }
        
        function createHeaderPage() {
            const page = document.createElement('div');
            page.className = 'page hero-page';
            
            const title = document.getElementById('introTitle').value || 'Welcome to Our July 2025 Promotion';
            const subtitle = document.getElementById('introSubtitle').value || 'Exclusive deals on premium home & kitchen products';
            const message = document.getElementById('introMessage').value || 'Thank you for choosing OZZ Cash & Carry for your home and kitchen needs.';
            const promoDetails = document.getElementById('promoDetails').value || '‚Ä¢ Valid for July 2025 only\n‚Ä¢ Limited quantities available';
            const additionalInfo = document.getElementById('additionalInfo').value || 'Store Hours:\nMonday - Friday: 8:00 AM - 5:00 PM';
            
            page.innerHTML = '<div class="page-inner"><div class="hero-content"><img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" alt="OZZ Cash & Carry" class="hero-logo" onerror="this.style.display=\'none\'"><h1 class="hero-title">JULY 2025 PROMO</h1><p class="hero-subtitle">' + subtitle + '</p><div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 6mm; border-radius: 4mm; margin: 5mm 0; border-left: 4mm solid #006b6b;"><p style="font-size: 10pt; line-height: 1.5; color: #333; text-align: center; margin: 0;">' + message.replace(/\n/g, '<br>') + '</p></div><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4mm; margin: 5mm 0;"><div style="background: linear-gradient(135deg, #fff8dc 0%, #ffedd5 100%); padding: 4mm; border-radius: 3mm; border-left: 3mm solid #ff6b35;"><h3 style="font-size: 12pt; font-weight: 800; color: #d84315; margin-bottom: 2mm;">üéØ Promotion Details</h3><div style="font-size: 9pt; line-height: 1.4; color: #333;">' + promoDetails.replace(/\n/g, '<br>') + '</div></div><div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 4mm; border-radius: 3mm; border-left: 3mm solid #28a745;"><h3 style="font-size: 12pt; font-weight: 800; color: #155724; margin-bottom: 2mm;">‚ÑπÔ∏è Store Information</h3><div style="font-size: 9pt; line-height: 1.4; color: #333;">' + additionalInfo.replace(/\n/g, '<br>') + '</div></div></div><div class="info-grid" style="grid-template-columns: repeat(2, 1fr); gap: 3mm; margin: 5mm 0;"><div class="info-card"><div class="info-label">Phone</div><div class="info-value">+27 31 332 7192</div></div><div class="info-card"><div class="info-label">Email</div><div class="info-value">queries@ozzsa.com</div></div></div><div class="address-section" style="padding: 6mm; margin: 5mm 0;"><div class="address-title">OZZ CASH & CARRY</div><div>40 Mazeppa & Gull Street</div><div>Durban, KwaZulu-Natal 4001</div><div>South Africa</div><div style="margin-top: 2mm;"><strong>Hours:</strong> Mon-Fri: 8AM-5PM | Sat: 8AM-1PM</div></div><div class="collection-notice" style="padding: 4mm 6mm; margin: 3mm 0;"><div class="notice-title">üìç COLLECTION & DELIVERY</div><div>Promotional prices are valid for collection only at 40 Mazeppa Street, Durban.</div><div>Delivery is available at an additional charge.</div></div></div><div class="page-footer"><div class="disclaimer">While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. Ozz Cash and Carry reserves the right to limit quantities. All items include VAT where applicable. Images are for illustrative purposes only.</div><div class="footer-info"><span class="footer-left">OZZ Cash & Carry ‚Ä¢ July 2025 Catalog</span><span class="footer-right">Page 1 of <span class="total-pages">-</span> ‚Ä¢ Version 3.0</span></div><div style="text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px solid #e0e0e0; font-size: 6pt; color: #999; opacity: 0.8;">Designed and managed by Black Orchid Consulting</div></div></div>';
            
            return page;
        }

        function createProductPage(products, category, showHeader, pageNum, layoutConfig, cardStyle) {
            if (!layoutConfig) layoutConfig = { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 };
            if (!cardStyle) cardStyle = 'standard';
            
            const page = document.createElement('div');
            page.className = 'page';
            
            const isExcelPage = category.startsWith('Excel PAGE');
            const headerClass = isExcelPage ? 'category-header excel-page' : 'category-header';
            
            let contentHTML = '<div class="page-inner"><div class="page-header"><div class="header-left"><img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" alt="OZZ" class="header-logo" onerror="this.style.display=\'none\'"><span class="header-title">July 2025 Promotional Catalog</span></div><span class="page-number">Page ' + pageNum + ' of <span class="total-pages">-</span></span></div><div class="page-content">';
            
            if (showHeader) {
                const headerText = isExcelPage ? category.replace('Excel ', '') : category;
                contentHTML += '<div class="' + headerClass + '">' + headerText + '</div>';
            }
            
            contentHTML += '<div class="products-container"><div class="products-grid ' + layoutConfig.gridClass + '">';
            
            for (let i = 0; i < layoutConfig.productsPerPage; i++) {
                if (i < products.length) {
                    contentHTML += createProductCard(products[i], cardStyle);
                } else {
                    contentHTML += '<div class="product-card" style="visibility: hidden;"></div>';
                }
            }
            
            contentHTML += '</div></div></div><div class="page-footer"><div class="disclaimer">While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. All items include VAT where applicable. Images are for illustrative purposes only.</div><div class="footer-info"><span class="footer-left">OZZ Cash & Carry ‚Ä¢ +27 31 332 7192 ‚Ä¢ queries@ozzsa.com</span><span class="footer-right">Version 3.0</span></div><div style="text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px solid #e0e0e0; font-size: 6pt; color: #999; opacity: 0.8;">Designed and managed by Black Orchid Consulting</div></div></div>';
            
            page.innerHTML = contentHTML;
            return page;
        }

        function createProductCard(product, cardStyle) {
            if (!cardStyle) cardStyle = 'standard';
            
            const imageUrl = getImageUrl(product.sku);
            const bgClass = getImageBackground();
            
            const priceStr = product.price.toFixed(2);
            const priceParts = priceStr.split('.');
            const rands = priceParts[0];
            const cents = priceParts[1];
            
            const productName = product.description.trim();
            
            console.log('Creating card for SKU:', product.sku, 'Image URL:', imageUrl, 'Card Style:', cardStyle);
            
            // NEW: Overlay card styles with background class
            if (cardStyle === 'overlay-minimal' || cardStyle === 'overlay-price-tag') {
                const priceTagClass = cardStyle === 'overlay-price-tag' ? ' overlay-price-tag' : '';
                return '<div class="product-card overlay-minimal' + priceTagClass + '">' +
                    '<div class="product-image-container ' + bgClass + '">' + 
                        (imageUrl ? 
                            '<img src="' + imageUrl + '" alt="' + productName + '">' :
                            '<div class="no-image"><div class="no-image-icon">üì¶</div><div class="no-image-text">SKU: ' + product.sku + '</div></div>'
                        ) +
                        '<div class="floating-badge name-badge">' + productName + '</div>' +
                        '<div class="floating-badge sku-badge">SKU: ' + product.sku + '</div>' +
                        '<div class="floating-badge price-badge">R' + priceStr + '</div>' +
                    '</div>' +
                '</div>';
            }
            
            // Keep existing card styles with background class
            if (cardStyle === 'image-bottom') {
                return '<div class="product-card image-bottom">' +
                    '<div class="product-details">' +
                        '<div class="product-header">' +
                            '<div class="product-name">' + productName + '</div>' +
                        '</div>' +
                        '<div class="product-specs">' +
                            '<div class="spec-item">' +
                                '<span class="spec-bullet">‚Ä¢</span>' +
                                '<span class="spec-label">SKU:</span>' +
                                '<span class="spec-value">' + product.sku + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="price-badge">' +
                            '<div class="price-amount">' +
                                '<span class="price-currency">R</span>' + rands + 
                                '<span class="price-cents">' + cents + '</span>' +
                            '</div>' +
                            '<div class="price-unit">Each</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="product-image ' + bgClass + '">' + 
                        (imageUrl ? 
                            '<img src="' + imageUrl + '" alt="' + productName + '"><div class="sku-overlay">' + product.sku + '</div>' :
                            '<div class="no-image"><div class="no-image-icon">üì¶</div><div class="no-image-text">SKU: ' + product.sku + '</div></div>'
                        ) + 
                    '</div>' +
                '</div>';
            } else {
                // Standard layout with background class
                return '<div class="product-card">' +
                    '<div class="product-image ' + bgClass + '">' + 
                        (imageUrl ? 
                            '<img src="' + imageUrl + '" alt="' + productName + '"><div class="sku-overlay">' + product.sku + '</div>' :
                            '<div class="no-image"><div class="no-image-icon">üì¶</div><div class="no-image-text">SKU: ' + product.sku + '</div></div>'
                        ) + 
                    '</div>' +
                    '<div class="product-details">' +
                        '<div class="product-header">' +
                            '<div class="product-name">' + productName + '</div>' +
                        '</div>' +
                        '<div class="product-specs">' +
                            '<div class="spec-item">' +
                                '<span class="spec-bullet">‚Ä¢</span>' +
                                '<span class="spec-label">SKU:</span>' +
                                '<span class="spec-value">' + product.sku + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="price-badge">' +
                            '<div class="price-amount">' +
                                '<span class="price-currency">R</span>' + rands + 
                                '<span class="price-cents">' + cents + '</span>' +
                            '</div>' +
                            '<div class="price-unit">Each</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }
        }

        function previewCoverPage() {
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = '';
            printContent.appendChild(createHeaderPage());
            printContent.scrollIntoView({ behavior: 'smooth' });
            showNotification('Cover page preview generated!', 'info');
        }

        function resetCoverPage() {
            document.getElementById('introTitle').value = 'Welcome to Our July 2025 Promotion';
            document.getElementById('introSubtitle').value = 'Exclusive deals on premium home & kitchen products';
            document.getElementById('introMessage').value = 'Thank you for choosing OZZ Cash & Carry for your home and kitchen needs. This July, we\'re offering exceptional deals on premium products to help you create the perfect living space.';
            document.getElementById('promoDetails').value = '‚Ä¢ Valid for July 2025 only\n‚Ä¢ Limited quantities available\n‚Ä¢ Collection only at our Durban store\n‚Ä¢ Delivery available at additional cost';
            document.getElementById('additionalInfo').value = 'Store Hours:\nMonday - Friday: 8:00 AM - 5:00 PM\nSaturday: 8:00 AM - 1:00 PM\nSunday: Closed\n\nVisit our showroom to see the full range!';
            showNotification('Cover page reset to default!', 'info');
        }

        function applyColorScheme() {
            const headerColor = document.getElementById('headerColor').value;
            const priceColor = document.getElementById('priceColor').value;
            const accentColor = document.getElementById('accentColor').value;
            
            const styleId = 'dynamic-colors';
            let styleEl = document.getElementById(styleId);
            
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }
            
            styleEl.textContent = '.product-header { background: linear-gradient(135deg, ' + headerColor + ' 0%, ' + adjustBrightness(headerColor, -20) + ' 100%) !important; } .price-badge { background: linear-gradient(135deg, ' + priceColor + ' 0%, ' + adjustBrightness(priceColor, -20) + ' 100%) !important; } .floating-badge.price-badge { background: ' + priceColor + ' !important; } .category-header { background: linear-gradient(90deg, ' + accentColor + ' 0%, ' + adjustBrightness(accentColor, 20) + ' 100%) !important; } .spec-bullet { color: ' + headerColor + ' !important; } .floating-badge.sku-badge { background: ' + headerColor + ' !important; }';
            
            showNotification('Color scheme applied!', 'success');
        }

        function applyTypography() {
            const fontFamily = document.getElementById('fontFamily').value;
            const textStyle = document.getElementById('textStyle').value;
            
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif',
                'arial': 'Arial, sans-serif',
                'helvetica': 'Helvetica, Arial, sans-serif',
                'times': '"Times New Roman", Times, serif',
                'georgia': 'Georgia, serif'
            };
            
            const styleId = 'dynamic-typography';
            let styleEl = document.getElementById(styleId);
            
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }
            
            styleEl.textContent = '.product-name, .floating-badge.name-badge { font-family: ' + fontMap[fontFamily] + ' !important; text-transform: ' + textStyle + ' !important; }';
            
            showNotification('Typography applied!', 'success');
        }

        function applyTheme(themeName) {
            const themes = {
                'ozz-classic': { header: '#006b6b', price: '#cc0000', accent: '#1a1a1a', font: 'system', transform: 'uppercase' },
                'modern-blue': { header: '#0056b3', price: '#dc3545', accent: '#495057', font: 'helvetica', transform: 'uppercase' },
                'elegant-black': { header: '#2c3e50', price: '#e74c3c', accent: '#34495e', font: 'georgia', transform: 'capitalize' }
            };
            
            const theme = themes[themeName];
            if (!theme) return;
            
            document.getElementById('headerColor').value = theme.header;
            document.getElementById('priceColor').value = theme.price;
            document.getElementById('accentColor').value = theme.accent;
            document.getElementById('fontFamily').value = theme.font;
            document.getElementById('textStyle').value = theme.transform;
            
            applyColorScheme();
            applyTypography();
            
            showNotification(themeName.replace('-', ' ') + ' theme applied!', 'success');
        }

        function resetToDefault() {
            document.getElementById('headerColor').value = '#006b6b';
            document.getElementById('priceColor').value = '#cc0000';
            document.getElementById('accentColor').value = '#1a1a1a';
            document.getElementById('fontFamily').value = 'system';
            document.getElementById('textStyle').value = 'uppercase';
            
            const dynamicStyles = ['dynamic-colors', 'dynamic-typography'];
            for (let i = 0; i < dynamicStyles.length; i++) {
                const el = document.getElementById(dynamicStyles[i]);
                if (el) el.remove();
            }
            
            showNotification('Reset to default styling!', 'info');
        }

        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function showNotification(message, type) {
            if (!type) type = 'info';
            
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: ' + (type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8') + '; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-size: 14px; font-weight: 500; opacity: 0; transform: translateX(100%); transition: all 0.3s ease;';
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(function() {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        console.log('üéâ OZZ Professional Catalog Generator v4.0 Loaded');
        console.log('‚ú® NEW: Export to PNG/JPG functionality');
        console.log('‚ú® NEW: Individual page selection for export');
        console.log('‚ú® NEW: Overlay card styles (Minimal Corners & Price Tag)');
        console.log('‚ú® NEW: Image background options (White/Transparent/Subtle)');
        console.log('‚ú® FIXED: html2canvas error handling');
        console.log('‚ú® FIXED: Background class implementation');
        console.log('‚ú® FIXED: Floating badge text overflow');
        console.log('üì∏ Image integration: CSP-compliant Google Drive API');
        console.log('üìÑ Excel page organization support');
        console.log('üé® Customization: Colors, fonts, themes, and layouts');
        console.log('üñºÔ∏è Image preview functionality with refresh');
    </script>
</body>
</html>
