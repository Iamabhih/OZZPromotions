<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÑ OZZ PDF Catalog Generator - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .print-page { 
                page-break-after: always; 
                min-height: calc(100vh - 3cm);
                position: relative;
                padding-bottom: 60px;
            }
            .print-page:last-child { page-break-after: avoid; }
            .product-grid-print { display: grid; gap: 0.75rem; }
            .product-card-print { 
                border: 1px solid #e5e7eb; 
                padding: 0.75rem; 
                margin-bottom: 0.5rem; 
                break-inside: avoid;
                background: #ffffff;
                border-radius: 0.375rem;
            }
            .product-image-print { width: 100%; height: 120px; object-fit: contain; }
            .page-footer {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50px;
                border-top: 1px solid #ddd;
                background: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 1rem;
                font-size: 10px;
                color: #666;
            }
            .footer-logo { height: 24px; }
            .grid-compact { grid-template-columns: repeat(6, 1fr); }
            .grid-normal { grid-template-columns: repeat(4, 1fr); }
            .grid-list { grid-template-columns: 1fr; }
            .category-header {
                background: #f3f4f6;
                padding: 0.75rem 1rem;
                margin: 1rem 0 0.5rem 0;
                border-left: 4px solid #ef4444;
                font-weight: bold;
                font-size: 1.125rem;
                color: #1f2937;
                break-after: avoid;
            }
            .product-sku {
                color: #9ca3af !important;
                font-size: 0.75rem !important;
                font-weight: normal !important;
            }
            .product-description {
                color: #111827 !important;
                font-weight: 600 !important;
                font-size: 0.875rem !important;
                line-height: 1.3 !important;
                margin-bottom: 0.5rem !important;
            }
            .product-price {
                color: #dc2626 !important;
                font-weight: 700 !important;
                font-size: 1.125rem !important;
            }
            /* Prevent orphan products */
            .product-card-print:nth-last-child(-n+2) {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            /* Ensure category headers stay with their first few products */
            .category-section {
                break-inside: avoid;
            }
        }
        @page {
            size: A4;
            margin: 1.5cm 1cm 1cm 1cm;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Control Panel -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6 no-print">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">üìÑ PDF Catalog Generator</h1>
                <p class="text-gray-600">Generate a printable PDF version of your promotional catalog</p>
            </div>

            <!-- Options -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">üìÑ Layout Options</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="radio" name="layout" value="grid" checked class="mr-3">
                            <span>Grid Layout (4 per row)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="layout" value="list" class="mr-3">
                            <span>List Layout (detailed)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="layout" value="compact" class="mr-3">
                            <span>Compact (6 per row)</span>
                        </label>
                    </div>
                </div>

                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Display Options</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="includeImages" checked class="mr-3">
                            <span>Include product images</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="includePrices" checked class="mr-3">
                            <span>Include prices</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="groupByCategory" checked class="mr-3">
                            <span>Group by category</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="bg-gray-50 p-6 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-4">üè∑Ô∏è Category Filter</h3>
                <div class="mb-3">
                    <button onclick="selectAllCategories()" class="text-sm text-blue-600 hover:text-blue-800 mr-4">Select All</button>
                    <button onclick="deselectAllCategories()" class="text-sm text-blue-600 hover:text-blue-800">Deselect All</button>
                </div>
                <div id="categoryFilters" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Category checkboxes will be populated here -->
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="loadCatalog()" id="loadBtn" 
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    üìä Load Catalog Data
                </button>
                <button onclick="generatePDF()" id="generateBtn" disabled
                        class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold disabled:opacity-50">
                    üìÑ Generate PDF Preview
                </button>
                <button onclick="window.print()" id="printBtn" disabled
                        class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold disabled:opacity-50">
                    üñ®Ô∏è Print / Save as PDF
                </button>
            </div>

            <!-- Status -->
            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <span class="text-blue-900 font-semibold">Status:</span>
                    <span id="status" class="text-blue-700">Ready to load catalog</span>
                </div>
                <div class="mt-2">
                    <div class="text-sm text-blue-600" id="productCount">0 products loaded</div>
                </div>
            </div>
        </div>

        <!-- PDF Content (Hidden until generated) -->
        <div id="pdfContent" class="hidden">
            <!-- PDF content will be generated here -->
        </div>
    </div>

    <script>
        // Same DriveImageManager as other tools
        class DriveImageManager {
            constructor() {
                this.imageCache = new Map();
                this.isInitialized = false;
                this.folderId = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';
                this.apiKey = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
            }

            async initializeGAPI() {
                if (this.isInitialized) return true;
                
                try {
                    await this.loadScript('https://apis.google.com/js/api.js');
                    await new Promise(resolve => gapi.load('client', resolve));
                    
                    await gapi.client.init({
                        apiKey: this.apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    
                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Failed to initialize Google Drive API:', error);
                    return false;
                }
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    if (document.querySelector(`script[src="${src}"]`)) {
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            async scanAllImages() {
                try {
                    const images = await this.fetchImagesFromFolder();
                    this.buildImageMapping(images);
                    return true;
                } catch (error) {
                    console.error('Error scanning images:', error);
                    return false;
                }
            }

            async fetchImagesFromFolder(pageToken = null) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${this.folderId}' in parents and (mimeType contains 'image/jpeg' or mimeType contains 'image/png' or mimeType contains 'image/gif' or mimeType contains 'image/webp')`,
                        fields: 'nextPageToken, files(id, name, mimeType)',
                        pageSize: 100,
                        pageToken: pageToken
                    });

                    let files = response.result.files || [];
                    
                    if (response.result.nextPageToken) {
                        const nextPageFiles = await this.fetchImagesFromFolder(response.result.nextPageToken);
                        files = files.concat(nextPageFiles);
                    }
                    
                    return files;
                } catch (error) {
                    throw new Error('Failed to fetch images: ' + error.message);
                }
            }

            buildImageMapping(images) {
                this.imageCache.clear();
                
                images.forEach(image => {
                    const codes = this.extractProductCodes(image.name);
                    
                    codes.forEach(code => {
                        if (!this.imageCache.has(code)) {
                            this.imageCache.set(code, {
                                id: image.id,
                                name: image.name,
                                url: `https://lh3.googleusercontent.com/d/${image.id}=w400-h400-c`
                            });
                        }
                    });
                });
            }

            extractProductCodes(filename) {
                const codes = [];
                const nameWithoutExt = filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
                
                const numericCodes = nameWithoutExt.match(/\b\d{4,6}\b/g);
                if (numericCodes) {
                    codes.push(...numericCodes);
                }
                
                const alphanumericCodes = nameWithoutExt.match(/\b[A-Z0-9]{4,8}\b/gi);
                if (alphanumericCodes) {
                    codes.push(...alphanumericCodes.map(code => code.toLowerCase()));
                }
                
                const parts = nameWithoutExt.split(/[-_\s\.]+/);
                parts.forEach(part => {
                    const cleanPart = part.trim();
                    if (/^\d{4,6}$/.test(cleanPart) || /^[A-Z0-9]{4,8}$/i.test(cleanPart)) {
                        codes.push(cleanPart.toLowerCase());
                    }
                });
                
                return [...new Set(codes)];
            }

            getImageUrl(productCode) {
                const normalizedCode = productCode.toString().toLowerCase().trim();
                const imageData = this.imageCache.get(normalizedCode);
                return imageData ? imageData.url : null;
            }
        }

        // Global variables
        let allProducts = [];
        let driveImageManager = null;
        let categories = [];

        async function loadCatalog() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            
            loadBtn.disabled = true;
            loadBtn.textContent = 'üîÑ Loading...';
            status.textContent = 'Loading catalog data...';

            try {
                // Load products
                await loadProductsFromExcel();
                status.textContent = 'Loading images...';
                
                // Load images
                driveImageManager = new DriveImageManager();
                const success = await driveImageManager.initializeGAPI();
                if (success) {
                    await driveImageManager.scanAllImages();
                }

                // Setup UI
                setupCategoryFilters();
                document.getElementById('generateBtn').disabled = false;
                status.textContent = `Catalog loaded successfully! ${allProducts.length} products ready`;

            } catch (error) {
                status.textContent = 'Error loading catalog: ' + error.message;
                alert('Error loading catalog: ' + error.message);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üìä Load Catalog Data';
            }
        }

        async function loadProductsFromExcel() {
            const response = await fetch('./JULY PROMO.xlsx');
            if (!response.ok) {
                throw new Error('Could not load JULY PROMO.xlsx');
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer);
            const worksheet = workbook.Sheets['Sheet1'];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            
            allProducts = rawData
                .filter(item => item.SKU && item['PRODUCT '] && item.PRICE !== undefined && item.CATEGORY)
                .map(item => ({
                    sku: item.SKU.toString().trim(),
                    description: item['PRODUCT '].toString().trim(),
                    price: parseFloat(item.PRICE),
                    category: item.CATEGORY.toString().trim().toUpperCase()
                }))
                .filter(product => product.price > 0);
            
            // Extract unique categories
            categories = [...new Set(allProducts.map(p => p.category))].sort();
            
            document.getElementById('productCount').textContent = `${allProducts.length} products loaded`;
        }

        function setupCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            container.innerHTML = categories.map(category => `
                <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50">
                    <input type="checkbox" value="${category}" checked class="mr-2 category-filter">
                    <span class="text-sm">${category}</span>
                </label>
            `).join('');
        }

        function selectAllCategories() {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = true);
        }

        function deselectAllCategories() {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
        }

        function generatePDF() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'üîÑ Generating...';

            try {
                // Get selected categories
                const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                    .map(cb => cb.value);
                
                // Filter products
                const filteredProducts = allProducts.filter(product => 
                    selectedCategories.includes(product.category)
                );

                // Get options
                const layout = document.querySelector('input[name="layout"]:checked').value;
                const includeImages = document.getElementById('includeImages').checked;
                const includePrices = document.getElementById('includePrices').checked;
                const groupByCategory = document.getElementById('groupByCategory').checked;

                // Generate PDF content
                generatePDFContent(filteredProducts, layout, {
                    includeImages,
                    includePrices,
                    groupByCategory,
                    selectedCategories
                });

                document.getElementById('printBtn').disabled = false;
                document.getElementById('status').textContent = `PDF generated! ${filteredProducts.length} products ready to print`;

            } catch (error) {
                alert('Error generating PDF: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üìÑ Generate PDF Preview';
            }
        }

        function generatePDFContent(products, layout, options) {
            const container = document.getElementById('pdfContent');
            container.innerHTML = '';
            container.classList.remove('hidden');

            // Header page
            const headerPage = createHeaderPage();
            container.appendChild(headerPage);

            let currentPageProducts = [];
            let pageNumber = 2;

            if (options.groupByCategory) {
                // Sort products by category, then by description
                const sortedProducts = [...products].sort((a, b) => {
                    if (a.category === b.category) {
                        return a.description.localeCompare(b.description);
                    }
                    return a.category.localeCompare(b.category);
                });

                // Group products by category
                const categoryGroups = {};
                sortedProducts.forEach(product => {
                    if (!categoryGroups[product.category]) {
                        categoryGroups[product.category] = [];
                    }
                    categoryGroups[product.category].push(product);
                });

                // Calculate products per page based on layout
                const productsPerPage = calculateOptimalProductsPerPage(layout, options);

                // Process each category
                Object.entries(categoryGroups).forEach(([category, categoryProducts]) => {
                    // Add category header to current page products
                    currentPageProducts.push({ type: 'header', category });

                    // Add products
                    categoryProducts.forEach(product => {
                        currentPageProducts.push({ type: 'product', ...product });

                        // Check if we need a new page
                        const effectiveCount = currentPageProducts.filter(p => p.type === 'product').length;
                        if (effectiveCount >= productsPerPage) {
                            // Create page
                            const page = createCategoryPage(
                                currentPageProducts,
                                layout,
                                options,
                                pageNumber++
                            );
                            container.appendChild(page);
                            currentPageProducts = [];
                        }
                    });
                });

                // Handle remaining products
                if (currentPageProducts.length > 0) {
                    const page = createCategoryPage(
                        currentPageProducts,
                        layout,
                        options,
                        pageNumber++
                    );
                    container.appendChild(page);
                }

            } else {
                // Regular pagination without categories
                const productsPerPage = calculateOptimalProductsPerPage(layout, options);
                const pageGroups = createOptimalPageGroups(products, productsPerPage);
                
                pageGroups.forEach((pageProducts, pageIndex) => {
                    const productPage = createProductPage(
                        pageProducts, 
                        layout, 
                        options, 
                        pageIndex + 2, 
                        pageGroups.length + 1
                    );
                    container.appendChild(productPage);
                });
            }

            // Update total pages in header
            const totalPages = container.querySelectorAll('.print-page').length;
            container.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });

            // Update status
            document.getElementById('status').textContent = 
                `PDF generated! ${products.length} products across ${totalPages} pages`;

            // Scroll to PDF content
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function calculateOptimalProductsPerPage(layout, options) {
            let base;
            
            if (layout === 'compact') {
                base = options.includeImages ? 30 : 36;
            } else if (layout === 'list') {
                base = options.includeImages ? 8 : 12;
            } else { // grid
                base = options.includeImages ? 20 : 24;
            }

            // Adjust for additional content
            if (options.includePrices) {
                base = Math.floor(base * 0.9);
            }

            // If grouping by category, reduce slightly for headers
            if (options.groupByCategory) {
                base = Math.floor(base * 0.85);
            }

            return base;
        }

        function createOptimalPageGroups(products, baseProductsPerPage) {
            const groups = [];
            let currentIndex = 0;

            while (currentIndex < products.length) {
                const remainingProducts = products.length - currentIndex;
                
                let productsForThisPage;
                
                if (remainingProducts <= baseProductsPerPage) {
                    productsForThisPage = remainingProducts;
                } else if (remainingProducts <= baseProductsPerPage + 3) {
                    const productsPerLastTwoPages = Math.ceil(remainingProducts / 2);
                    productsForThisPage = Math.min(productsPerLastTwoPages, baseProductsPerPage);
                } else {
                    productsForThisPage = baseProductsPerPage;
                }

                groups.push(products.slice(currentIndex, currentIndex + productsForThisPage));
                currentIndex += productsForThisPage;
            }

            return groups;
        }

        function createHeaderPage() {
            const page = document.createElement('div');
            page.className = 'print-page bg-white p-8 shadow-lg rounded-lg mb-6';
            page.innerHTML = `
                <div class="text-center">
                    <div class="mb-8">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ Cash & Carry" class="h-24 mx-auto mb-4">
                    </div>
                    
                    <div class="bg-red-600 text-white py-4 px-8 rounded-lg mb-8 inline-block">
                        <h1 class="text-4xl font-bold mb-2">üéâ JULY 2025 PROMO üéâ</h1>
                        <p class="text-xl">Exclusive Deals on Premium Home & Kitchen Products</p>
                    </div>

                    <div class="grid grid-cols-2 gap-8 text-left mb-8">
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üè™ OZZ CASH & CARRY</h3>
                            <p class="text-gray-700">
                                40 Mazeppa & Gull Street<br>
                                Durban, KwaZulu-Natal 4001<br>
                                South Africa
                            </p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">üè† IKHAYA HOMESTORE</h3>
                            <p class="text-gray-700">
                                Block D, Shop 88 China City<br>
                                Springfield Park, Durban<br>
                                KwaZulu-Natal, South Africa
                            </p>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-6 rounded-lg mb-8">
                        <h3 class="text-xl font-bold text-blue-800 mb-4">üìû Contact Information</h3>
                        <p class="text-2xl font-bold text-blue-600 mb-2">+27 31 332 7192</p>
                        <p class="text-blue-700">
                            Monday - Friday: 8:00 AM - 5:00 PM<br>
                            Saturday: 8:00 AM - 1:00 PM
                        </p>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 text-left">
                        <h4 class="text-lg font-bold text-yellow-800 mb-2">‚è∞ Limited Time Offer - July 2025</h4>
                        <p class="text-yellow-700 mb-4">
                            This promotional catalog features exclusive deals on premium home and kitchen products. 
                            All prices are valid for July 2025 only and subject to stock availability.
                        </p>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-yellow-600">${allProducts.length}</div>
                                <div class="text-sm text-yellow-700">Products</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-yellow-600">${categories.length}</div>
                                <div class="text-sm text-yellow-700">Categories</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-yellow-600">20%</div>
                                <div class="text-sm text-yellow-700">Avg Savings</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer for header page -->
                <div class="page-footer">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="footer-logo mr-3">
                        <div>
                            <div class="font-semibold">OZZ Cash & Carry</div>
                            <div>40 Mazeppa & Gull Street, Durban 4001</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">+27 31 332 7192</div>
                        <div>www.blackorchid.online</div>
                    </div>
                </div>
            `;
            return page;
        }

        function createCategoryPage(items, layout, options, pageNumber) {
            const page = document.createElement('div');
            page.className = 'print-page bg-white p-6 shadow-lg rounded-lg mb-6';

            // Page header
            const header = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="h-8 mr-3">
                        <h2 class="text-lg font-bold text-gray-800">July 2025 Promotional Catalog</h2>
                    </div>
                    <span class="text-gray-600 font-semibold">Page ${pageNumber} of <span class="total-pages">-</span></span>
                </div>
            `;

            // Build content
            let content = '<div>';
            let currentCategory = null;
            let categoryProducts = [];

            items.forEach(item => {
                if (item.type === 'header') {
                    // If we have products from previous category, render them
                    if (categoryProducts.length > 0) {
                        content += renderProductGrid(categoryProducts, layout, options);
                        categoryProducts = [];
                    }
                    // Add new category header
                    content += `<div class="category-header">${item.category}</div>`;
                    currentCategory = item.category;
                } else {
                    categoryProducts.push(item);
                }
            });

            // Render any remaining products
            if (categoryProducts.length > 0) {
                content += renderProductGrid(categoryProducts, layout, options);
            }

            content += '</div>';

            // Footer
            const footer = `
                <div class="page-footer">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="footer-logo mr-2">
                        <div>
                            <div class="font-semibold">OZZ Cash & Carry</div>
                            <div>40 Mazeppa & Gull Street, Durban 4001 ‚Ä¢ +27 31 332 7192</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">Limited Time Offer - July 2025</div>
                        <div>Designed by Black Orchid Consulting</div>
                    </div>
                </div>
            `;

            page.innerHTML = header + content + footer;
            return page;
        }

        function renderProductGrid(products, layout, options) {
            // Determine grid class
            let gridClass;
            if (layout === 'compact') {
                gridClass = 'grid grid-cols-6 gap-2';
            } else if (layout === 'list') {
                gridClass = 'grid grid-cols-1 gap-3';
            } else {
                gridClass = 'grid grid-cols-4 gap-3';
            }

            const productsHTML = products.map(product => 
                renderProductCard(product, layout, options)
            ).join('');

            return `<div class="${gridClass} mb-4">${productsHTML}</div>`;
        }

        function renderProductCard(product, layout, options) {
            const imageUrl = driveImageManager ? driveImageManager.getImageUrl(product.sku) : null;
            const originalPrice = (product.price * 1.2).toFixed(2);
            const savings = (originalPrice - product.price).toFixed(2);
            const savingsPercent = Math.round(((originalPrice - product.price) / originalPrice) * 100);

            if (layout === 'list') {
                return `
                    <div class="border border-gray-200 rounded p-3 flex items-center product-card-print">
                        ${options.includeImages ? `
                            <div class="h-20 w-20 mr-4 flex-shrink-0">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" alt="${product.description}" class="w-full h-full object-contain border rounded">` :
                                    `<div class="w-full h-full bg-gray-100 border rounded flex items-center justify-center text-xs text-gray-400 font-mono">${product.sku}</div>`
                                }
                            </div>
                        ` : ''}
                        <div class="flex-1 min-w-0">
                            <div class="product-sku">SKU: ${product.sku}</div>
                            <div class="product-description">${product.description}</div>
                            ${options.includePrices ? `
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="product-price">R${product.price.toFixed(2)}</span>
                                    <span class="text-sm text-gray-400 line-through">R${originalPrice}</span>
                                    <span class="text-xs text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded">SAVE ${savingsPercent}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                const truncateLength = layout === 'compact' ? 40 : 65;
                const displayDescription = product.description.length > truncateLength ? 
                    product.description.substring(0, truncateLength) + '...' : 
                    product.description;

                return `
                    <div class="border border-gray-200 rounded p-3 text-center product-card-print">
                        ${options.includeImages ? `
                            <div class="mb-2 ${layout === 'compact' ? 'h-16' : 'h-24'} mx-auto flex items-center justify-center">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" alt="${product.description}" class="w-full h-full object-contain">` :
                                    `<div class="w-full h-full bg-gray-100 border rounded flex items-center justify-center ${layout === 'compact' ? 'text-xs' : 'text-sm'} text-gray-400 font-mono leading-tight p-1">${product.sku}</div>`
                                }
                            </div>
                        ` : ''}
                        <div class="space-y-1">
                            <div class="product-sku">SKU: ${product.sku}</div>
                            <div class="product-description ${layout === 'compact' ? 'min-h-[2.5rem]' : 'min-h-[3rem]'} flex items-center justify-center text-center px-1">
                                ${displayDescription}
                            </div>
                            ${options.includePrices ? `
                                <div class="space-y-0.5">
                                    <div class="product-price">R${product.price.toFixed(2)}</div>
                                    <div class="text-xs text-gray-400 line-through">R${originalPrice}</div>
                                    <div class="text-xs text-green-600 font-bold">SAVE ${savingsPercent}%</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        function createProductPage(products, layout, options, pageNumber, totalPages) {
            const page = document.createElement('div');
            page.className = 'print-page bg-white p-6 shadow-lg rounded-lg mb-6';

            // Page header
            const header = `
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="h-8 mr-3">
                        <h2 class="text-lg font-bold text-gray-800">July 2025 Promotional Catalog</h2>
                    </div>
                    <span class="text-gray-600 font-semibold">Page ${pageNumber} of ${totalPages}</span>
                </div>
            `;

            const productsHTML = renderProductGrid(products, layout, options);

            // Footer
            const footer = `
                <div class="page-footer">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="footer-logo mr-2">
                        <div>
                            <div class="font-semibold">OZZ Cash & Carry</div>
                            <div>40 Mazeppa & Gull Street, Durban 4001 ‚Ä¢ +27 31 332 7192</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">Limited Time Offer - July 2025</div>
                        <div>Designed by Black Orchid Consulting</div>
                    </div>
                </div>
            `;

            page.innerHTML = header + productsHTML + footer;
            return page;
        }
    </script>
</body>
</html>
