// PART 1: Replace the loadCatalog function with this updated version
async function loadCatalog() {
    const loadBtn = document.getElementById('loadBtn');
    const status = document.getElementById('status');
    
    loadBtn.disabled = true;
    status.innerHTML = '‚è≥ Loading Excel file with page organization...';
    
    try {
        const response = await fetch('./JULY PROMO.xlsx');
        if (!response.ok) {
            throw new Error('Could not find JULY PROMO.xlsx in the same folder');
        }
        
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data);
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        
        // Get data as array of arrays to preserve structure
        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // Parse the page-organized data
        const pageData = {};
        let currentPage = null;
        let pageProducts = [];
        
        rawData.forEach((row, index) => {
            if (!row || row.length === 0) return;
            
            // Check for page headers
            const pageMatch = row.find(cell => 
                cell && String(cell).toUpperCase().includes('PAGE')
            );
            
            if (pageMatch) {
                // Save previous page
                if (currentPage && pageProducts.length > 0) {
                    pageData[currentPage] = [...pageProducts];
                }
                
                currentPage = String(pageMatch).toUpperCase();
                pageProducts = [];
            }
            // Product row: has numeric SKU in second column
            else if (row[1] && typeof row[1] === 'number' && row[2] && row[3]) {
                const product = {
                    sku: String(row[1]).trim(),
                    description: String(row[2]).trim(),
                    price: parseFloat(row[3]) || 0,
                    category: String(row[4] || 'UNCATEGORIZED').trim().toUpperCase(),
                    pageNumber: currentPage ? parseInt(currentPage.replace('PAGE ', '')) : 1
                };
                
                if (product.price > 0 && product.description) {
                    pageProducts.push(product);
                }
            }
        });
        
        // Save last page
        if (currentPage && pageProducts.length > 0) {
            pageData[currentPage] = [...pageProducts];
        }
        
        // Flatten all products for compatibility with existing functions
        allProducts = [];
        Object.keys(pageData).sort((a, b) => {
            const numA = parseInt(a.replace('PAGE ', ''));
            const numB = parseInt(b.replace('PAGE ', ''));
            return numA - numB;
        }).forEach(page => {
            allProducts.push(...pageData[page]);
        });
        
        // Store page organization for custom generation
        window.pageOrganization = pageData;
        
        categories = [...new Set(allProducts.map(p => p.category))].sort();
        
        showCategories();
        showPagePreview(); // New function to show page organization
        document.getElementById('customizationPanel').style.display = 'block';
        document.getElementById('introPageCustomization').style.display = 'block';
        document.getElementById('layoutOptions').style.display = 'block';
        
        document.getElementById('imageBtn').disabled = false;
        document.getElementById('generateBtn').disabled = false;
        
        const pageCount = Object.keys(pageData).length;
        status.innerHTML = `‚úÖ <strong>Loaded ${allProducts.length} products organized in ${pageCount} predefined pages</strong>`;
        
    } catch (error) {
        status.innerHTML = `‚ùå <strong style="color: #dc3545;">Error: ${error.message}</strong>`;
        console.error(error);
    } finally {
        loadBtn.disabled = false;
    }
}
// PART 2: Add this new function after the loadCatalog function
function showPagePreview() {
    // Remove existing page preview if it exists
    const existingPreview = document.getElementById('pagePreviewSection');
    if (existingPreview) {
        existingPreview.remove();
    }
    
    if (!window.pageOrganization) return;
    
    // Create page preview section
    const pagePreviewSection = document.createElement('div');
    pagePreviewSection.id = 'pagePreviewSection';
    pagePreviewSection.className = 'category-section';
    pagePreviewSection.innerHTML = `
        <h3>üìÑ Excel Page Organization Preview</h3>
        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                Your Excel file contains products organized in predefined pages. The catalog will be generated according to this arrangement.
            </p>
            <div id="pagePreviewGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px;">
                    <input type="checkbox" id="useExcelPages" checked style="margin-right: 8px;">
                    <span style="font-weight: bold;">Use Excel page organization (Recommended)</span>
                </label>
                <p style="font-size: 12px; color: #666; margin: 0;">
                    When checked, products will be arranged exactly as defined in your Excel file. 
                    When unchecked, products will be arranged by category as before.
                </p>
            </div>
        </div>
    `;
    
    // Insert after layout options
    const layoutOptions = document.getElementById('layoutOptions');
    layoutOptions.parentNode.insertBefore(pagePreviewSection, layoutOptions.nextSibling);
    
    // Populate page preview grid
    const pagePreviewGrid = document.getElementById('pagePreviewGrid');
    const sortedPages = Object.keys(window.pageOrganization).sort((a, b) => {
        const numA = parseInt(a.replace('PAGE ', ''));
        const numB = parseInt(b.replace('PAGE ', ''));
        return numA - numB;
    });
    
    sortedPages.forEach(page => {
        const products = window.pageOrganization[page];
        const pageCard = document.createElement('div');
        pageCard.className = 'category-item';
        pageCard.style.cssText = 'border: 2px solid #ddd; border-radius: 8px; padding: 12px; background: white; flex-direction: column; align-items: flex-start;';
        
        pageCard.innerHTML = `
            <div style="font-weight: bold; color: #333; margin-bottom: 8px;">${page}</div>
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${products.length} products</div>
            <div style="font-size: 11px; color: #888; line-height: 1.3;">
                ${products.slice(0, 3).map(p => `‚Ä¢ ${p.description.substring(0, 25)}...`).join('<br>')}
                ${products.length > 3 ? `<br>‚Ä¢ ... and ${products.length - 3} more` : ''}
            </div>
        `;
        
        pagePreviewGrid.appendChild(pageCard);
    });
}
// PART 3: Replace the generateCatalog function with this updated version
function generateCatalog() {
    const useExcelPages = document.getElementById('useExcelPages');
    const selectedLayout = document.querySelector('input[name="layout"]:checked').value;
    const layoutConfig = getLayoutConfig(selectedLayout);
    
    const printContent = document.getElementById('printContent');
    printContent.innerHTML = '';
    
    // Add consolidated header page
    printContent.appendChild(createHeaderPage());
    let pageNum = 2;
    
    if (useExcelPages && useExcelPages.checked && window.pageOrganization) {
        // Use Excel page organization
        const sortedPages = Object.keys(window.pageOrganization).sort((a, b) => {
            const numA = parseInt(a.replace('PAGE ', ''));
            const numB = parseInt(b.replace('PAGE ', ''));
            return numA - numB;
        });
        
        let filteredProducts = [];
        
        sortedPages.forEach(pageKey => {
            const pageProducts = window.pageOrganization[pageKey];
            
            // Filter by selected categories if category filtering is enabled
            const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked')).map(cb => cb.value);
            const productsToShow = selectedCats.length > 0 
                ? pageProducts.filter(p => selectedCats.includes(p.category))
                : pageProducts;
            
            if (productsToShow.length > 0) {
                // Split products according to selected layout
                for (let i = 0; i < productsToShow.length; i += layoutConfig.productsPerPage) {
                    const pageProductSlice = productsToShow.slice(i, i + layoutConfig.productsPerPage);
                    
                    // Create page with Excel page number as category header
                    const excelPageNum = parseInt(pageKey.replace('PAGE ', ''));
                    printContent.appendChild(createProductPage(
                        pageProductSlice, 
                        `Excel ${pageKey}`, 
                        i === 0, // Show header only for first slice of each Excel page
                        pageNum++, 
                        layoutConfig
                    ));
                }
                
                filteredProducts.push(...productsToShow);
            }
        });
        
        const totalPages = printContent.querySelectorAll('.page').length;
        printContent.querySelectorAll('.total-pages').forEach(el => {
            el.textContent = totalPages;
        });
        
        document.getElementById('printBtn').disabled = false;
        
        let imageInfo = '';
        if (driveImageManager) {
            const stats = driveImageManager.getStats();
            let mappedCount = 0;
            filteredProducts.forEach(product => {
                const imageData = driveImageManager.getProductImage(product.sku);
                if (imageData.found) mappedCount++;
            });
            imageInfo = ` (${mappedCount} with images)`;
        }
        
        document.getElementById('status').innerHTML = 
            `‚úÖ <strong>Generated ${totalPages} pages with ${filteredProducts.length} products using Excel page organization and ${selectedLayout} layout</strong>`;
            
    } else {
        // Use original category-based organization
        const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked')).map(cb => cb.value);
        
        if (selectedCats.length === 0) {
            alert('Please select at least one category or enable Excel page organization');
            return;
        }
        
        const filteredProducts = allProducts.filter(p => selectedCats.includes(p.category));
        filteredProducts.sort((a, b) => {
            if (a.category !== b.category) {
                return a.category.localeCompare(b.category);
            }
            return a.description.localeCompare(b.description);
        });
        
        const grouped = {};
        filteredProducts.forEach(p => {
            if (!grouped[p.category]) grouped[p.category] = [];
            grouped[p.category].push(p);
        });
        
        Object.entries(grouped).forEach(([category, products]) => {
            for (let i = 0; i < products.length; i += layoutConfig.productsPerPage) {
                const pageProducts = products.slice(i, i + layoutConfig.productsPerPage);
                const showCategoryHeader = i === 0;
                printContent.appendChild(createProductPage(pageProducts, category, showCategoryHeader, pageNum++, layoutConfig));
            }
        });
        
        const totalPages = printContent.querySelectorAll('.page').length;
        printContent.querySelectorAll('.total-pages').forEach(el => {
            el.textContent = totalPages;
        });
        
        document.getElementById('printBtn').disabled = false;
        
        let imageInfo = '';
        if (driveImageManager) {
            const stats = driveImageManager.getStats();
            let mappedCount = 0;
            filteredProducts.forEach(product => {
                const imageData = driveImageManager.getProductImage(product.sku);
                if (imageData.found) mappedCount++;
            });
            imageInfo = ` (${mappedCount} with images)`;
        }
        
        document.getElementById('status').innerHTML = 
            `‚úÖ <strong>Generated ${totalPages} pages with ${filteredProducts.length} products${imageInfo} using ${selectedLayout} layout (category mode)</strong>`;
    }
    
    printContent.scrollIntoView({ behavior: 'smooth' });
}
                // PART 4: Replace the showCategories function with this enhanced version
function showCategories() {
    const section = document.getElementById('categorySection');
    const list = document.getElementById('categoryList');
    
    section.style.display = 'block';
    list.innerHTML = '';
    
    // Add explanation text
    const explanationDiv = document.createElement('div');
    explanationDiv.innerHTML = `
        <p style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 14px;">
            <strong>Category Filtering:</strong> When "Use Excel page organization" is enabled above, these categories will filter 
            products within each Excel page. When disabled, products will be grouped by these categories instead.
        </p>
    `;
    list.appendChild(explanationDiv);
    
    // Create category grid
    const categoryGrid = document.createElement('div');
    categoryGrid.className = 'category-grid';
    
    categories.forEach(cat => {
        const count = allProducts.filter(p => p.category === cat).length;
        const item = document.createElement('label');
        item.className = 'category-item';
        item.innerHTML = `
            <input type="checkbox" checked value="${cat}" class="category-cb">
            <span>${cat}</span>
            <span class="category-count">${count} items</span>
        `;
        categoryGrid.appendChild(item);
    });
    
    list.appendChild(categoryGrid);
    
    // Add select all/none buttons
    const buttonDiv = document.createElement('div');
    buttonDiv.style.cssText = 'margin-top: 15px; text-align: center;';
    buttonDiv.innerHTML = `
        <button onclick="selectAllCategories()" style="background: #28a745; color: white; margin-right: 10px;">Select All</button>
        <button onclick="selectNoCategories()" style="background: #dc3545; color: white;">Select None</button>
    `;
    list.appendChild(buttonDiv);
}

// Helper functions for category selection
function selectAllCategories() {
    document.querySelectorAll('.category-cb').forEach(cb => cb.checked = true);
    showNotification('All categories selected', 'success');
}

function selectNoCategories() {
    document.querySelectorAll('.category-cb').forEach(cb => cb.checked = false);
    showNotification('All categories deselected', 'info');
}
                /* PART 5: Add these CSS rules to your existing style section (before the @media print) */

/* Page preview enhancements */
#pagePreviewSection .category-item:hover {
    border-color: #007bff !important;
    background: #f8f9ff !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

/* Excel page organization toggle */
#useExcelPages {
    transform: scale(1.2);
    accent-color: #007bff;
}

/* Enhanced category section styling */
.category-section p {
    line-height: 1.5;
}

.category-section button {
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.category-section button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Status box enhancements */
.status-box {
    position: relative;
    overflow: hidden;
}

.status-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.status-box:hover::before {
    left: 100%;
}

/* Print content preview enhancement */
.print-preview {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

/* Page organization indicator in category headers */
.category-header.excel-page {
    background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%) !important;
}

.category-header.excel-page::before {
    content: '';
    width: 4mm;
    height: 4mm;
    background: #ff9800 !important;
    margin-right: 4mm;
    display: block;
}
                // PART 6: Replace the createProductPage function with this enhanced version
function createProductPage(products, category, showHeader, pageNum, layoutConfig = { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 }) {
    const page = document.createElement('div');
    page.className = 'page';
    
    // Determine if this is an Excel page
    const isExcelPage = category.startsWith('Excel PAGE');
    const headerClass = isExcelPage ? 'category-header excel-page' : 'category-header';
    
    let contentHTML = `
        <div class="page-inner">
            <div class="page-header">
                <div class="header-left">
                    <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                         alt="OZZ" class="header-logo" onerror="this.style.display='none'">
                    <span class="header-title">July 2025 Promotional Catalog</span>
                </div>
                <span class="page-number">Page ${pageNum} of <span class="total-pages">-</span></span>
            </div>
            
            <div class="page-content">
    `;
    
    if (showHeader) {
        const headerText = isExcelPage ? category.replace('Excel ', '') : category;
        contentHTML += `<div class="${headerClass}">${headerText}</div>`;
    }
    
    contentHTML += `<div class="products-container"><div class="products-grid ${layoutConfig.gridClass}">`;
    
    for (let i = 0; i < layoutConfig.productsPerPage; i++) {
        if (i < products.length) {
            contentHTML += createProductCard(products[i]);
        } else {
            contentHTML += '<div class="product-card" style="visibility: hidden;"></div>';
        }
