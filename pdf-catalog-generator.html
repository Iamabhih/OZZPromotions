<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÑ OZZ PDF Catalog Generator - Perfect Print</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Screen styles */
        @media screen {
            body {
                background-color: #f3f4f6;
            }
            .print-preview-container {
                max-width: 210mm;
                margin: 0 auto;
                background: white;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
        }

        /* Print-specific styles */
        @media print {
            /* Reset all default margins and padding */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                width: 210mm !important;
                height: 297mm !important;
            }
            
            body {
                background: white !important;
            }
            
            /* Hide everything except print content */
            .no-print {
                display: none !important;
            }
            
            /* Ensure print content fills the page */
            #pdfContent {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            
            /* Each page should be exactly A4 size */
            .print-page {
                width: 210mm !important;
                height: 297mm !important;
                margin: 0 !important;
                padding: 20mm 15mm 25mm 15mm !important; /* Top, Right, Bottom, Left */
                page-break-after: always !important;
                page-break-inside: avoid !important;
                position: relative !important;
                overflow: hidden !important;
                background: white !important;
                box-sizing: border-box !important;
            }
            
            .print-page:last-child {
                page-break-after: auto !important;
            }
            
            /* Page content area */
            .page-content {
                height: calc(297mm - 45mm - 25mm) !important; /* Total height - padding top/bottom - footer space */
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Product grid adjustments */
            .product-grid-print {
                display: grid !important;
                gap: 1rem !important; /* More spacing between items */
                width: 100% !important;
                margin-bottom: 1rem !important;
            }
            
            .grid-cols-6-print {
                grid-template-columns: repeat(6, 1fr) !important;
            }
            
            .grid-cols-4-print {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            
            .grid-cols-1-print {
                grid-template-columns: 1fr !important;
            }
            
            /* Product cards */
            .product-card-print {
                border: 1px solid #e5e7eb !important;
                padding: 0.75rem !important; /* More padding for better appearance */
                background: #ffffff !important;
                border-radius: 0.375rem !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            /* Product images */
            .product-image-container-print {
                width: 100% !important;
                aspect-ratio: 1 !important; /* Square aspect ratio */
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                overflow: hidden !important;
                background: #f9fafb !important;
                border-radius: 0.25rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .product-image {
                max-width: 100% !important;
                max-height: 100% !important;
                object-fit: contain !important;
                object-position: center !important;
            }
            
            /* Category headers */
            .category-header {
                background: #f3f4f6 !important;
                padding: 0.75rem 1rem !important;
                margin: 1rem 0 0.5rem 0 !important;
                border-left: 4px solid #ef4444 !important;
                font-weight: bold !important;
                font-size: 1.125rem !important;
                color: #1f2937 !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            /* Page footer - positioned absolutely at bottom */
            .page-footer {
                position: absolute !important;
                bottom: 15mm !important;
                left: 15mm !important;
                right: 15mm !important;
                height: 8mm !important;
                border-top: 1px solid #e5e7eb !important;
                padding-top: 2mm !important;
                background: white !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                font-size: 8pt !important;
                color: #6b7280 !important;
            }
            
            /* Footer logo */
            .footer-logo {
                height: 6mm !important;
            }
            
            /* Typography for print */
            .product-sku {
                color: #9ca3af !important;
                font-size: 9pt !important;
                font-weight: normal !important;
            }
            
            .product-description {
                color: #111827 !important;
                font-weight: 600 !important;
                font-size: 10pt !important;
                line-height: 1.3 !important;
                margin: 0.25rem 0 !important;
            }
            
            .product-price {
                color: #dc2626 !important;
                font-weight: 700 !important;
                font-size: 12pt !important;
            }
            
            /* Image handling */
            .product-image {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }
            
            .image-placeholder {
                background: #f3f4f6 !important;
                border: 1px solid #e5e7eb !important;
            }
            
            /* Ensure no shadows or rounded corners in print */
            .print-page,
            .product-card-print {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            
            /* Header page specific styles */
            .header-content {
                display: flex !important;
                flex-direction: column !important;
                height: 100% !important;
                justify-content: center !important;
            }
        }
        
        /* Page size definition */
        @page {
            size: A4;
            margin: 0;
        }
        
        /* Additional utility classes */
        .avoid-break {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
    </style>
</head>
<body>
    <!-- Control Panel (Hidden in print) -->
    <div class="max-w-6xl mx-auto p-6 no-print">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">üìÑ PDF Catalog Generator</h1>
                <p class="text-gray-600">Generate a perfect print-ready PDF catalog</p>
            </div>

            <!-- Options Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Layout Options -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">üìÑ Layout Options</h3>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="radio" name="layout" value="grid" checked class="mr-3">
                            <span>Grid Layout (4 per row)</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="radio" name="layout" value="list" class="mr-3">
                            <span>List Layout (detailed view)</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="radio" name="layout" value="compact" class="mr-3">
                            <span>Compact Grid (6 per row)</span>
                        </label>
                    </div>
                </div>

                <!-- Display Options -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Display Options</h3>
                    <div class="space-y-3">
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="checkbox" id="includeImages" checked class="mr-3">
                            <span>Include product images</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="checkbox" id="includePrices" checked class="mr-3">
                            <span>Include prices & savings</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="checkbox" id="groupByCategory" checked class="mr-3">
                            <span>Group products by category</span>
                        </label>
                        <label class="flex items-center cursor-pointer hover:bg-gray-100 p-2 rounded">
                            <input type="checkbox" id="newPagePerCategory" checked class="mr-3">
                            <span>Start each category on new page</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="bg-gray-50 p-6 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-4">üè∑Ô∏è Category Selection</h3>
                <div class="mb-3">
                    <button onclick="selectAllCategories()" class="text-sm text-blue-600 hover:text-blue-800 mr-4 font-medium">‚úì Select All</button>
                    <button onclick="deselectAllCategories()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">‚úó Deselect All</button>
                </div>
                <div id="categoryFilters" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Category checkboxes will be populated here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="loadCatalog()" id="loadBtn" 
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-all font-semibold shadow-md hover:shadow-lg">
                    üìä Load Catalog Data
                </button>
                <button onclick="generatePDF()" id="generateBtn" disabled
                        class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-all font-semibold shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    üìÑ Generate PDF Preview
                </button>
                <button onclick="window.print()" id="printBtn" disabled
                        class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-all font-semibold shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    üñ®Ô∏è Print / Save as PDF
                </button>
            </div>

            <!-- Status Panel -->
            <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <span class="text-blue-900 font-semibold">Status:</span>
                    <span id="status" class="text-blue-700">Ready to load catalog</span>
                </div>
                <div class="mt-2">
                    <div class="text-sm text-blue-600" id="productCount">No products loaded</div>
                </div>
            </div>

            <!-- Print Tips -->
            <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 class="font-semibold text-yellow-900 mb-2">üñ®Ô∏è Print Tips:</h4>
                <ul class="text-sm text-yellow-800 space-y-1">
                    <li>‚Ä¢ Use Chrome or Edge for best print results</li>
                    <li>‚Ä¢ Set margins to "None" in print dialog</li>
                    <li>‚Ä¢ Ensure "Background graphics" is enabled</li>
                    <li>‚Ä¢ Select "A4" paper size</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- PDF Content Container -->
    <div id="pdfContent" class="hidden print-preview-container">
        <!-- PDF pages will be generated here -->
    </div>

    <script>
        // Drive Image Manager Class
        class DriveImageManager {
            constructor() {
                this.imageCache = new Map();
                this.isInitialized = false;
                this.folderId = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';
                this.apiKey = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
            }

            async initializeGAPI() {
                if (this.isInitialized) return true;
                
                try {
                    await this.loadScript('https://apis.google.com/js/api.js');
                    await new Promise(resolve => gapi.load('client', resolve));
                    
                    await gapi.client.init({
                        apiKey: this.apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    
                    this.isInitialized = true;
                    console.log('‚úì Google Drive API initialized');
                    return true;
                } catch (error) {
                    console.error('Failed to initialize Google Drive API:', error);
                    return false;
                }
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    if (document.querySelector(`script[src="${src}"]`)) {
                        resolve();
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            async scanAllImages() {
                try {
                    const images = await this.fetchImagesFromFolder();
                    this.buildImageMapping(images);
                    console.log(`‚úì Found ${this.imageCache.size} product images`);
                    return true;
                } catch (error) {
                    console.error('Error scanning images:', error);
                    return false;
                }
            }

            async fetchImagesFromFolder(pageToken = null) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${this.folderId}' in parents and (mimeType contains 'image/jpeg' or mimeType contains 'image/png' or mimeType contains 'image/gif' or mimeType contains 'image/webp')`,
                        fields: 'nextPageToken, files(id, name, mimeType)',
                        pageSize: 100,
                        pageToken: pageToken
                    });

                    let files = response.result.files || [];
                    
                    if (response.result.nextPageToken) {
                        const nextPageFiles = await this.fetchImagesFromFolder(response.result.nextPageToken);
                        files = files.concat(nextPageFiles);
                    }
                    
                    return files;
                } catch (error) {
                    throw new Error('Failed to fetch images: ' + error.message);
                }
            }

            buildImageMapping(images) {
                this.imageCache.clear();
                
                images.forEach(image => {
                    const codes = this.extractProductCodes(image.name);
                    
                    codes.forEach(code => {
                        if (!this.imageCache.has(code)) {
                            this.imageCache.set(code, {
                                id: image.id,
                                name: image.name,
                                url: `https://lh3.googleusercontent.com/d/${image.id}=w400-h400-c`
                            });
                        }
                    });
                });
            }

            extractProductCodes(filename) {
                const codes = [];
                const nameWithoutExt = filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
                
                const numericCodes = nameWithoutExt.match(/\b\d{4,6}\b/g);
                if (numericCodes) {
                    codes.push(...numericCodes);
                }
                
                const alphanumericCodes = nameWithoutExt.match(/\b[A-Z0-9]{4,8}\b/gi);
                if (alphanumericCodes) {
                    codes.push(...alphanumericCodes.map(code => code.toLowerCase()));
                }
                
                const parts = nameWithoutExt.split(/[-_\s\.]+/);
                parts.forEach(part => {
                    const cleanPart = part.trim();
                    if (/^\d{4,6}$/.test(cleanPart) || /^[A-Z0-9]{4,8}$/i.test(cleanPart)) {
                        codes.push(cleanPart.toLowerCase());
                    }
                });
                
                return [...new Set(codes)];
            }

            getImageUrl(productCode) {
                const normalizedCode = productCode.toString().toLowerCase().trim();
                const imageData = this.imageCache.get(normalizedCode);
                return imageData ? imageData.url : null;
            }
        }

        // Global variables
        let allProducts = [];
        let driveImageManager = null;
        let categories = [];

        // Main functions
        async function loadCatalog() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            
            loadBtn.disabled = true;
            loadBtn.textContent = 'üîÑ Loading...';
            status.textContent = 'Loading catalog data...';

            try {
                // Load products from Excel
                await loadProductsFromExcel();
                status.textContent = 'Loading product images...';
                
                // Initialize and load images
                driveImageManager = new DriveImageManager();
                const success = await driveImageManager.initializeGAPI();
                if (success) {
                    await driveImageManager.scanAllImages();
                }

                // Setup UI
                setupCategoryFilters();
                document.getElementById('generateBtn').disabled = false;
                status.textContent = `‚úì Catalog loaded! ${allProducts.length} products ready`;
                status.className = 'text-green-700 font-semibold';

            } catch (error) {
                status.textContent = '‚úó Error: ' + error.message;
                status.className = 'text-red-700 font-semibold';
                console.error('Load error:', error);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üìä Load Catalog Data';
            }
        }

        async function loadProductsFromExcel() {
            const response = await fetch('./JULY PROMO.xlsx');
            if (!response.ok) {
                throw new Error('Could not load JULY PROMO.xlsx file');
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer);
            const worksheet = workbook.Sheets['Sheet1'];
            const rawData = XLSX.utils.sheet_to_json(worksheet);
            
            allProducts = rawData
                .filter(item => item.SKU && item['PRODUCT '] && item.PRICE !== undefined && item.CATEGORY)
                .map(item => ({
                    sku: item.SKU.toString().trim(),
                    description: item['PRODUCT '].toString().trim(),
                    price: parseFloat(item.PRICE),
                    category: item.CATEGORY.toString().trim().toUpperCase()
                }))
                .filter(product => product.price > 0);
            
            // Extract unique categories
            categories = [...new Set(allProducts.map(p => p.category))].sort();
            
            document.getElementById('productCount').textContent = `${allProducts.length} products loaded from ${categories.length} categories`;
        }

        function setupCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            container.innerHTML = categories.map(category => {
                const count = allProducts.filter(p => p.category === category).length;
                return `
                    <label class="flex items-center p-2 bg-white rounded border hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="${category}" checked class="mr-2 category-filter">
                        <span class="text-sm">${category} <span class="text-gray-500">(${count})</span></span>
                    </label>
                `;
            }).join('');
        }

        function selectAllCategories() {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = true);
        }

        function deselectAllCategories() {
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
        }

        function generatePDF() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'üîÑ Generating...';

            try {
                // Get selected categories
                const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                    .map(cb => cb.value);
                
                if (selectedCategories.length === 0) {
                    alert('Please select at least one category');
                    return;
                }
                
                // Filter products
                const filteredProducts = allProducts.filter(product => 
                    selectedCategories.includes(product.category)
                );

                // Get options
                const layout = document.querySelector('input[name="layout"]:checked').value;
                const includeImages = document.getElementById('includeImages').checked;
                const includePrices = document.getElementById('includePrices').checked;
                const groupByCategory = document.getElementById('groupByCategory').checked;
                const newPagePerCategory = document.getElementById('newPagePerCategory').checked;

                // Generate PDF content
                generatePDFContent(filteredProducts, layout, {
                    includeImages,
                    includePrices,
                    groupByCategory,
                    newPagePerCategory,
                    selectedCategories
                });

                // Enable print button
                document.getElementById('printBtn').disabled = false;
                document.getElementById('status').textContent = `‚úì PDF ready! ${filteredProducts.length} products across ${document.querySelectorAll('.print-page').length} pages`;
                document.getElementById('status').className = 'text-green-700 font-semibold';

            } catch (error) {
                alert('Error generating PDF: ' + error.message);
                console.error('Generate error:', error);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üìÑ Generate PDF Preview';
            }
        }

        function generatePDFContent(products, layout, options) {
            const container = document.getElementById('pdfContent');
            container.innerHTML = '';
            container.classList.remove('hidden');

            // Create header page
            const headerPage = createHeaderPage();
            container.appendChild(headerPage);

            let pageNumber = 2;

            if (options.groupByCategory) {
                // Sort products by category, then by description
                const sortedProducts = [...products].sort((a, b) => {
                    if (a.category === b.category) {
                        return a.description.localeCompare(b.description);
                    }
                    return a.category.localeCompare(b.category);
                });

                // Group products by category
                const categoryGroups = {};
                sortedProducts.forEach(product => {
                    if (!categoryGroups[product.category]) {
                        categoryGroups[product.category] = [];
                    }
                    categoryGroups[product.category].push(product);
                });

                // Calculate products per page - STRICT LIMIT
                const productsPerPage = layout === 'grid' ? 8 :    // 2√ó4 grid = 8 items
                                      layout === 'compact' ? 18 :   // 3√ó6 grid = 18 items
                                      6; // list layout

                // Process each category
                Object.entries(categoryGroups).forEach(([category, categoryProducts], categoryIndex) => {
                    // Check if we should start a new page for each category
                    const startNewPage = options.newPagePerCategory && categoryIndex > 0;
                    
                    // Split category products into pages
                    for (let i = 0; i < categoryProducts.length; i += productsPerPage) {
                        const pageItems = [];
                        
                        // Add category header only on first page of category
                        if (i === 0) {
                            pageItems.push({ type: 'header', category });
                        }
                        
                        // Add products for this page
                        const pageProducts = categoryProducts.slice(i, i + productsPerPage);
                        pageProducts.forEach(product => {
                            pageItems.push({ type: 'product', ...product });
                        });
                        
                        // Create the page
                        const page = createProductPage(pageItems, layout, options, pageNumber++);
                        if (startNewPage && i === 0) {
                            page.classList.add('force-page-break');
                        }
                        container.appendChild(page);
                    }
                });

            } else {
                // Regular layout without categories - strict 8 per page for grid
                const productsPerPage = layout === 'grid' ? 8 :    // 2√ó4 grid
                                      layout === 'compact' ? 18 :   // 3√ó6 grid
                                      6; // list layout
                
                for (let i = 0; i < products.length; i += productsPerPage) {
                    const pageProducts = products.slice(i, i + productsPerPage);
                    const items = pageProducts.map(product => ({ type: 'product', ...product }));
                    const page = createProductPage(items, layout, options, pageNumber++);
                    container.appendChild(page);
                }
            }

            // Update total pages
            const totalPages = container.querySelectorAll('.print-page').length;
            container.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });

            // Scroll to preview
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Remove the old calculateProductsPerPage function as we're using fixed values now

        function createHeaderPage() {
            const page = document.createElement('div');
            page.className = 'print-page';
            
            page.innerHTML = `
                <div class="page-content">
                    <div class="header-content">
                        <div class="text-center">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ Cash & Carry" 
                                 class="h-24 mx-auto mb-6"
                                 onerror="this.style.display='none'">
                            
                            <div class="bg-red-600 text-white py-6 px-8 rounded-lg mb-8 inline-block">
                                <h1 class="text-4xl font-bold mb-2">üéâ JULY 2025 PROMO üéâ</h1>
                                <p class="text-xl">Exclusive Deals on Premium Home & Kitchen Products</p>
                            </div>

                            <div class="grid grid-cols-2 gap-6 text-left mb-6">
                                <div class="bg-gray-50 p-5 rounded-lg">
                                    <h3 class="text-lg font-bold text-gray-800 mb-3">üè™ OZZ CASH & CARRY</h3>
                                    <p class="text-gray-700 text-sm">
                                        40 Mazeppa & Gull Street<br>
                                        Durban, KwaZulu-Natal 4001<br>
                                        South Africa
                                    </p>
                                </div>
                                <div class="bg-gray-50 p-5 rounded-lg">
                                    <h3 class="text-lg font-bold text-gray-800 mb-3">üè† IKHAYA HOMESTORE</h3>
                                    <p class="text-gray-700 text-sm">
                                        Block D, Shop 88 China City<br>
                                        Springfield Park, Durban<br>
                                        KwaZulu-Natal, South Africa
                                    </p>
                                </div>
                            </div>

                            <div class="bg-blue-50 p-5 rounded-lg mb-6">
                                <h3 class="text-lg font-bold text-blue-800 mb-3">üìû Contact Information</h3>
                                <p class="text-2xl font-bold text-blue-600 mb-2">+27 31 332 7192</p>
                                <p class="text-blue-700 text-sm">
                                    Monday - Friday: 8:00 AM - 5:00 PM<br>
                                    Saturday: 8:00 AM - 1:00 PM
                                </p>
                            </div>

                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-5 text-left">
                                <h4 class="text-lg font-bold text-yellow-800 mb-2">‚è∞ Limited Time Offer</h4>
                                <p class="text-yellow-700 text-sm mb-3">
                                    This promotional catalog features exclusive deals valid for July 2025 only.
                                    All prices are subject to stock availability.
                                </p>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div class="bg-white rounded p-3">
                                        <div class="text-2xl font-bold text-yellow-600">${allProducts.length}</div>
                                        <div class="text-xs text-yellow-700">Categories</div>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <div class="text-2xl font-bold text-yellow-600">20%</div>
                                        <div class="text-xs text-yellow-700">Avg Savings</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="page-footer">
                    <div class="flex items-center">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ" class="footer-logo mr-2">
                        <div>
                            <div class="font-semibold text-xs">OZZ Cash & Carry</div>
                            <div class="text-xs">July 2025 Promotional Catalog</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-xs">Page 1 of <span class="total-pages">-</span></div>
                        <div class="text-xs">www.blackorchid.online</div>
                    </div>
                </div>
            `;
            
            return page;
        }

        function createProductPage(items, layout, options, pageNumber) {
            const page = document.createElement('div');
            page.className = 'print-page';
            
            // Page header
            const pageHeader = `
                <div class="page-header-section">
                    <div class="flex justify-between items-center pb-2 border-b border-gray-300">
                        <div class="flex items-center">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ" class="h-6 mr-2" onerror="this.style.display='none'">
                            <h2 class="text-sm font-bold text-gray-800">July 2025 Promotional Catalog</h2>
                        </div>
                        <span class="text-xs text-gray-600 font-semibold">Page ${pageNumber} of <span class="total-pages">-</span></span>
                    </div>
                </div>
            `;
            
            // Build content
            let content = '<div class="page-content">' + pageHeader;
            content += '<div class="products-container">';
            
            let currentCategory = null;
            let categoryProducts = [];
            
            items.forEach(item => {
                if (item.type === 'header') {
                    // Render previous category's products if any
                    if (categoryProducts.length > 0) {
                        content += renderProductGrid(categoryProducts, layout, options);
                        categoryProducts = [];
                    }
                    // Add category header
                    content += `<div class="category-header">${item.category}</div>`;
                    currentCategory = item.category;
                } else {
                    categoryProducts.push(item);
                }
            });
            
            // Render remaining products
            if (categoryProducts.length > 0) {
                content += renderProductGrid(categoryProducts, layout, options);
            }
            
            content += '</div></div>'; // Close products-container and page-content
            
            // Page footer
            const pageFooter = `
                <div class="page-footer page-footer-products">
                    <div class="disclaimer-text">
                        While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                        Ozz Cash and Carry reserves the right to limit quantities. Errors and omissions excepted - Ozz Cash and Carry will always 
                        take utmost care to ensure that advertising information is correct, however should a mistake or inaccuracy occur, Ozz Cash 
                        and Carry shall display an in-store notice reflecting the correct details. All items include VAT where applicable. 
                        Images are for illustrative purposes only.
                    </div>
                    <div class="footer-main">
                        <div class="flex items-center">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ" class="footer-logo mr-2" onerror="this.style.display='none'">
                            <div>
                                <div class="font-semibold text-xs">OZZ Cash & Carry ‚Ä¢ +27 31 332 7192</div>
                                <div class="text-xs">40 Mazeppa & Gull Street, Durban 4001</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-xs">Limited Time Offer - July 2025</div>
                            <div class="text-xs">www.ozzsa.com</div>
                        </div>
                    </div>
                </div>
            `;
            
            page.innerHTML = content + pageFooter;
            return page;
        }

        function renderProductGrid(products, layout, options) {
            let gridClass = 'product-grid-print ';
            
            if (layout === 'compact') {
                gridClass += 'grid-cols-6-print';
            } else if (layout === 'list') {
                gridClass += 'grid-cols-1-print';
            } else {
                gridClass += 'grid-cols-4-print';
            }
            
            const productsHTML = products.map(product => 
                renderProductCard(product, layout, options)
            ).join('');
            
            // Wrap in products container for even distribution
            return `<div class="${gridClass}">${productsHTML}</div>`;
        }

        function renderProductCard(product, layout, options) {
            const imageUrl = driveImageManager ? driveImageManager.getImageUrl(product.sku) : null;
            const originalPrice = (product.price * 1.2).toFixed(2);
            const savings = (originalPrice - product.price).toFixed(2);
            const savingsPercent = Math.round(((originalPrice - product.price) / originalPrice) * 100);

            if (layout === 'list') {
                return `
                    <div class="product-card-print flex items-center avoid-break">
                        ${options.includeImages ? `
                            <div class="h-16 w-16 mr-3 flex-shrink-0">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" alt="${product.description}" class="product-image">` :
                                    `<div class="w-full h-full image-placeholder rounded flex items-center justify-center">
                                        <span class="text-xs text-gray-500 font-mono">${product.sku}</span>
                                    </div>`
                                }
                            </div>
                        ` : ''}
                        <div class="flex-1 min-w-0">
                            <div class="product-sku">SKU: ${product.sku}</div>
                            <div class="product-description">${product.description}</div>
                            ${options.includePrices ? `
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="product-price">R${product.price.toFixed(2)}</span>
                                    <span class="text-xs text-gray-400 line-through">R${originalPrice}</span>
                                    <span class="text-xs text-green-600 font-bold">SAVE ${savingsPercent}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                const truncateLength = layout === 'compact' ? 40 : 60;
                const displayDescription = product.description.length > truncateLength ? 
                    product.description.substring(0, truncateLength) + '...' : 
                    product.description;

                return `
                    <div class="product-card-print text-center avoid-break">
                        ${options.includeImages ? `
                            <div class="product-image-container-print">
                                ${imageUrl ? 
                                    `<img src="${imageUrl}" alt="${product.description}" class="product-image">` :
                                    `<div class="w-full h-full flex items-center justify-center">
                                        <span class="${layout === 'compact' ? 'text-xs' : 'text-sm'} text-gray-400 font-mono">${product.sku}</span>
                                    </div>`
                                }
                            </div>
                        ` : ''}
                        <div class="flex-1 flex flex-col">
                            <div class="product-sku mb-1">SKU: ${product.sku}</div>
                            <div class="product-description flex-1 ${layout === 'compact' ? 'text-xs' : ''} px-1 mb-2">
                                ${displayDescription}
                            </div>
                            ${options.includePrices ? `
                                <div class="mt-auto pt-2 border-t border-gray-100">
                                    <div class="product-price mb-1">R${product.price.toFixed(2)}</div>
                                    <div class="text-xs text-gray-400 line-through">R${originalPrice}</div>
                                    <div class="text-xs text-green-600 font-bold bg-green-50 rounded px-1 py-0.5 inline-block">
                                        SAVE ${savingsPercent}%
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ PDF Catalog Generator Ready');
            console.log('Place JULY PROMO.xlsx in the same directory as this HTML file');
        });
    </script>
</body>
</html>
