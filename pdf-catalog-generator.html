<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZZ Professional Catalog</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Load Google APIs script dynamically to avoid CSP issues
        function loadGoogleAPIs() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.defer = true;
                
                // Use proper event handlers instead of string evaluation
                script.addEventListener('load', () => {
                    resolve();
                });
                script.addEventListener('error', () => {
                    reject(new Error('Failed to load Google APIs'));
                });
                
                document.head.appendChild(script);
            });
        }
    </script>
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.4;
        }
        
        /* Control Panel */
        .control-panel {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        
        .logo-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-header h1 {
            font-size: 32px;
            color: #1a1a1a;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .logo-header p {
            color: #666;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: #1a1a1a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: #333;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-box {
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
            padding: 15px 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .category-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .category-section h3 {
            margin-bottom: 15px;
            color: #1a1a1a;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .category-item:hover {
            background: #e9ecef;
        }
        
        .category-count {
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }

        .image-status {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            border-radius: 4px;
        }

        .image-status.loading {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .image-status.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        /* Print Preview Container */
        .print-preview {
            max-width: 210mm;
            margin: 20px auto;
        }
        
        /* Print Styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .control-panel {
                display: none;
            }
            
            .page {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 0;
                page-break-after: always;
                page-break-inside: avoid;
                position: relative;
                background: white;
                overflow: hidden;
            }
            
            .page:last-child {
                page-break-after: avoid;
            }
            
            /* Page Layout Structure */
            .page-inner {
                position: absolute;
                top: 15mm;
                left: 15mm;
                right: 15mm;
                bottom: 15mm;
                display: flex;
                flex-direction: column;
            }
            
            /* Page Header */
            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 3mm;
                margin-bottom: 3mm;
                border-bottom: 2px solid #1a1a1a;
                flex-shrink: 0;
            }
            
            .header-left {
                display: flex;
                align-items: center;
                gap: 3mm;
            }
            
            .header-logo {
                height: 8mm;
                width: auto;
            }
            
            .header-title {
                font-size: 12pt;
                font-weight: 700;
                color: #1a1a1a;
            }
            
            .page-number {
                font-size: 10pt;
                color: #666;
                font-weight: 500;
            }
            
            /* Main Content Area */
            .page-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
                margin-bottom: 5mm;
            }
            
            /* Category Header - Premium Style */
            .category-header {
                background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 100%);
                color: white;
                padding: 4mm 6mm;
                margin: 0 -5mm 5mm -5mm;
                font-size: 14pt;
                font-weight: 800;
                letter-spacing: 1px;
                text-transform: uppercase;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                box-shadow: 0 1mm 3mm rgba(0,0,0,0.15);
            }
            
            .category-header::before {
                content: '';
                width: 4mm;
                height: 4mm;
                background: #cc0000;
                margin-right: 4mm;
                display: block;
            }
            
            /* Products Grid Container */
            .products-container {
                flex: 1;
                min-height: 0;
                display: flex;
                align-items: flex-start;
            }
            
            /* Products Grid - Flexible Layout Options */
            .products-grid {
                display: grid;
                grid-template-columns: repeat(var(--grid-columns, 2), 1fr);
                grid-template-rows: repeat(var(--grid-rows, 4), 1fr);
                gap: var(--grid-gap, 4mm);
                width: 100%;
                height: 100%;
            }
            
            /* Compact layout option */
            .products-grid.compact {
                --grid-columns: 3;
                --grid-rows: 4;
                --grid-gap: 3mm;
            }
            
            /* Dense layout option */
            .products-grid.dense {
                --grid-columns: 2;
                --grid-rows: 5;
                --grid-gap: 3mm;
            }
            
            /* Ultra-compact layout option - Enhanced Typography */
            .products-grid.ultra-compact {
                --grid-columns: 3;
                --grid-rows: 5;
                --grid-gap: 2.5mm;
            }
            
            /* Ultra-compact specific adjustments */
            .products-grid.ultra-compact .product-name {
                font-size: 5.5pt;
                font-weight: 900;
                line-height: 1.0;
                margin-bottom: 0.3mm;
                -webkit-line-clamp: 2;
                max-height: 2.4em;
                overflow: hidden;
            }
            
            .products-grid.ultra-compact .product-variant {
                font-size: 4.5pt;
                font-weight: 600;
                line-height: 1.0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .products-grid.ultra-compact .product-header {
                padding: 1mm 1.5mm;
                min-height: 8mm;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .products-grid.ultra-compact .product-specs {
                padding: 1mm;
                gap: 0.2mm;
                justify-content: space-evenly;
            }
            
            .products-grid.ultra-compact .spec-item {
                font-size: 4.5pt;
                margin-bottom: 0.2mm;
                line-height: 0.9;
            }
            
            .products-grid.ultra-compact .spec-label {
                font-size: 4pt;
                min-width: 6mm;
                font-weight: 800;
            }
            
            .products-grid.ultra-compact .spec-value {
                font-size: 4.5pt;
                font-weight: 600;
            }
            
            .products-grid.ultra-compact .spec-bullet {
                font-size: 5pt;
                margin-right: 0.8mm;
            }
            
            .products-grid.ultra-compact .price-badge {
                padding: 1.5mm 1mm;
                min-height: 12mm;
            }
            
            .products-grid.ultra-compact .price-amount {
                font-size: 10pt;
                font-weight: 900;
                margin-bottom: 0.3mm;
                text-shadow: 0 0.5px 1px rgba(0,0,0,0.4);
            }
            
            .products-grid.ultra-compact .price-currency {
                font-size: 7pt;
                font-weight: 800;
            }
            
            .products-grid.ultra-compact .price-cents {
                font-size: 6pt;
                font-weight: 800;
            }
            
            .products-grid.ultra-compact .price-unit {
                font-size: 4.5pt;
                font-weight: 700;
                letter-spacing: 1px;
            }
            
            /* Compact layout adjustments */
            .products-grid.compact .product-name {
                font-size: 6pt;
                line-height: 1.05;
                -webkit-line-clamp: 2;
                max-height: 2.8em;
            }
            
            .products-grid.compact .product-variant {
                font-size: 4.8pt;
                line-height: 1.0;
            }
            
            .products-grid.compact .product-header {
                padding: 1.2mm 1.8mm;
                min-height: 9mm;
            }
            
            .products-grid.compact .product-specs {
                padding: 1.2mm;
            }
            
            .products-grid.compact .spec-item {
                font-size: 5pt;
                margin-bottom: 0.25mm;
            }
            
            .products-grid.compact .spec-label {
                font-size: 4.5pt;
                min-width: 7mm;
            }
            
            .products-grid.compact .price-amount {
                font-size: 11pt;
                margin-bottom: 0.4mm;
            }
            
            .products-grid.compact .price-currency {
                font-size: 7.5pt;
            }
            
            .products-grid.compact .price-cents {
                font-size: 6.5pt;
            }
            
            .products-grid.compact .price-unit {
                font-size: 5pt;
            }
            
            /* Product Card - Enhanced Premium Styling */
            .product-card {
                background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
                display: flex;
                overflow: hidden;
                height: 100%;
                border-radius: 3mm;
                box-shadow: 
                    0 1mm 3mm rgba(0,0,0,0.12),
                    0 0.5mm 2mm rgba(0,0,0,0.08),
                    inset 0 1px 0 rgba(255,255,255,0.3);
                border: 0.5px solid rgba(0,0,0,0.08);
                position: relative;
            }
            
            /* Subtle premium border effect */
            .product-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 0.5mm;
                background: linear-gradient(90deg, #006b6b 0%, #cc0000 50%, #006b6b 100%);
                opacity: 0.6;
            }
            
            /* Product Image - Enhanced Premium Styling */
            .product-image {
                width: 65%;
                background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2mm;
                position: relative;
                border-right: 1px solid rgba(0,0,0,0.06);
                overflow: hidden;
            }
            
            /* Subtle texture overlay for premium feel */
            .product-image::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: 
                    radial-gradient(circle at 20% 20%, rgba(255,255,255,0.3) 1px, transparent 1px),
                    radial-gradient(circle at 80% 80%, rgba(0,0,0,0.02) 1px, transparent 1px);
                background-size: 8px 8px, 12px 12px;
                pointer-events: none;
                z-index: 1;
            }
            
            .product-image img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                filter: 
                    drop-shadow(0 2mm 4mm rgba(0,0,0,0.15))
                    drop-shadow(0 1mm 2mm rgba(0,0,0,0.1));
                border-radius: 1mm;
                position: relative;
                z-index: 2;
                transition: transform 0.3s ease;
            }
            
            /* Subtle hover effect for screen preview */
            @media screen {
                .product-image img:hover {
                    transform: scale(1.02);
                }
            }
            
            .no-image {
                text-align: center;
                color: #bbb;
                padding: 2mm;
                position: relative;
                z-index: 2;
            }
            
            .no-image-icon {
                font-size: 28pt;
                margin-bottom: 2mm;
                opacity: 0.4;
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            
            .no-image-text {
                font-size: 6pt;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                color: #999;
                font-weight: 700;
                text-shadow: 0 0.5px 1px rgba(255,255,255,0.8);
            }
            
            /* Product Details - Compact Right Side (35% width) */
            .product-details {
                width: 35%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Product Header - Enhanced Premium Styling */
            .product-header {
                background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%);
                color: white;
                padding: 1.5mm 2mm;
                flex-shrink: 0;
                position: relative;
                box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
            }
            
            /* Premium metallic accent */
            .product-header::after {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 0.5px;
                background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            }
            
            .product-name {
                font-size: 6.5pt;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 0.2px;
                line-height: 1.1;
                margin-bottom: 0.5mm;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                text-shadow: 0 1px 2px rgba(0,0,0,0.3);
                color: #ffffff;
            }
            
            .product-variant {
                font-size: 5pt;
                font-weight: 600;
                opacity: 0.95;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                color: rgba(255,255,255,0.9);
                text-shadow: 0 0.5px 1px rgba(0,0,0,0.2);
            }
            
            /* Product Specs - Compact Middle Section */
            .product-specs {
                background: white;
                padding: 1.5mm;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                min-height: 0;
            }
            
            .spec-item {
                font-size: 5.5pt;
                color: #333;
                margin-bottom: 0.3mm;
                display: flex;
                align-items: baseline;
                line-height: 1.0;
            }
            
            .spec-item:last-child {
                margin-bottom: 0;
            }
            
            .spec-bullet {
                color: #006b6b;
                font-size: 6pt;
                margin-right: 1mm;
                line-height: 1;
                flex-shrink: 0;
            }
            
            .spec-label {
                font-weight: 700;
                color: #666;
                margin-right: 0.5mm;
                min-width: 8mm;
                flex-shrink: 0;
                font-size: 5pt;
            }
            
            .spec-value {
                color: #1a1a1a;
                font-weight: 500;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex: 1;
            }
            
            /* Price Badge - Enhanced Premium Styling */
            .price-badge {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
                padding: 2mm 1.5mm;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                flex-shrink: 0;
                box-shadow: 
                    inset 0 1px 0 rgba(255,255,255,0.2),
                    inset 0 -1px 0 rgba(0,0,0,0.2);
                position: relative;
            }
            
            /* Premium accent stripe */
            .price-badge::before {
                content: '';
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 80%;
                height: 1px;
                background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            }
            
            .price-amount {
                font-size: 12pt;
                font-weight: 900;
                line-height: 1;
                letter-spacing: -0.3px;
                margin-bottom: 0.5mm;
                text-shadow: 
                    0 1px 2px rgba(0,0,0,0.4),
                    0 0 4px rgba(255,255,255,0.1);
                color: #ffffff;
            }
            
            .price-currency {
                font-size: 8pt;
                font-weight: 800;
                color: #ffffff;
            }
            
            .price-cents {
                font-size: 7pt;
                vertical-align: super;
                font-weight: 800;
                margin-left: 0.3mm;
                color: #ffffff;
            }
            
            .price-unit {
                font-size: 5.5pt;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                opacity: 0.95;
                font-weight: 700;
                color: rgba(255,255,255,0.95);
                text-shadow: 0 0.5px 1px rgba(0,0,0,0.2);
            }
            
            /* Page Footer */
            .page-footer {
                border-top: 1px solid #e0e0e0;
                padding-top: 3mm;
                font-size: 7pt;
                color: #666;
                line-height: 1.4;
                flex-shrink: 0;
            }
            
            .disclaimer {
                margin-bottom: 2mm;
                text-align: justify;
            }
            
            .footer-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 8pt;
            }
            
            .footer-left {
                font-weight: 600;
                color: #333;
            }
            
            .footer-right {
                text-align: right;
            }
            
            /* First Page Special */
            .hero-page .page-inner {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            .hero-content {
                text-align: center;
            }
            
            .hero-logo {
                height: 30mm;
                margin-bottom: 10mm;
            }
            
            /* Hero Page Premium Styling */
            .hero-title {
                font-size: 42pt;
                font-weight: 900;
                color: #cc0000;
                margin-bottom: 5mm;
                letter-spacing: -1.5px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .hero-subtitle {
                font-size: 16pt;
                color: #444;
                margin-bottom: 15mm;
                font-weight: 300;
                letter-spacing: 0.5px;
            }
            
            .info-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 5mm;
                margin: 10mm 0;
            }
            
            .info-card {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                padding: 6mm;
                border-radius: 3mm;
                text-align: center;
                box-shadow: 0 1mm 3mm rgba(0,0,0,0.05);
            }
            
            .info-label {
                font-size: 8pt;
                color: #666;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                margin-bottom: 2mm;
                font-weight: 600;
            }
            
            .info-value {
                font-size: 12pt;
                font-weight: 800;
                color: #1a1a1a;
            }
            
            .address-section {
                background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%);
                color: white;
                padding: 10mm;
                border-radius: 4mm;
                margin: 10mm 0;
                text-align: left;
                box-shadow: 0 2mm 5mm rgba(0,0,0,0.1);
            }
            
            .address-title {
                font-size: 16pt;
                font-weight: 800;
                margin-bottom: 4mm;
                letter-spacing: 0.5px;
            }
            
            .address-section div {
                line-height: 1.6;
                font-size: 11pt;
            }
            
            .collection-notice {
                background: linear-gradient(135deg, #fff8dc 0%, #ffedd5 100%);
                border-left: 5mm solid #ff6b35;
                padding: 6mm 8mm;
                margin: 10mm 0;
                font-size: 10pt;
                border-radius: 0 3mm 3mm 0;
                box-shadow: 0 1mm 3mm rgba(0,0,0,0.08);
            }
            
            .notice-title {
                font-weight: 800;
                margin-bottom: 2mm;
                color: #d84315;
                font-size: 11pt;
            }
        }
        
        @page {
            size: A4;
            margin: 0;
        }
        
        /* Screen Preview Styles */
        @media screen {
            .page {
                background: white;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                margin-bottom: 20px;
                position: relative;
                width: 210mm;
                min-height: 297mm;
            }
            
            .page-inner {
                padding: 15mm;
            }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="logo-header">
            <h1>OZZ Professional Catalog Generator</h1>
            <p>Create beautiful retail-quality promotional catalogs with images</p>
        </div>
        
        <div class="button-group">
            <button onclick="loadCatalog()" id="loadBtn">
                üìÅ Load JULY PROMO.xlsx
            </button>
            <button onclick="initializeImages()" id="imageBtn" disabled>
                üì∏ Initialize Images
            </button>
            <button onclick="generateCatalog()" id="generateBtn" disabled>
                üìÑ Generate Catalog
            </button>
            <button onclick="window.print()" id="printBtn" disabled>
                üñ®Ô∏è Print / Save PDF
            </button>
        </div>
        
        <div id="layoutOptions" class="category-section" style="display: none;">
            <h3>Page Layout Options:</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="standard" checked>
                    <div>
                        <strong>Standard</strong><br>
                        <small>2√ó4 = 8 products/page</small>
                    </div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="compact">
                    <div>
                        <strong>Compact</strong><br>
                        <small>3√ó4 = 12 products/page</small>
                    </div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="dense">
                    <div>
                        <strong>Dense</strong><br>
                        <small>2√ó5 = 10 products/page</small>
                    </div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="ultra-compact">
                    <div>
                        <strong>Ultra Compact</strong><br>
                        <small>3√ó5 = 15 products/page</small>
                    </div>
                </label>
            </div>
        </div>
        
        <div class="status-box" id="status">
            Ready to load catalog data...
        </div>

        <div class="image-status" id="imageStatus" style="display: none;">
            <div id="imageStatusText">üì∏ Image system not initialized</div>
            <div id="imageStats" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>
        
        <div id="categorySection" class="category-section" style="display: none;">
            <h3>Select Categories to Include:</h3>
            <div id="categoryList" class="category-grid"></div>
        </div>
    </div>
    
    <div id="printContent" class="print-preview"></div>

    <script>
        let allProducts = [];
        let categories = [];
        let driveImageManager = null;
        
        // Enhanced Google Drive Image Manager for PDF Generation
        class DriveImageManager {
            constructor() {
                this.imageCache = new Map();
                this.isInitialized = false;
                this.cacheVersion = '1.0';
                this.cacheExpiryHours = 24;
                
                // Your specific folder ID from Google Drive
                this.folderId = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';
                this.apiKey = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
            }

            // Initialize Google Drive API
            async initializeGAPI() {
                if (this.isInitialized) return true;
                
                try {
                    // Load Google APIs dynamically to avoid CSP issues
                    await loadGoogleAPIs();
                    
                    // Load the client library
                    await new Promise(resolve => gapi.load('client', resolve));
                    
                    await gapi.client.init({
                        apiKey: this.apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    
                    this.isInitialized = true;
                    console.log('‚úÖ Google Drive API initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Failed to initialize Google Drive API:', error);
                    return false;
                }
            }

            // Cache management
            getCacheKey(type) {
                return `ozz_pdf_${type}_v${this.cacheVersion}`;
            }

            loadCacheFromStorage() {
                try {
                    console.log('üîç Checking for cached image data...');
                    
                    const cacheMetaKey = this.getCacheKey('meta');
                    const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                    
                    if (!cacheMetaStr) {
                        console.log('üìù No cache found, will perform full scan');
                        return false;
                    }
                    
                    const cacheMeta = JSON.parse(cacheMetaStr);
                    const cacheAge = Date.now() - cacheMeta.timestamp;
                    const maxAge = this.cacheExpiryHours * 60 * 60 * 1000;
                    
                    if (cacheAge > maxAge) {
                        console.log(`‚è∞ Cache expired (${Math.round(cacheAge / (60 * 60 * 1000))} hours old), will refresh`);
                        this.clearCache();
                        return false;
                    }
                    
                    const imageCacheKey = this.getCacheKey('images');
                    const imageCacheStr = localStorage.getItem(imageCacheKey);
                    
                    if (!imageCacheStr) {
                        console.log('üìù Incomplete cache found, will perform full scan');
                        return false;
                    }
                    
                    const imageData = JSON.parse(imageCacheStr);
                    this.imageCache = new Map(Object.entries(imageData));
                    
                    console.log(`‚úÖ Cache loaded successfully! ${this.imageCache.size} images cached`);
                    console.log(`üìä Cache age: ${Math.round(cacheAge / (60 * 1000))} minutes`);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error loading cache:', error);
                    this.clearCache();
                    return false;
                }
            }

            saveCacheToStorage() {
                try {
                    console.log('üíæ Saving image cache to storage...');
                    
                    const cacheMeta = {
                        timestamp: Date.now(),
                        version: this.cacheVersion,
                        totalImages: this.imageCache.size
                    };
                    
                    const cacheMetaKey = this.getCacheKey('meta');
                    localStorage.setItem(cacheMetaKey, JSON.stringify(cacheMeta));
                    
                    const imageData = Object.fromEntries(this.imageCache);
                    const imageCacheKey = this.getCacheKey('images');
                    localStorage.setItem(imageCacheKey, JSON.stringify(imageData));
                    
                    console.log(`‚úÖ Cache saved successfully! ${this.imageCache.size} images cached`);
                } catch (error) {
                    console.error('‚ùå Error saving cache:', error);
                    this.clearCache();
                }
            }

            clearCache() {
                try {
                    const keys = ['meta', 'images'];
                    keys.forEach(key => {
                        localStorage.removeItem(this.getCacheKey(key));
                    });
                    console.log('üóëÔ∏è Cache cleared');
                } catch (error) {
                    console.error('Error clearing cache:', error);
                }
            }

            // Scan folder for images
            async scanFolderForImages(forceRefresh = false) {
                if (!forceRefresh && this.loadCacheFromStorage()) {
                    console.log('üöÄ Using cached image data, skipping scan');
                    return;
                }
                
                console.log('üîç Scanning Google Drive folder for images...');
                
                try {
                    const images = await this.fetchImagesFromFolder();
                    this.buildImageMapping(images);
                    this.saveCacheToStorage();
                    console.log(`üéØ Total images cached: ${this.imageCache.size}`);
                } catch (error) {
                    console.error('‚ùå Error scanning folder:', error);
                    throw error;
                }
            }

            async fetchImagesFromFolder(pageToken = null) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${this.folderId}' in parents and (mimeType contains 'image/jpeg' or mimeType contains 'image/jpg' or mimeType contains 'image/png' or mimeType contains 'image/gif' or mimeType contains 'image/webp' or mimeType contains 'image/bmp' or mimeType contains 'image/tiff')`,
                        fields: 'nextPageToken, files(id, name, mimeType, parents, webViewLink, thumbnailLink)',
                        pageSize: 100,
                        pageToken: pageToken
                    });

                    let files = response.result.files || [];
                    
                    if (response.result.nextPageToken) {
                        const nextPageFiles = await this.fetchImagesFromFolder(response.result.nextPageToken);
                        files = files.concat(nextPageFiles);
                    }
                    
                    return files;
                } catch (error) {
                    console.error('Error fetching folder contents:', error);
                    return [];
                }
            }

            buildImageMapping(images) {
                this.imageCache.clear();
                
                images.forEach(image => {
                    const codes = this.extractProductCodes(image.name);
                    
                    codes.forEach(code => {
                        if (!this.imageCache.has(code)) {
                            this.imageCache.set(code, {
                                id: image.id,
                                name: image.name,
                                thumbnailLink: image.thumbnailLink,
                                webViewLink: image.webViewLink,
                                directLink: this.getDirectImageUrl(image.id),
                                mimeType: image.mimeType
                            });
                        }
                    });
                });
            }

            extractProductCodes(filename) {
                const codes = [];
                const nameWithoutExt = filename.replace(/\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/i, '');
                
                console.log(`üîç Extracting codes from: ${filename}`);
                
                // Find numeric codes (4-6 digits)
                const numericCodes = nameWithoutExt.match(/\b\d{4,6}\b/g);
                if (numericCodes) {
                    codes.push(...numericCodes);
                    console.log(`üìä Found numeric codes: ${numericCodes.join(', ')}`);
                }
                
                // Find alphanumeric codes
                const alphanumericCodes = nameWithoutExt.match(/\b[A-Z0-9]{4,8}\b/gi);
                if (alphanumericCodes) {
                    codes.push(...alphanumericCodes.map(code => code.toLowerCase()));
                    console.log(`üî§ Found alphanumeric codes: ${alphanumericCodes.join(', ')}`);
                }
                
                // Split by delimiters and check each part
                const parts = nameWithoutExt.split(/[-_\s\.]+/);
                parts.forEach(part => {
                    const cleanPart = part.trim();
                    if (/^\d{4,6}$/.test(cleanPart) || /^[A-Z0-9]{4,8}$/i.test(cleanPart)) {
                        codes.push(cleanPart.toLowerCase());
                    }
                });
                
                // Try to extract SKU patterns like "SKU123456" or "PRODUCT123"
                const skuPatterns = nameWithoutExt.match(/(?:sku|product|item|code)[-_\s]*(\d{4,6})/gi);
                if (skuPatterns) {
                    skuPatterns.forEach(pattern => {
                        const match = pattern.match(/(\d{4,6})/);
                        if (match) {
                            codes.push(match[1]);
                            console.log(`üè∑Ô∏è Found SKU pattern: ${match[1]} from ${pattern}`);
                        }
                    });
                }
                
                const uniqueCodes = [...new Set(codes)];
                console.log(`‚úÖ Final codes for ${filename}: ${uniqueCodes.join(', ')}`);
                
                return uniqueCodes;
            }

            getDirectImageUrl(fileId) {
                return `https://lh3.googleusercontent.com/d/${fileId}=w800-h800-c`;
            }

            getProductImage(productCode) {
                const normalizedCode = productCode.toString().toLowerCase().trim();
                const imageData = this.imageCache.get(normalizedCode);
                
                if (imageData) {
                    return {
                        url: imageData.directLink,
                        thumbnail: imageData.thumbnailLink,
                        name: imageData.name,
                        found: true
                    };
                }
                
                return {
                    url: null,
                    thumbnail: null,
                    name: null,
                    found: false
                };
            }

            getStats() {
                const cacheMetaKey = this.getCacheKey('meta');
                const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                let cacheInfo = null;
                
                if (cacheMetaStr) {
                    try {
                        const cacheMeta = JSON.parse(cacheMetaStr);
                        const cacheAge = Date.now() - cacheMeta.timestamp;
                        cacheInfo = {
                            age: Math.round(cacheAge / (60 * 1000)),
                            timestamp: new Date(cacheMeta.timestamp).toLocaleString()
                        };
                    } catch (error) {
                        console.warn('Could not parse cache metadata');
                    }
                }
                
                return {
                    mappedProducts: this.imageCache.size,
                    cacheInfo: cacheInfo
                };
            }
        }
        
        async function loadCatalog() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            
            loadBtn.disabled = true;
            status.innerHTML = '‚è≥ Loading Excel file...';
            
            try {
                const response = await fetch('./JULY PROMO.xlsx');
                if (!response.ok) {
                    throw new Error('Could not find JULY PROMO.xlsx in the same folder');
                }
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Process products - Updated for correct column names
                allProducts = jsonData
                    .filter(row => row.SKU && row['PRODUCT '] && row.PRICE && row.CATEGORY)
                    .map(row => ({
                        sku: String(row.SKU).trim(),
                        description: String(row['PRODUCT '] || row.PRODUCT || '').trim(),
                        price: parseFloat(row.PRICE) || 0,
                        category: String(row.CATEGORY).trim().toUpperCase()
                    }))
                    .filter(p => p.price > 0);
                
                // Get categories
                categories = [...new Set(allProducts.map(p => p.category))].sort();
                
                // Show categories and layout options
                showCategories();
                document.getElementById('layoutOptions').style.display = 'block';
                
                document.getElementById('imageBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;
                status.innerHTML = `‚úÖ <strong>Loaded ${allProducts.length} products in ${categories.length} categories</strong>`;
                
            } catch (error) {
                status.innerHTML = `‚ùå <strong style="color: #dc3545;">Error: ${error.message}</strong>`;
                console.error(error);
            } finally {
                loadBtn.disabled = false;
            }
        }

        async function initializeImages() {
            const imageBtn = document.getElementById('imageBtn');
            const imageStatus = document.getElementById('imageStatus');
            const imageStatusText = document.getElementById('imageStatusText');
            const imageStats = document.getElementById('imageStats');
            
            imageBtn.disabled = true;
            imageBtn.innerHTML = '‚è≥ Initializing...';
            imageStatus.style.display = 'block';
            imageStatus.className = 'image-status loading';
            imageStatusText.innerHTML = 'üîÑ Initializing Google Drive API...';
            
            try {
                // Initialize the image manager
                driveImageManager = new DriveImageManager();
                
                // Initialize Google Drive API
                const success = await driveImageManager.initializeGAPI();
                if (!success) {
                    throw new Error('Failed to initialize Google Drive API');
                }
                
                imageStatusText.innerHTML = 'üì∏ Scanning Google Drive for product images...';
                
                // Scan for images
                await driveImageManager.scanFolderForImages();
                
                // Update UI with success
                const stats = driveImageManager.getStats();
                imageStatus.className = 'image-status';
                imageStatusText.innerHTML = `‚úÖ Image system ready! Found ${stats.mappedProducts} product images`;
                
                if (stats.cacheInfo) {
                    imageStats.innerHTML = `Cache: ${stats.cacheInfo.age} minutes old ‚Ä¢ Last updated: ${stats.cacheInfo.timestamp}`;
                } else {
                    imageStats.innerHTML = 'Images freshly loaded from Google Drive';
                }
                
                imageBtn.innerHTML = '‚úÖ Images Ready';
                
                // Show image mapping preview
                showImageMappingPreview();
                
            } catch (error) {
                console.error('Image initialization failed:', error);
                imageStatus.className = 'image-status error';
                imageStatusText.innerHTML = `‚ùå Image system failed: ${error.message}`;
                imageStats.innerHTML = 'Catalog will be generated without images';
                imageBtn.innerHTML = '‚ùå Image Failed';
            } finally {
                imageBtn.disabled = false;
            }
        }

        function showImageMappingPreview() {
            if (!driveImageManager) return;
            
            let mappedCount = 0;
            let unmappedProducts = [];
            
            allProducts.forEach(product => {
                const imageData = driveImageManager.getProductImage(product.sku);
                if (imageData.found) {
                    mappedCount++;
                } else {
                    unmappedProducts.push(product.sku);
                }
            });
            
            const imageStats = document.getElementById('imageStats');
            const mappingInfo = `
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Image Mapping Results:</strong><br>
                    ‚Ä¢ ${mappedCount} products with images<br>
                    ‚Ä¢ ${unmappedProducts.length} products without images<br>
                    ${unmappedProducts.length > 0 ? `<details style="margin-top: 5px;"><summary style="cursor: pointer;">View unmapped SKUs</summary><div style="font-family: monospace; font-size: 12px; margin-top: 5px;">${unmappedProducts.slice(0, 10).join(', ')}${unmappedProducts.length > 10 ? ` and ${unmappedProducts.length - 10} more...` : ''}</div></details>` : ''}
                </div>
            `;
            
            imageStats.innerHTML += mappingInfo;
        }
        
        function showCategories() {
            const section = document.getElementById('categorySection');
            const list = document.getElementById('categoryList');
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            categories.forEach(cat => {
                const count = allProducts.filter(p => p.category === cat).length;
                const item = document.createElement('label');
                item.className = 'category-item';
                item.innerHTML = `
                    <input type="checkbox" checked value="${cat}" class="category-cb">
                    <span>${cat}</span>
                    <span class="category-count">${count} items</span>
                `;
                list.appendChild(item);
            });
        }

        function getImageUrl(sku) {
            if (!driveImageManager) {
                return null; // No image system initialized
            }
            
            const imageData = driveImageManager.getProductImage(sku);
            return imageData.found ? imageData.url : null;
        }
        
        function generateCatalog() {
            const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked'))
                .map(cb => cb.value);
            
            if (selectedCats.length === 0) {
                alert('Please select at least one category');
                return;
            }
            
            // Get selected layout
            const selectedLayout = document.querySelector('input[name="layout"]:checked').value;
            const layoutConfig = getLayoutConfig(selectedLayout);
            
            const filteredProducts = allProducts.filter(p => selectedCats.includes(p.category));
            
            // Sort by category then description
            filteredProducts.sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return a.description.localeCompare(b.description);
            });
            
            // Generate pages
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = '';
            
            // Add header page
            printContent.appendChild(createHeaderPage());
            
            // Group by category
            const grouped = {};
            filteredProducts.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });
            
            // Create product pages with selected layout
            let pageNum = 2;
            Object.entries(grouped).forEach(([category, products]) => {
                // Each category starts on a new page
                for (let i = 0; i < products.length; i += layoutConfig.productsPerPage) {
                    const pageProducts = products.slice(i, i + layoutConfig.productsPerPage);
                    const showCategoryHeader = i === 0;
                    printContent.appendChild(createProductPage(pageProducts, category, showCategoryHeader, pageNum++, layoutConfig));
                }
            });
            
            // Update page numbers
            const totalPages = printContent.querySelectorAll('.page').length;
            printContent.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });
            
            document.getElementById('printBtn').disabled = false;
            
            // Update status with image and layout information
            let imageInfo = '';
            if (driveImageManager) {
                const stats = driveImageManager.getStats();
                let mappedCount = 0;
                filteredProducts.forEach(product => {
                    const imageData = driveImageManager.getProductImage(product.sku);
                    if (imageData.found) mappedCount++;
                });
                imageInfo = ` (${mappedCount} with images)`;
            }
            
            document.getElementById('status').innerHTML = 
                `‚úÖ <strong>Generated ${totalPages} pages with ${filteredProducts.length} products${imageInfo} using ${selectedLayout} layout</strong>`;
            
            // Scroll to preview
            printContent.scrollIntoView({ behavior: 'smooth' });
        }

        function getLayoutConfig(layout) {
            const configs = {
                'standard': { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 },
                'compact': { productsPerPage: 12, gridClass: 'compact', columns: 3, rows: 4 },
                'dense': { productsPerPage: 10, gridClass: 'dense', columns: 2, rows: 5 },
                'ultra-compact': { productsPerPage: 15, gridClass: 'ultra-compact', columns: 3, rows: 5 }
            };
            return configs[layout] || configs['standard'];
        }
        
        function createHeaderPage() {
            const page = document.createElement('div');
            page.className = 'page hero-page';
            
            page.innerHTML = `
                <div class="page-inner">
                    <div class="hero-content">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ Cash & Carry" 
                             class="hero-logo"
                             onerror="this.style.display='none'">
                        
                        <h1 class="hero-title">JULY 2025 PROMO</h1>
                        <p class="hero-subtitle">Exclusive Deals on Premium Home & Kitchen Products</p>
                        
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-label">Phone</div>
                                <div class="info-value">+27 31 332 7192</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Email</div>
                                <div class="info-value">info@ozzsa.com</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Website</div>
                                <div class="info-value">www.ozzsa.com</div>
                            </div>
                        </div>
                        
                        <div class="address-section">
                            <div class="address-title">OZZ CASH & CARRY</div>
                            <div>40 Mazeppa & Gull Street</div>
                            <div>Durban, KwaZulu-Natal 4001</div>
                            <div>South Africa</div>
                            <div style="margin-top: 3mm;">
                                <strong>Hours:</strong> Mon-Fri: 8AM-5PM | Sat: 8AM-1PM
                            </div>
                        </div>
                        
                        <div class="collection-notice">
                            <div class="notice-title">üìç COLLECTION & DELIVERY</div>
                            <div>Promotional prices are valid for collection only at 40 Mazeppa Street, Durban.</div>
                            <div>Delivery is available at an additional charge.</div>
                        </div>
                    </div>
                    
                    <div class="page-footer">
                        <div class="disclaimer">
                            While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                            Ozz Cash and Carry reserves the right to limit quantities. Errors and omissions excepted - Ozz Cash and Carry will always 
                            take utmost care to ensure that advertising information is correct, however should a mistake or inaccuracy occur, Ozz Cash 
                            and Carry shall display an in-store notice reflecting the correct details. All items include VAT where applicable. 
                            Images are for illustrative purposes only.
                        </div>
                        <div class="footer-info">
                            <span class="footer-left">OZZ Cash & Carry ‚Ä¢ July 2025 Catalog</span>
                            <span class="footer-right">Page 1 of <span class="total-pages">-</span> ‚Ä¢ Version 3.0</span>
                        </div>
                    </div>
                </div>
            `;
            
            return page;
        }
        
        function createProductPage(products, category, showHeader, pageNum, layoutConfig = { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 }) {
            const page = document.createElement('div');
            page.className = 'page';
            
            let contentHTML = `
                <div class="page-inner">
                    <div class="page-header">
                        <div class="header-left">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ" class="header-logo" onerror="this.style.display='none'">
                            <span class="header-title">July 2025 Promotional Catalog</span>
                        </div>
                        <span class="page-number">Page ${pageNum} of <span class="total-pages">-</span></span>
                    </div>
                    
                    <div class="page-content">
            `;
            
            if (showHeader) {
                contentHTML += `<div class="category-header">${category}</div>`;
            }
            
            contentHTML += `<div class="products-container"><div class="products-grid ${layoutConfig.gridClass}">`;
            
            // Create slots for the selected layout
            for (let i = 0; i < layoutConfig.productsPerPage; i++) {
                if (i < products.length) {
                    contentHTML += createProductCard(products[i]);
                } else {
                    contentHTML += '<div class="product-card" style="visibility: hidden;"></div>';
                }
            }
            
            contentHTML += `
                        </div></div>
                    </div>
                    
                    <div class="page-footer">
                        <div class="disclaimer">
                            While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                            Ozz Cash and Carry reserves the right to limit quantities. Errors and omissions excepted - Ozz Cash and Carry will always 
                            take utmost care to ensure that advertising information is correct, however should a mistake or inaccuracy occur, Ozz Cash 
                            and Carry shall display an in-store notice reflecting the correct details. All items include VAT where applicable. 
                            Images are for illustrative purposes only.
                        </div>
                        <div class="footer-info">
                            <span class="footer-left">OZZ Cash & Carry ‚Ä¢ +27 31 332 7192 ‚Ä¢ info@ozzsa.com</span>
                            <span class="footer-right">www.ozzsa.com ‚Ä¢ Version 3.0</span>
                        </div>
                    </div>
                </div>
            `;
            
            page.innerHTML = contentHTML;
            return page;
        }
        
        function createProductCard(product) {
            const imageUrl = getImageUrl(product.sku);
            const originalPrice = (product.price * 1.2).toFixed(2);
            const savePercent = Math.round(((originalPrice - product.price) / originalPrice) * 100);
            
            // Split price into rands and cents
            const priceStr = product.price.toFixed(2);
            const [rands, cents] = priceStr.split('.');
            
            // Extract product name and variant from description
            const descWords = product.description.split(' ');
            let productName = '';
            let productVariant = '';
            
            // Simple logic to split name and variant
            if (descWords.length > 2) {
                productName = descWords.slice(0, 2).join(' ');
                productVariant = descWords.slice(2).join(' ');
            } else {
                productName = product.description;
                productVariant = product.category;
            }
            
            return `
                <div class="product-card">
                    <div class="product-image">
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${product.description}">` :
                            `<div class="no-image">
                                <div class="no-image-icon">üì¶</div>
                                <div class="no-image-text">SKU: ${product.sku}</div>
                            </div>`
                        }
                    </div>
                    <div class="product-details">
                        <div class="product-header">
                            <div class="product-name">${productName}</div>
                            <div class="product-variant">${productVariant}</div>
                        </div>
                        <div class="product-specs">
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value">${product.sku}</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">Category:</span>
                                <span class="spec-value">${product.category}</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">Price:</span>
                                <span class="spec-value">R${originalPrice} RRP</span>
                            </div>
                            ${savePercent > 0 ? `
                                <div class="spec-item">
                                    <span class="spec-bullet">‚Ä¢</span>
                                    <span class="spec-label">Savings:</span>
                                    <span class="spec-value">${savePercent}% OFF</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="price-badge">
                            <div class="price-amount">
                                <span class="price-currency">R</span>${rands}<span class="price-cents">${cents}</span>
                            </div>
                            <div class="price-unit">Each</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add a refresh images function for the PDF generator
        async function refreshImages() {
            if (!driveImageManager) {
                await initializeImages();
                return;
            }
            
            const imageBtn = document.getElementById('imageBtn');
            const imageStatusText = document.getElementById('imageStatusText');
            
            imageBtn.disabled = true;
            imageBtn.innerHTML = 'üîÑ Refreshing...';
            imageStatusText.innerHTML = 'üîÑ Refreshing image cache...';
            
            try {
                await driveImageManager.scanFolderForImages(true); // Force refresh
                
                const stats = driveImageManager.getStats();
                imageStatusText.innerHTML = `‚úÖ Images refreshed! Found ${stats.mappedProducts} product images`;
                imageBtn.innerHTML = '‚úÖ Images Ready';
                
                showImageMappingPreview();
                
            } catch (error) {
                console.error('Image refresh failed:', error);
                imageStatusText.innerHTML = `‚ùå Refresh failed: ${error.message}`;
                imageBtn.innerHTML = '‚ùå Refresh Failed';
            } finally {
                imageBtn.disabled = false;
            }
        }

        // Add refresh button to the UI
        document.addEventListener('DOMContentLoaded', function() {
            // Add refresh button after image button
            const buttonGroup = document.querySelector('.button-group');
            const refreshBtn = document.createElement('button');
            refreshBtn.onclick = refreshImages;
            refreshBtn.innerHTML = 'üîÑ Refresh Images';
            refreshBtn.id = 'refreshImagesBtn';
            refreshBtn.disabled = true;
            
            // Insert after image button
            const imageBtn = document.getElementById('imageBtn');
            buttonGroup.insertBefore(refreshBtn, imageBtn.nextSibling);
            
            // Enable refresh button when images are initialized
            const originalInitialize = initializeImages;
            initializeImages = async function() {
                await originalInitialize();
                refreshBtn.disabled = false;
            };
        });

        console.log('üéâ OZZ Professional Catalog Generator with Images Loaded');
        console.log('üì∏ Image integration ready - initialize images after loading products');
    </script>
</body>
</html>
