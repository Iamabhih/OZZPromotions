<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OZZ Professional Catalog Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f0f2f5; color: #1a1a1a; line-height: 1.4; }
        .control-panel { max-width: 900px; margin: 20px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07); }
        .logo-header { text-align: center; margin-bottom: 30px; }
        .logo-header h1 { font-size: 32px; color: #1a1a1a; font-weight: 700; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin: 30px 0; flex-wrap: wrap; }
        button { background: #1a1a1a; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        button:hover { background: #333; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status-box { background: #f8f9fa; border-left: 4px solid #0066cc; padding: 15px 20px; border-radius: 4px; margin: 20px 0; }
        .category-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .category-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px; cursor: pointer; }
        .image-status { margin-top: 20px; padding: 15px; background: #e8f5e8; border-left: 4px solid #28a745; border-radius: 4px; }
        .image-status.loading { background: #fff3cd; border-color: #ffc107; }
        .image-status.error { background: #f8d7da; border-color: #dc3545; }
        
        @media print {
            .control-panel { display: none; }
            .page { width: 210mm; height: 297mm; margin: 0; padding: 0; page-break-after: always; background: white; overflow: hidden; }
            .page-inner { position: absolute; top: 15mm; left: 15mm; right: 15mm; bottom: 15mm; display: flex; flex-direction: column; }
            .page-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 3mm; margin-bottom: 3mm; border-bottom: 2px solid #1a1a1a; }
            .header-logo { height: 8mm; width: auto; }
            .header-title { font-size: 12pt; font-weight: 700; color: #1a1a1a; }
            .page-content { flex: 1; display: flex; flex-direction: column; min-height: 0; margin-bottom: 5mm; }
            .category-header { background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 4mm 6mm; margin: 0 -5mm 5mm -5mm; font-size: 14pt; font-weight: 800; text-transform: uppercase; }
            .products-grid { display: grid; grid-template-columns: repeat(var(--grid-columns, 2), 1fr); grid-template-rows: repeat(var(--grid-rows, 4), 1fr); gap: var(--grid-gap, 4mm); width: 100%; height: 100%; }
            .products-grid.compact { --grid-columns: 3; --grid-rows: 4; --grid-gap: 3mm; }
            .products-grid.ultra-compact { --grid-columns: 3; --grid-rows: 5; --grid-gap: 2.5mm; }
            .product-card { background: white; display: flex; overflow: hidden; height: 100%; border-radius: 3mm; box-shadow: 0 1mm 3mm rgba(0,0,0,0.12); border: 0.5px solid rgba(0,0,0,0.08); }
            .product-image { width: 65%; background: #fafafa; display: flex; align-items: center; justify-content: center; padding: 2mm; border-right: 1px solid rgba(0,0,0,0.06); }
            .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 1mm 2mm rgba(0,0,0,0.15)); }
            .no-image { text-align: center; color: #bbb; padding: 2mm; }
            .no-image-icon { font-size: 28pt; margin-bottom: 2mm; opacity: 0.4; }
            .no-image-text { font-size: 6pt; text-transform: uppercase; color: #999; font-weight: 700; }
            .product-details { width: 35%; display: flex; flex-direction: column; overflow: hidden; }
            .product-header { background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%); color: white; padding: 1.5mm 2mm; }
            .product-name { font-size: 6.5pt; font-weight: 900; text-transform: uppercase; line-height: 1.1; margin-bottom: 0.5mm; overflow: hidden; color: #ffffff; }
            .product-variant { font-size: 5pt; font-weight: 600; text-transform: uppercase; overflow: hidden; color: rgba(255,255,255,0.9); }
            .product-specs { background: white; padding: 1.5mm; flex: 1; display: flex; flex-direction: column; justify-content: space-around; }
            .spec-item { font-size: 5.5pt; color: #333; margin-bottom: 0.3mm; display: flex; align-items: baseline; line-height: 1.0; }
            .spec-bullet { color: #006b6b; font-size: 6pt; margin-right: 1mm; }
            .spec-label { font-weight: 700; color: #666; margin-right: 0.5mm; min-width: 8mm; font-size: 5pt; }
            .spec-value { color: #1a1a1a; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
            .price-badge { background: linear-gradient(135deg, #cc0000 0%, #990000 100%); color: white; padding: 2mm 1.5mm; text-align: center; display: flex; flex-direction: column; justify-content: center; }
            .price-amount { font-size: 12pt; font-weight: 900; line-height: 1; margin-bottom: 0.5mm; color: #ffffff; }
            .price-currency { font-size: 8pt; font-weight: 800; }
            .price-cents { font-size: 7pt; vertical-align: super; font-weight: 800; }
            .price-unit { font-size: 5.5pt; text-transform: uppercase; font-weight: 700; }
            .page-footer { border-top: 1px solid #e0e0e0; padding-top: 3mm; font-size: 7pt; color: #666; line-height: 1.4; }
            .footer-info { display: flex; justify-content: space-between; align-items: center; font-size: 8pt; }
            .hero-title { font-size: 42pt; font-weight: 900; color: #cc0000; margin-bottom: 5mm; }
            .hero-subtitle { font-size: 16pt; color: #444; margin-bottom: 15mm; font-weight: 300; }
            .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5mm; margin: 10mm 0; }
            .info-card { background: #f8f9fa; padding: 6mm; border-radius: 3mm; text-align: center; }
            .address-section { background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%); color: white; padding: 10mm; border-radius: 4mm; margin: 10mm 0; }
        }
        @page { size: A4; margin: 0; }
        @media screen {
            .page { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; width: 210mm; min-height: 297mm; }
            .page-inner { padding: 15mm; }
        }
    </style>
</head>

<body>
    <div class="control-panel">
        <div class="logo-header">
            <h1>OZZ Professional Catalog Generator</h1>
            <p>Create beautiful retail-quality promotional catalogs with images</p>
        </div>
        
        <div class="button-group">
            <button onclick="loadCatalog()" id="loadBtn">üìÅ Load JULY PROMO.xlsx</button>
            <button onclick="initializeImages()" id="imageBtn" disabled>üì∏ Initialize Images</button>
            <button onclick="generateCatalog()" id="generateBtn" disabled>üìÑ Generate Catalog</button>
            <button onclick="window.print()" id="printBtn" disabled>üñ®Ô∏è Print / Save PDF</button>
        </div>
        
        <div class="status-box" id="status">Ready to load catalog data...</div>
        <div class="image-status" id="imageStatus" style="display: none;">
            <div id="imageStatusText">üì∏ Image system not initialized</div>
            <div id="imageStats" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>

        <div id="customizationPanel" class="category-section" style="display: none;">
            <h3>üé® Catalog Customization</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üé® Color Scheme</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        Header Color:
                        <input type="color" id="headerColor" value="#006b6b" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Price Color:
                        <input type="color" id="priceColor" value="#cc0000" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Accent Color:
                        <input type="color" id="accentColor" value="#1a1a1a" style="width: 100%; height: 30px; margin-top: 4px;">
                    </label>
                    <button onclick="applyColorScheme()" style="width: 100%; margin-top: 8px; background: #28a745; color: white;">Apply Colors</button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üìù Typography</h4>
                    <label style="display: block; margin-bottom: 8px;">
                        Font Family:
                        <select id="fontFamily" style="width: 100%; padding: 4px; margin-top: 4px;">
                            <option value="system">System Default</option>
                            <option value="arial">Arial</option>
                            <option value="helvetica">Helvetica</option>
                            <option value="times">Times New Roman</option>
                            <option value="georgia">Georgia</option>
                        </select>
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        Text Style:
                        <select id="textStyle" style="width: 100%; padding: 4px; margin-top: 4px;">
                            <option value="uppercase" selected>UPPERCASE</option>
                            <option value="capitalize">Capitalize</option>
                            <option value="normal">Normal</option>
                        </select>
                    </label>
                    <button onclick="applyTypography()" style="width: 100%; margin-top: 8px; background: #007bff; color: white;">Apply Typography</button>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 10px; color: #333;">üé≠ Preset Themes</h4>
                    <button onclick="applyTheme('ozz-classic')" style="width: 100%; margin-bottom: 8px; background: #006b6b; color: white;">OZZ Classic</button>
                    <button onclick="applyTheme('modern-blue')" style="width: 100%; margin-bottom: 8px; background: #0056b3; color: white;">Modern Blue</button>
                    <button onclick="applyTheme('elegant-black')" style="width: 100%; margin-bottom: 8px; background: #2c3e50; color: white;">Elegant Black</button>
                    <button onclick="resetToDefault()" style="width: 100%; background: #6c757d; color: white;">Reset to Default</button>
                </div>
            </div>
        </div>

        <div id="introPageCustomization" class="category-section" style="display: none;">
            <h3>üìÑ Introduction Page Content</h3>
            <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd;">
                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                    Customize the content that appears on the second page of your catalog.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Page Title:
                            <input type="text" id="introTitle" value="Welcome to Our July 2025 Promotion" 
                                   style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Subtitle:
                            <input type="text" id="introSubtitle" value="Exclusive deals on premium home & kitchen products" 
                                   style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Special Message:
                            <textarea id="introMessage" rows="4" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">Thank you for choosing OZZ Cash & Carry for your home and kitchen needs. This July, we're offering exceptional deals on premium products to help you create the perfect living space.</textarea>
                        </label>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Promotion Details:
                            <textarea id="promoDetails" rows="3" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">‚Ä¢ Valid for July 2025 only
‚Ä¢ Limited quantities available
‚Ä¢ Collection only at our Durban store
‚Ä¢ Delivery available at additional cost</textarea>
                        </label>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Additional Information:
                            <textarea id="additionalInfo" rows="3" 
                                      style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px;">Store Hours:
Monday - Friday: 8:00 AM - 5:00 PM
Saturday: 8:00 AM - 1:00 PM
Sunday: Closed

Visit our showroom to see the full range!</textarea>
                        </label>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="includeIntroPage" checked style="margin-right: 8px;">
                        <span style="font-weight: bold;">Include introduction page in catalog</span>
                    </label>
                    <button onclick="previewIntroPage()" style="background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
                        üìã Preview Introduction Page
                    </button>
                    <button onclick="resetIntroPage()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px;">
                        üîÑ Reset to Default
                    </button>
                </div>
            </div>
        </div>
        
        <div id="layoutOptions" class="category-section" style="display: none;">
            <h3>üìê Page Layout Options:</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="standard" checked>
                    <div><strong>Standard</strong><br><small>2√ó4 = 8 products/page</small></div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="compact">
                    <div><strong>Compact</strong><br><small>3√ó4 = 12 products/page</small></div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="dense">
                    <div><strong>Dense</strong><br><small>2√ó5 = 10 products/page</small></div>
                </label>
                <label class="category-item" style="border: 2px solid #ddd; border-radius: 8px; padding: 12px;">
                    <input type="radio" name="layout" value="ultra-compact">
                    <div><strong>Ultra Compact</strong><br><small>3√ó5 = 15 products/page</small></div>
                </label>
            </div>
        </div>
        
        <div id="categorySection" class="category-section" style="display: none;">
            <h3>Select Categories to Include:</h3>
            <div id="categoryList" class="category-grid"></div>
        </div>
    </div>
    
    <div id="printContent" class="print-preview"></div>

    <script>
        let allProducts = [];
        let categories = [];
        let driveImageManager = null;
        // CSP-Safe Image Manager with Enhanced Progress Tracking
        class DriveImageManager {
            constructor() {
                this.imageCache = new Map();
                this.isInitialized = false;
                this.cacheVersion = '1.0';
                this.cacheExpiryHours = 24;
                this.folderId = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';
                this.apiKey = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
                this.progressCallback = null;
            }

            async initializeGAPI() {
                if (this.isInitialized) return true;
                try {
                    this.updateProgress('Loading Google APIs...');
                    await this.loadGoogleAPISafe();
                    this.updateProgress('Initializing Drive client...');
                    await this.initializeClient();
                    this.isInitialized = true;
                    console.log('‚úÖ Google Drive API initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Failed to initialize Google Drive API:', error);
                    this.updateProgress(`‚ùå API Error: ${error.message}`);
                    return false;
                }
            }

            async loadGoogleAPISafe() {
                if (window.gapi) return;
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.async = true;
                    script.defer = true;
                    script.addEventListener('load', resolve);
                    script.addEventListener('error', () => reject(new Error('Failed to load Google APIs')));
                    document.head.appendChild(script);
                });
            }

            async initializeClient() {
                return new Promise((resolve, reject) => {
                    const loadCallback = () => {
                        gapi.client.init({
                            apiKey: this.apiKey,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                        }).then(resolve).catch(reject);
                    };
                    gapi.load('client', { callback: loadCallback, onerror: () => reject(new Error('Failed to load GAPI client')) });
                });
            }

            updateProgress(message) {
                console.log(`üìä ${message}`);
                if (this.progressCallback) this.progressCallback(message);
            }

            setProgressCallback(callback) {
                this.progressCallback = callback;
            }

            getCacheKey(type) {
                return `ozz_pdf_${type}_v${this.cacheVersion}`;
            }

            loadCacheFromStorage() {
                try {
                    const cacheMetaKey = this.getCacheKey('meta');
                    const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                    if (!cacheMetaStr) return false;
                    
                    const cacheMeta = JSON.parse(cacheMetaStr);
                    const cacheAge = Date.now() - cacheMeta.timestamp;
                    const maxAge = this.cacheExpiryHours * 60 * 60 * 1000;
                    if (cacheAge > maxAge) {
                        this.clearCache();
                        return false;
                    }
                    
                    const imageCacheKey = this.getCacheKey('images');
                    const imageCacheStr = localStorage.getItem(imageCacheKey);
                    if (!imageCacheStr) return false;
                    
                    const imageData = JSON.parse(imageCacheStr);
                    this.imageCache = new Map(Object.entries(imageData));
                    console.log(`‚úÖ Cache loaded: ${this.imageCache.size} images`);
                    return true;
                } catch (error) {
                    console.error('‚ùå Error loading cache:', error);
                    this.clearCache();
                    return false;
                }
            }

            saveCacheToStorage() {
                try {
                    const cacheMeta = { timestamp: Date.now(), version: this.cacheVersion, totalImages: this.imageCache.size };
                    localStorage.setItem(this.getCacheKey('meta'), JSON.stringify(cacheMeta));
                    const imageData = Object.fromEntries(this.imageCache);
                    localStorage.setItem(this.getCacheKey('images'), JSON.stringify(imageData));
                    console.log(`‚úÖ Cache saved: ${this.imageCache.size} images`);
                } catch (error) {
                    console.error('‚ùå Error saving cache:', error);
                }
            }

            clearCache() {
                ['meta', 'images'].forEach(key => localStorage.removeItem(this.getCacheKey(key)));
            }

            async scanFolderForImages(forceRefresh = false) {
                if (!forceRefresh && this.loadCacheFromStorage()) {
                    this.updateProgress('‚úÖ Using cached images');
                    return;
                }
                
                this.updateProgress('üîç Scanning Google Drive...');
                try {
                    const images = await this.fetchImagesFromFolder();
                    if (images.length === 0) {
                        this.updateProgress('‚ö†Ô∏è No images found');
                        return;
                    }
                    this.updateProgress(`üì∏ Processing ${images.length} images...`);
                    this.buildImageMapping(images);
                    this.saveCacheToStorage();
                    this.updateProgress(`‚úÖ Mapped ${this.imageCache.size} images`);
                } catch (error) {
                    console.error('‚ùå Error scanning folder:', error);
                    throw error;
                }
            }

            async fetchImagesFromFolder(pageToken = null, allFiles = []) {
                try {
                    const response = await gapi.client.drive.files.list({
                        q: `'${this.folderId}' in parents and (mimeType contains 'image/jpeg' or mimeType contains 'image/png' or mimeType contains 'image/gif')`,
                        fields: 'nextPageToken, files(id, name, mimeType)',
                        pageSize: 100,
                        pageToken: pageToken
                    });
                    const files = response.result.files || [];
                    allFiles.push(...files);
                    if (response.result.nextPageToken) {
                        return await this.fetchImagesFromFolder(response.result.nextPageToken, allFiles);
                    }
                    return allFiles;
                } catch (error) {
                    console.error('Error fetching files:', error);
                    return [];
                }
            }

            buildImageMapping(images) {
                this.imageCache.clear();
                images.forEach(image => {
                    const codes = this.extractProductCodes(image.name);
                    codes.forEach(code => {
                        if (!this.imageCache.has(code)) {
                            this.imageCache.set(code, {
                                id: image.id,
                                name: image.name,
                                directLink: `https://lh3.googleusercontent.com/d/${image.id}=w800-h800-c`
                            });
                        }
                    });
                });
            }

            extractProductCodes(filename) {
                const codes = [];
                const nameWithoutExt = filename.replace(/\.(jpg|jpeg|png|gif|webp|bmp|tiff)$/i, '');
                const numericCodes = nameWithoutExt.match(/\b\d{4,6}\b/g);
                if (numericCodes) codes.push(...numericCodes);
                const alphanumericCodes = nameWithoutExt.match(/\b[A-Z0-9]{4,8}\b/gi);
                if (alphanumericCodes) codes.push(...alphanumericCodes.map(code => code.toLowerCase()));
                const parts = nameWithoutExt.split(/[-_\s\.]+/);
                parts.forEach(part => {
                    const cleanPart = part.trim();
                    if (/^\d{4,6}$/.test(cleanPart) || /^[A-Z0-9]{4,8}$/i.test(cleanPart)) {
                        codes.push(cleanPart.toLowerCase());
                    }
                });
                return [...new Set(codes)];
            }

            getProductImage(productCode) {
                const normalizedCode = productCode.toString().toLowerCase().trim();
                const imageData = this.imageCache.get(normalizedCode);
                return imageData ? { url: imageData.directLink, found: true } : { url: null, found: false };
            }

            getStats() {
                const cacheMetaKey = this.getCacheKey('meta');
                const cacheMetaStr = localStorage.getItem(cacheMetaKey);
                let cacheInfo = null;
                if (cacheMetaStr) {
                    try {
                        const cacheMeta = JSON.parse(cacheMetaStr);
                        const cacheAge = Date.now() - cacheMeta.timestamp;
                        cacheInfo = {
                            age: Math.round(cacheAge / (60 * 1000)),
                            timestamp: new Date(cacheMeta.timestamp).toLocaleString()
                        };
                    } catch (error) {
                        console.warn('Could not parse cache metadata');
                    }
                }
                return { mappedProducts: this.imageCache.size, cacheInfo: cacheInfo };
            }
        }
        
        async function loadCatalog() {
            const loadBtn = document.getElementById('loadBtn');
            const status = document.getElementById('status');
            
            loadBtn.disabled = true;
            status.innerHTML = '‚è≥ Loading Excel file...';
            
            try {
                const response = await fetch('./JULY PROMO.xlsx');
                if (!response.ok) {
                    throw new Error('Could not find JULY PROMO.xlsx in the same folder');
                }
                
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                allProducts = jsonData
                    .filter(row => row.SKU && row['PRODUCT '] && row.PRICE && row.CATEGORY)
                    .map(row => ({
                        sku: String(row.SKU).trim(),
                        description: String(row['PRODUCT '] || row.PRODUCT || '').trim(),
                        price: parseFloat(row.PRICE) || 0,
                        category: String(row.CATEGORY).trim().toUpperCase()
                    }))
                    .filter(p => p.price > 0);
                
                categories = [...new Set(allProducts.map(p => p.category))].sort();
                
                showCategories();
                document.getElementById('customizationPanel').style.display = 'block';
                document.getElementById('introPageCustomization').style.display = 'block';
                document.getElementById('layoutOptions').style.display = 'block';
                
                document.getElementById('imageBtn').disabled = false;
                document.getElementById('generateBtn').disabled = false;
                status.innerHTML = `‚úÖ <strong>Loaded ${allProducts.length} products in ${categories.length} categories</strong>`;
                
            } catch (error) {
                status.innerHTML = `‚ùå <strong style="color: #dc3545;">Error: ${error.message}</strong>`;
                console.error(error);
            } finally {
                loadBtn.disabled = false;
            }
        }

        async function initializeImages() {
            const imageBtn = document.getElementById('imageBtn');
            const imageStatus = document.getElementById('imageStatus');
            const imageStatusText = document.getElementById('imageStatusText');
            const imageStats = document.getElementById('imageStats');
            
            imageBtn.disabled = true;
            imageBtn.innerHTML = '‚è≥ Initializing...';
            imageStatus.style.display = 'block';
            imageStatus.className = 'image-status loading';
            imageStatusText.innerHTML = 'üîÑ Starting image system...';
            
            try {
                driveImageManager = new DriveImageManager();
                driveImageManager.setProgressCallback((message) => {
                    imageStatusText.innerHTML = message;
                });
                
                const initSuccess = await Promise.race([
                    driveImageManager.initializeGAPI(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('API initialization timeout')), 20000))
                ]);
                
                if (!initSuccess) {
                    throw new Error('Failed to initialize Google Drive API');
                }
                
                imageStatusText.innerHTML = 'üì∏ Scanning for product images (this may take 30-60 seconds)...';
                
                await Promise.race([
                    driveImageManager.scanFolderForImages(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Folder scan timeout - please try again')), 60000))
                ]);
                
                const stats = driveImageManager.getStats();
                imageStatus.className = 'image-status';
                imageStatusText.innerHTML = `‚úÖ Image system ready! Found ${stats.mappedProducts} product images`;
                
                if (stats.cacheInfo) {
                    imageStats.innerHTML = `Cache: ${stats.cacheInfo.age} minutes old ‚Ä¢ Last updated: ${stats.cacheInfo.timestamp}`;
                } else {
                    imageStats.innerHTML = 'Images freshly loaded from Google Drive';
                }
                
                imageBtn.innerHTML = '‚úÖ Images Ready';
                showImageMappingPreview();
                showNotification(`Found ${stats.mappedProducts} product images!`, 'success');
                
            } catch (error) {
                console.error('Image initialization failed:', error);
                imageStatus.className = 'image-status error';
                
                let errorMessage = '‚ùå Image system failed: ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Connection timeout - please check your internet and try again';
                } else if (error.message.includes('Access denied')) {
                    errorMessage += 'Access denied - check folder permissions';
                } else if (error.message.includes('Folder not found')) {
                    errorMessage += 'Folder not found - check folder ID';
                } else {
                    errorMessage += error.message;
                }
                
                imageStatusText.innerHTML = errorMessage;
                imageStats.innerHTML = 'Catalog will be generated without images. Check console for details.';
                imageBtn.innerHTML = '‚ùå Try Again';
                
            } finally {
                imageBtn.disabled = false;
            }
        }

        function showImageMappingPreview() {
            if (!driveImageManager) return;
            
            let mappedCount = 0;
            let unmappedProducts = [];
            
            allProducts.forEach(product => {
                const imageData = driveImageManager.getProductImage(product.sku);
                if (imageData.found) {
                    mappedCount++;
                } else {
                    unmappedProducts.push(product.sku);
                }
            });
            
            const imageStats = document.getElementById('imageStats');
            const mappingInfo = `
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Image Mapping Results:</strong><br>
                    ‚Ä¢ ${mappedCount} products with images<br>
                    ‚Ä¢ ${unmappedProducts.length} products without images<br>
                    ${unmappedProducts.length > 0 ? `<details style="margin-top: 5px;"><summary style="cursor: pointer;">View unmapped SKUs</summary><div style="font-family: monospace; font-size: 12px; margin-top: 5px;">${unmappedProducts.slice(0, 10).join(', ')}${unmappedProducts.length > 10 ? ` and ${unmappedProducts.length - 10} more...` : ''}</div></details>` : ''}
                </div>
            `;
            
            imageStats.innerHTML += mappingInfo;
        }
        
        function showCategories() {
            const section = document.getElementById('categorySection');
            const list = document.getElementById('categoryList');
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            categories.forEach(cat => {
                const count = allProducts.filter(p => p.category === cat).length;
                const item = document.createElement('label');
                item.className = 'category-item';
                item.innerHTML = `
                    <input type="checkbox" checked value="${cat}" class="category-cb">
                    <span>${cat}</span>
                    <span class="category-count">${count} items</span>
                `;
                list.appendChild(item);
            });
        }

        function getImageUrl(sku) {
            if (!driveImageManager) {
                return null;
            }
            const imageData = driveImageManager.getProductImage(sku);
            return imageData.found ? imageData.url : null;
        }
        function generateCatalog() {
            const selectedCats = Array.from(document.querySelectorAll('.category-cb:checked')).map(cb => cb.value);
            
            if (selectedCats.length === 0) {
                alert('Please select at least one category');
                return;
            }
            
            const selectedLayout = document.querySelector('input[name="layout"]:checked').value;
            const layoutConfig = getLayoutConfig(selectedLayout);
            
            const filteredProducts = allProducts.filter(p => selectedCats.includes(p.category));
            filteredProducts.sort((a, b) => {
                if (a.category !== b.category) {
                    return a.category.localeCompare(b.category);
                }
                return a.description.localeCompare(b.description);
            });
            
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = '';
            
            printContent.appendChild(createHeaderPage());
            
            const includeIntroPage = document.getElementById('includeIntroPage');
            let pageNum = 2;
            if (includeIntroPage && includeIntroPage.checked) {
                printContent.appendChild(createIntroductionPage(pageNum));
                pageNum++;
            }
            
            const grouped = {};
            filteredProducts.forEach(p => {
                if (!grouped[p.category]) grouped[p.category] = [];
                grouped[p.category].push(p);
            });
            
            Object.entries(grouped).forEach(([category, products]) => {
                for (let i = 0; i < products.length; i += layoutConfig.productsPerPage) {
                    const pageProducts = products.slice(i, i + layoutConfig.productsPerPage);
                    const showCategoryHeader = i === 0;
                    printContent.appendChild(createProductPage(pageProducts, category, showCategoryHeader, pageNum++, layoutConfig));
                }
            });
            
            const totalPages = printContent.querySelectorAll('.page').length;
            printContent.querySelectorAll('.total-pages').forEach(el => {
                el.textContent = totalPages;
            });
            
            document.getElementById('printBtn').disabled = false;
            
            let imageInfo = '';
            if (driveImageManager) {
                const stats = driveImageManager.getStats();
                let mappedCount = 0;
                filteredProducts.forEach(product => {
                    const imageData = driveImageManager.getProductImage(product.sku);
                    if (imageData.found) mappedCount++;
                });
                imageInfo = ` (${mappedCount} with images)`;
            }
            
            document.getElementById('status').innerHTML = 
                `‚úÖ <strong>Generated ${totalPages} pages with ${filteredProducts.length} products${imageInfo} using ${selectedLayout} layout</strong>`;
            
            printContent.scrollIntoView({ behavior: 'smooth' });
        }

        function getLayoutConfig(layout) {
            const configs = {
                'standard': { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 },
                'compact': { productsPerPage: 12, gridClass: 'compact', columns: 3, rows: 4 },
                'dense': { productsPerPage: 10, gridClass: 'dense', columns: 2, rows: 5 },
                'ultra-compact': { productsPerPage: 15, gridClass: 'ultra-compact', columns: 3, rows: 5 }
            };
            return configs[layout] || configs['standard'];
        }
        
        function createHeaderPage() {
            const page = document.createElement('div');
            page.className = 'page hero-page';
            
            page.innerHTML = `
                <div class="page-inner">
                    <div class="hero-content">
                        <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                             alt="OZZ Cash & Carry" class="hero-logo" onerror="this.style.display='none'">
                        
                        <h1 class="hero-title">JULY 2025 PROMO</h1>
                        <p class="hero-subtitle">Exclusive Deals on Premium Home & Kitchen Products</p>
                        
                        <div class="info-grid">
                            <div class="info-card">
                                <div class="info-label">Phone</div>
                                <div class="info-value">+27 31 332 7192</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Email</div>
                                <div class="info-value">info@ozzsa.com</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Website</div>
                                <div class="info-value">www.ozzsa.com</div>
                            </div>
                        </div>
                        
                        <div class="address-section">
                            <div class="address-title">OZZ CASH & CARRY</div>
                            <div>40 Mazeppa & Gull Street</div>
                            <div>Durban, KwaZulu-Natal 4001</div>
                            <div>South Africa</div>
                            <div style="margin-top: 3mm;">
                                <strong>Hours:</strong> Mon-Fri: 8AM-5PM | Sat: 8AM-1PM
                            </div>
                        </div>
                        
                        <div class="collection-notice">
                            <div class="notice-title">üìç COLLECTION & DELIVERY</div>
                            <div>Promotional prices are valid for collection only at 40 Mazeppa Street, Durban.</div>
                            <div>Delivery is available at an additional charge.</div>
                        </div>
                    </div>
                    
                    <div class="page-footer">
                        <div class="disclaimer">
                            While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                            Ozz Cash and Carry reserves the right to limit quantities. All items include VAT where applicable. 
                            Images are for illustrative purposes only.
                        </div>
                        <div class="footer-info">
                            <span class="footer-left">OZZ Cash & Carry ‚Ä¢ July 2025 Catalog</span>
                            <span class="footer-right">Page 1 of <span class="total-pages">-</span> ‚Ä¢ Version 3.0</span>
                        </div>
                        <div style="text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px solid #e0e0e0; font-size: 6pt; color: #999; opacity: 0.8;">
                            Designed and managed by Black Orchid Consulting www.blackorchid.online
                        </div>
                    </div>
                </div>
            `;
            
            return page;
        }

        function createIntroductionPage(pageNum) {
            const page = document.createElement('div');
            page.className = 'page';
            
            const title = document.getElementById('introTitle').value || 'Welcome to Our July 2025 Promotion';
            const subtitle = document.getElementById('introSubtitle').value || 'Exclusive deals on premium home & kitchen products';
            const message = document.getElementById('introMessage').value || 'Thank you for choosing OZZ Cash & Carry for your home and kitchen needs.';
            const promoDetails = document.getElementById('promoDetails').value || '‚Ä¢ Valid for July 2025 only\n‚Ä¢ Limited quantities available';
            const additionalInfo = document.getElementById('additionalInfo').value || 'Store Hours:\nMonday - Friday: 8:00 AM - 5:00 PM';
            
            page.innerHTML = `
                <div class="page-inner">
                    <div class="page-header">
                        <div class="header-left">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ" class="header-logo" onerror="this.style.display='none'">
                            <span class="header-title">July 2025 Promotional Catalog</span>
                        </div>
                        <span class="page-number">Page ${pageNum} of <span class="total-pages">-</span></span>
                    </div>
                    
                    <div class="page-content">
                        <div style="text-align: center; margin-bottom: 8mm;">
                            <h1 style="font-size: 24pt; font-weight: 900; color: #cc0000; margin-bottom: 3mm;">
                                ${title}
                            </h1>
                            <p style="font-size: 14pt; color: #444; font-weight: 300;">
                                ${subtitle}
                            </p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 8mm; border-radius: 4mm; margin-bottom: 6mm; border-left: 5mm solid #006b6b;">
                            <h2 style="font-size: 16pt; font-weight: 800; color: #006b6b; margin-bottom: 4mm;">
                                üì¢ Our Message to You
                            </h2>
                            <p style="font-size: 11pt; line-height: 1.6; color: #333; text-align: justify;">
                                ${message.replace(/\n/g, '<br>')}
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6mm; margin-bottom: 6mm;">
                            <div style="background: linear-gradient(135deg, #fff8dc 0%, #ffedd5 100%); padding: 6mm; border-radius: 3mm; border-left: 3mm solid #ff6b35;">
                                <h3 style="font-size: 14pt; font-weight: 800; color: #d84315; margin-bottom: 3mm;">
                                    üéØ Promotion Details
                                </h3>
                                <div style="font-size: 10pt; line-height: 1.5; color: #333;">
                                    ${promoDetails.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); padding: 6mm; border-radius: 3mm; border-left: 3mm solid #28a745;">
                                <h3 style="font-size: 14pt; font-weight: 800; color: #155724; margin-bottom: 3mm;">
                                    ‚ÑπÔ∏è Additional Information
                                </h3>
                                <div style="font-size: 10pt; line-height: 1.5; color: #333;">
                                    ${additionalInfo.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #006b6b 0%, #004d4d 100%); color: white; padding: 8mm; border-radius: 4mm; text-align: center;">
                            <h2 style="font-size: 18pt; font-weight: 800; margin-bottom: 4mm;">
                                üè™ Visit Our Store
                            </h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4mm; margin-bottom: 4mm;">
                                <div>
                                    <div style="font-size: 8pt; opacity: 0.8; margin-bottom: 1mm;">PHONE</div>
                                    <div style="font-size: 12pt; font-weight: 700;">+27 31 332 7192</div>
                                </div>
                                <div>
                                    <div style="font-size: 8pt; opacity: 0.8; margin-bottom: 1mm;">EMAIL</div>
                                    <div style="font-size: 12pt; font-weight: 700;">info@ozzsa.com</div>
                                </div>
                                <div>
                                    <div style="font-size: 8pt; opacity: 0.8; margin-bottom: 1mm;">WEBSITE</div>
                                    <div style="font-size: 12pt; font-weight: 700;">www.ozzsa.com</div>
                                </div>
                            </div>
                            <div style="font-size: 11pt; line-height: 1.4;">
                                <strong>40 Mazeppa & Gull Street</strong><br>
                                Durban, KwaZulu-Natal 4001, South Africa
                            </div>
                        </div>
                    </div>
                    
                    <div class="page-footer">
                        <div class="disclaimer">
                            While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                            All items include VAT where applicable. Images are for illustrative purposes only.
                        </div>
                        <div class="footer-info">
                            <span class="footer-left">OZZ Cash & Carry ‚Ä¢ +27 31 332 7192 ‚Ä¢ info@ozzsa.com</span>
                            <span class="footer-right">www.ozzsa.com ‚Ä¢ Version 3.0</span>
                        </div>
                        <div style="text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px solid #e0e0e0; font-size: 6pt; color: #999; opacity: 0.8;">
                            Designed and managed by Black Orchid Consulting www.blackorchid.online
                        </div>
                    </div>
                </div>
            `;
            
            return page;
        }
        
        function createProductPage(products, category, showHeader, pageNum, layoutConfig = { productsPerPage: 8, gridClass: '', columns: 2, rows: 4 }) {
            const page = document.createElement('div');
            page.className = 'page';
            
            let contentHTML = `
                <div class="page-inner">
                    <div class="page-header">
                        <div class="header-left">
                            <img src="https://raw.githubusercontent.com/Iamabhih/OZZPromotions/main/OZZ-logo-transparent-1-1.png" 
                                 alt="OZZ" class="header-logo" onerror="this.style.display='none'">
                            <span class="header-title">July 2025 Promotional Catalog</span>
                        </div>
                        <span class="page-number">Page ${pageNum} of <span class="total-pages">-</span></span>
                    </div>
                    
                    <div class="page-content">
            `;
            
            if (showHeader) {
                contentHTML += `<div class="category-header">${category}</div>`;
            }
            
            contentHTML += `<div class="products-container"><div class="products-grid ${layoutConfig.gridClass}">`;
            
            for (let i = 0; i < layoutConfig.productsPerPage; i++) {
                if (i < products.length) {
                    contentHTML += createProductCard(products[i]);
                } else {
                    contentHTML += '<div class="product-card" style="visibility: hidden;"></div>';
                }
            }
            
            contentHTML += `
                        </div></div>
                    </div>
                    
                    <div class="page-footer">
                        <div class="disclaimer">
                            While Ozz Cash and Carry will always attempt to have sufficient stock available, the above prices are valid till stocks last. 
                            All items include VAT where applicable. Images are for illustrative purposes only.
                        </div>
                        <div class="footer-info">
                            <span class="footer-left">OZZ Cash & Carry ‚Ä¢ +27 31 332 7192 ‚Ä¢ info@ozzsa.com</span>
                            <span class="footer-right">www.ozzsa.com ‚Ä¢ Version 3.0</span>
                        </div>
                        <div style="text-align: center; margin-top: 3mm; padding-top: 2mm; border-top: 1px solid #e0e0e0; font-size: 6pt; color: #999; opacity: 0.8;">
                            Designed and managed by Black Orchid Consulting www.blackorchid.online
                        </div>
                    </div>
                </div>
            `;
            
            page.innerHTML = contentHTML;
            return page;
        }
        
        function createProductCard(product) {
            const imageUrl = getImageUrl(product.sku);
            const originalPrice = (product.price * 1.2).toFixed(2);
            const savePercent = Math.round(((originalPrice - product.price) / originalPrice) * 100);
            
            const priceStr = product.price.toFixed(2);
            const [rands, cents] = priceStr.split('.');
            
            const descWords = product.description.split(' ');
            let productName = '';
            let productVariant = '';
            
            if (descWords.length > 2) {
                productName = descWords.slice(0, 2).join(' ');
                productVariant = descWords.slice(2).join(' ');
            } else {
                productName = product.description;
                productVariant = product.category;
            }
            
            return `
                <div class="product-card">
                    <div class="product-image">
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${product.description}">` :
                            `<div class="no-image">
                                <div class="no-image-icon">üì¶</div>
                                <div class="no-image-text">SKU: ${product.sku}</div>
                            </div>`
                        }
                    </div>
                    <div class="product-details">
                        <div class="product-header">
                            <div class="product-name">${productName}</div>
                            <div class="product-variant">${productVariant}</div>
                        </div>
                        <div class="product-specs">
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value">${product.sku}</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">Category:</span>
                                <span class="spec-value">${product.category}</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-bullet">‚Ä¢</span>
                                <span class="spec-label">Price:</span>
                                <span class="spec-value">R${originalPrice} RRP</span>
                            </div>
                            ${savePercent > 0 ? `
                                <div class="spec-item">
                                    <span class="spec-bullet">‚Ä¢</span>
                                    <span class="spec-label">Savings:</span>
                                    <span class="spec-value">${savePercent}% OFF</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="price-badge">
                            <div class="price-amount">
                                <span class="price-currency">R</span>${rands}<span class="price-cents">${cents}</span>
                            </div>
                            <div class="price-unit">Each</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function previewIntroPage() {
            const printContent = document.getElementById('printContent');
            printContent.innerHTML = '';
            printContent.appendChild(createIntroductionPage(1));
            printContent.scrollIntoView({ behavior: 'smooth' });
            showNotification('Introduction page preview generated!', 'info');
        }

        function resetIntroPage() {
            document.getElementById('introTitle').value = 'Welcome to Our July 2025 Promotion';
            document.getElementById('introSubtitle').value = 'Exclusive deals on premium home & kitchen products';
            document.getElementById('introMessage').value = 'Thank you for choosing OZZ Cash & Carry for your home and kitchen needs. This July, we\'re offering exceptional deals on premium products to help you create the perfect living space.';
            document.getElementById('promoDetails').value = '‚Ä¢ Valid for July 2025 only\n‚Ä¢ Limited quantities available\n‚Ä¢ Collection only at our Durban store\n‚Ä¢ Delivery available at additional cost';
            document.getElementById('additionalInfo').value = 'Store Hours:\nMonday - Friday: 8:00 AM - 5:00 PM\nSaturday: 8:00 AM - 1:00 PM\nSunday: Closed\n\nVisit our showroom to see the full range!';
            document.getElementById('includeIntroPage').checked = true;
            showNotification('Introduction page reset to default!', 'info');
        }

        function applyColorScheme() {
            const headerColor = document.getElementById('headerColor').value;
            const priceColor = document.getElementById('priceColor').value;
            const accentColor = document.getElementById('accentColor').value;
            
            const styleId = 'dynamic-colors';
            let styleEl = document.getElementById(styleId);
            
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }
            
            styleEl.textContent = `
                .product-header {
                    background: linear-gradient(135deg, ${headerColor} 0%, ${adjustBrightness(headerColor, -20)} 100%) !important;
                }
                .price-badge {
                    background: linear-gradient(135deg, ${priceColor} 0%, ${adjustBrightness(priceColor, -20)} 100%) !important;
                }
                .category-header {
                    background: linear-gradient(90deg, ${accentColor} 0%, ${adjustBrightness(accentColor, 20)} 100%) !important;
                }
                .spec-bullet {
                    color: ${headerColor} !important;
                }
            `;
            
            showNotification('Color scheme applied!', 'success');
        }

        function applyTypography() {
            const fontFamily = document.getElementById('fontFamily').value;
            const textStyle = document.getElementById('textStyle').value;
            
            const fontMap = {
                'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif',
                'arial': 'Arial, sans-serif',
                'helvetica': 'Helvetica, Arial, sans-serif',
                'times': '"Times New Roman", Times, serif',
                'georgia': 'Georgia, serif'
            };
            
            const styleId = 'dynamic-typography';
            let styleEl = document.getElementById(styleId);
            
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = styleId;
                document.head.appendChild(styleEl);
            }
            
            styleEl.textContent = `
                .product-name {
                    font-family: ${fontMap[fontFamily]} !important;
                    text-transform: ${textStyle} !important;
                }
                .product-variant {
                    font-family: ${fontMap[fontFamily]} !important;
                    text-transform: ${textStyle} !important;
                }
            `;
            
            showNotification('Typography applied!', 'success');
        }

        function applyTheme(themeName) {
            const themes = {
                'ozz-classic': { header: '#006b6b', price: '#cc0000', accent: '#1a1a1a', font: 'system', transform: 'uppercase' },
                'modern-blue': { header: '#0056b3', price: '#dc3545', accent: '#495057', font: 'helvetica', transform: 'uppercase' },
                'elegant-black': { header: '#2c3e50', price: '#e74c3c', accent: '#34495e', font: 'georgia', transform: 'capitalize' }
            };
            
            const theme = themes[themeName];
            if (!theme) return;
            
            document.getElementById('headerColor').value = theme.header;
            document.getElementById('priceColor').value = theme.price;
            document.getElementById('accentColor').value = theme.accent;
            document.getElementById('fontFamily').value = theme.font;
            document.getElementById('textStyle').value = theme.transform;
            
            applyColorScheme();
            applyTypography();
            
            showNotification(`${themeName.replace('-', ' ')} theme applied!`, 'success');
        }

        function resetToDefault() {
            document.getElementById('headerColor').value = '#006b6b';
            document.getElementById('priceColor').value = '#cc0000';
            document.getElementById('accentColor').value = '#1a1a1a';
            document.getElementById('fontFamily').value = 'system';
            document.getElementById('textStyle').value = 'uppercase';
            
            const dynamicStyles = ['dynamic-colors', 'dynamic-typography'];
            dynamicStyles.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.remove();
            });
            
            showNotification('Reset to default styling!', 'info');
        }

        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white; padding: 12px 20px; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000;
                font-size: 14px; font-weight: 500; opacity: 0;
                transform: translateX(100%); transition: all 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        console.log('üéâ OZZ Professional Catalog Generator with CSP-Safe Images & Full Customization Loaded');
        console.log('üîí CSP-Safe: No eval() usage - fully secure');
        console.log('üé® Customization: Colors, fonts, themes, and layouts available');
        console.log('üì∏ Image integration: CSP-compliant Google Drive API');
    </script>
</body>
</html>
