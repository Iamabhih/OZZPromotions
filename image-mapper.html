<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñºÔ∏è OZZ Promotions Image Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-red-600 mb-4">üñºÔ∏è OZZ Promotions Image Mapper</h1>
            <p class="text-gray-600 mb-6">Automatically mapping your Google Drive images to product catalog</p>
            
            <!-- Auto-filled credentials -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                <h2 class="text-lg font-semibold text-green-800 mb-2">‚úÖ Credentials Loaded</h2>
                <div class="text-sm text-green-700">
                    <p>üìÅ Folder: Ikhaya/OzzSA</p>
                    <p>üîë API Key: Configured</p>
                </div>
            </div>

            <!-- Scan Button -->
            <div class="text-center mb-6">
                <button onclick="startAutoMapping()" id="scanBtn" 
                        class="bg-red-600 text-white px-8 py-4 rounded-lg hover:bg-red-700 transition-colors font-bold text-lg shadow-lg">
                    üöÄ Generate Image Mapping Code
                </button>
            </div>

            <!-- Progress -->
            <div id="progress" class="hidden mb-6">
                <div class="bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progressBar" class="bg-red-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-center text-gray-600">Starting scan...</p>
            </div>

            <!-- Results Preview -->
            <div id="results" class="hidden mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üì∏ Image Mapping Preview</h2>
                <div id="imagePreview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                    <!-- Image previews will be shown here -->
                </div>
                <div id="stats" class="bg-blue-50 p-4 rounded-lg">
                    <!-- Statistics will be shown here -->
                </div>
            </div>

            <!-- Generated Code -->
            <div id="codeSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Generated Code for Your Catalog</h2>
                <p class="text-gray-600 mb-4">Copy this code and paste it into your main catalog HTML file:</p>
                
                <div class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto mb-4">
                    <pre id="generatedCode" class="text-sm"></pre>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="copyCode()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        üìã Copy Code
                    </button>
                    <button onclick="downloadCode()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        üíæ Download as File
                    </button>
                </div>
            </div>

            <!-- Log -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">üìù Process Log</h3>
                <div id="log" class="bg-gray-900 text-green-400 p-4 rounded-lg h-48 overflow-y-auto font-mono text-sm">
                    üéØ Ready to scan your Google Drive folder...<br>
                    üìÅ Target folder: Ikhaya/OzzSA<br>
                    üîç Will search for images matching your 236 product SKUs<br>
                    ‚ñ∂Ô∏è Click "Generate Image Mapping Code" to start<br>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Your credentials (pre-filled)
        const API_KEY = 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA';
        const FOLDER_ID = '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan';

        // All your product SKUs
        const PRODUCT_SKUS = [
            "455641", "455642", "455639", "455650", "455644", "455643", "455640", "455649", 
            "455634", "455636", "455647", "455648", "444984", "4161", "455080", "454437", 
            "455428", "455427", "455426", "453704", "440728", "453261", "446223", "444971", 
            "444970", "444974", "444973", "455646", "10836", "304", "314", "307", "10833", 
            "14996", "31735", "31750", "31754", "31755", "22951", "31753", "318", "317", 
            "319", "320", "217", "221", "136", "234", "23777", "31756", "237", "451170", 
            "454978", "455512", "451169", "26926", "455407", "455406", "455408", "455409", 
            "27004", "455410", "455513", "26927", "27005", "455517", "455645", "455637", 
            "455638", "455635", "26918", "26912", "26913", "449950", "195", "206", "455009", 
            "455008", "455200", "455012", "455011", "455010", "455013", "455035", "455034", 
            "455003", "455203", "455204", "455205", "455017", "455018", "455019", "455022", 
            "455023", "455036", "455002", "455001", "455000", "455037", "455514", "455510", 
            "455509", "455511", "455508", "455006", "455005", "455007", "455201", "455516", 
            "455515", "455084", "455082", "455086", "455088", "449949", "449947", "449948", 
            "259", "269", "255", "454979", "455384", "455321", "455322", "455323"
        ];

        let allImages = [];
        let imageMapping = {};

        function log(message) {
            const logEl = document.getElementById('log');
            logEl.innerHTML += message + '<br>';
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateProgress(percent, text) {
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        async function startAutoMapping() {
            document.getElementById('scanBtn').disabled = true;
            document.getElementById('scanBtn').textContent = 'üîÑ Scanning...';
            
            try {
                log('üöÄ Starting automated image mapping...');
                updateProgress(10, 'Connecting to Google Drive...');
                
                await fetchAllImages();
                updateProgress(60, 'Mapping images to SKUs...');
                
                mapImagesToSKUs();
                updateProgress(80, 'Generating code...');
                
                displayResults();
                generateMappingCode();
                updateProgress(100, 'Complete! ‚úÖ');
                
                log('üéâ Image mapping completed successfully!');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                console.error(error);
            } finally {
                document.getElementById('scanBtn').disabled = false;
                document.getElementById('scanBtn').textContent = 'üîÑ Scan Again';
            }
        }

        async function fetchAllImages(pageToken = '') {
            let url = `https://www.googleapis.com/drive/v3/files?key=${API_KEY}&q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'image'&fields=files(id,name,mimeType,webViewLink)&pageSize=1000`;
            
            if (pageToken) {
                url += `&pageToken=${pageToken}`;
            }

            log(`üîç Fetching images from Google Drive...`);
            updateProgress(20, 'Fetching images from Google Drive...');

            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Google Drive API error: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.files) {
                throw new Error('No files found in the folder');
            }

            allImages = allImages.concat(data.files);
            log(`üì∏ Found ${data.files.length} images (Total: ${allImages.length})`);
            updateProgress(40, `Found ${allImages.length} images...`);

            // Fetch more pages if they exist
            if (data.nextPageToken) {
                await fetchAllImages(data.nextPageToken);
            }
        }

        function mapImagesToSKUs() {
            log('üîó Mapping images to product SKUs...');
            imageMapping = {};
            let matchCount = 0;

            PRODUCT_SKUS.forEach(sku => {
                // Find images that match this SKU
                const matches = allImages.filter(img => {
                    const filename = img.name.toLowerCase();
                    const skuLower = sku.toLowerCase();
                    
                    return filename.includes(skuLower) ||
                           filename.includes(skuLower.replace(/\D/g, '')) ||
                           filename.startsWith(skuLower) ||
                           filename.includes(`-${skuLower}`) ||
                           filename.includes(`_${skuLower}`) ||
                           filename.includes(` ${skuLower}`) ||
                           new RegExp(`\\b${skuLower}\\b`).test(filename);
                });

                if (matches.length > 0) {
                    const bestMatch = matches[0]; // Use first match
                    imageMapping[sku] = {
                        url: `https://drive.google.com/uc?id=${bestMatch.id}`,
                        filename: bestMatch.name,
                        id: bestMatch.id
                    };
                    matchCount++;
                    log(`‚úÖ ${sku} ‚Üí ${bestMatch.name}`);
                } else {
                    log(`‚ùå No image found for SKU: ${sku}`);
                }
            });

            log(`üéØ Mapping complete: ${matchCount}/${PRODUCT_SKUS.length} products have images`);
        }

        function displayResults() {
            const resultsEl = document.getElementById('results');
            const previewEl = document.getElementById('imagePreview');
            const statsEl = document.getElementById('stats');
            
            resultsEl.classList.remove('hidden');

            // Show image previews (first 12)
            const mappedEntries = Object.entries(imageMapping).slice(0, 12);
            previewEl.innerHTML = mappedEntries.map(([sku, data]) => `
                <div class="border rounded-lg p-2 bg-gray-50 text-center">
                    <img src="${data.url}" alt="SKU ${sku}" class="w-full h-20 object-cover rounded mb-2" 
                         onerror="this.src='https://via.placeholder.com/80x80/ddd/999?text=Error'">
                    <div class="text-xs font-semibold">${sku}</div>
                    <div class="text-xs text-gray-500 truncate">${data.filename}</div>
                </div>
            `).join('');

            // Show statistics
            const mappedCount = Object.keys(imageMapping).length;
            const missingCount = PRODUCT_SKUS.length - mappedCount;
            const percentage = Math.round((mappedCount / PRODUCT_SKUS.length) * 100);

            statsEl.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-green-600">${mappedCount}</div>
                        <div class="text-sm text-gray-600">Images Mapped</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-red-600">${missingCount}</div>
                        <div class="text-sm text-gray-600">Missing Images</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-blue-600">${allImages.length}</div>
                        <div class="text-sm text-gray-600">Total Images</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600">${percentage}%</div>
                        <div class="text-sm text-gray-600">Coverage</div>
                    </div>
                </div>
            `;
        }

        function generateMappingCode() {
            const codeSection = document.getElementById('codeSection');
            const codeEl = document.getElementById('generatedCode');
            
            const mappingEntries = Object.entries(imageMapping)
                .map(([sku, data]) => `        '${sku}': '${data.url}',`)
                .join('\n');

            const code = `// Auto-generated Google Drive image mapping for OZZ Promotions
// Generated on: ${new Date().toLocaleString()}
// Mapped ${Object.keys(imageMapping).length}/${PRODUCT_SKUS.length} products

function getImageUrl(sku) {
    const imageMapping = {
${mappingEntries}
    };
    
    return imageMapping[sku] || \`https://via.placeholder.com/300x200/e2e8f0/64748b?text=\${sku}\`;
}`;

            codeEl.textContent = code;
            codeSection.classList.remove('hidden');
            
            log('üìã JavaScript code generated and ready to copy!');
        }

        function copyCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Code copied to clipboard! Paste it into your catalog HTML file.');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Code copied to clipboard!');
            });
        }

        function downloadCode() {
            const code = document.getElementById('generatedCode').textContent;
            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ozz-image-mapping.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
