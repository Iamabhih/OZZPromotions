<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñºÔ∏è OZZ Promotions Image Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #progressBar {
            transition: width 0.5s cubic-bezier(0.65, 0, 0.35, 1);
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-red-600 mb-4">üñºÔ∏è OZZ Promotions Image Mapper</h1>
            <p class="text-gray-600 mb-6">Automatically mapping your Google Drive images to product catalog</p>
            
            <!-- Auto-filled credentials -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                <h2 class="text-lg font-semibold text-green-800 mb-2">‚úÖ Credentials Loaded</h2>
                <div class="text-sm text-green-700">
                    <p>üìÅ Folder: Ikhaya/OzzSA</p>
                    <p>üîë API Key: Configured</p>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex flex-wrap gap-4 mb-6 justify-center">
                <button onclick="startAutoMapping()" id="scanBtn" 
                        class="bg-red-600 text-white px-8 py-4 rounded-lg hover:bg-red-700 transition-colors font-bold text-lg shadow-lg flex-1 min-w-[300px]">
                    üöÄ Generate Image Mapping Code
                </button>
                <button onclick="clearCache()" id="clearCacheBtn"
                        class="bg-gray-600 text-white px-6 py-4 rounded-lg hover:bg-gray-700 transition-colors font-bold text-lg shadow-lg">
                    üßπ Clear Cache
                </button>
            </div>

            <!-- Progress -->
            <div id="progress" class="hidden mb-6">
                <div class="bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progressBar" class="bg-red-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-center text-gray-600">Starting scan...</p>
            </div>

            <!-- Results Preview -->
            <div id="results" class="hidden mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">üì∏ Image Mapping Preview</h2>
                    <button onclick="exportMapping()" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">
                        üì§ Export JSON
                    </button>
                </div>
                <div id="imagePreview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                    <!-- Image previews will be shown here -->
                </div>
                <div id="stats" class="bg-blue-50 p-4 rounded-lg">
                    <!-- Statistics will be shown here -->
                </div>
            </div>

            <!-- Generated Code -->
            <div id="codeSection" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Generated Code for Your Catalog</h2>
                <p class="text-gray-600 mb-4">Copy this code and paste it into your main catalog HTML file:</p>
                
                <div class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto mb-4">
                    <pre id="generatedCode" class="text-sm"></pre>
                </div>
                
                <div class="flex flex-wrap gap-4 justify-center">
                    <button onclick="copyCode()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold flex-1">
                        üìã Copy Code
                    </button>
                    <button onclick="downloadCode()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold flex-1">
                        üíæ Download as File
                    </button>
                </div>
            </div>

            <!-- Log -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-800">üìù Process Log</h3>
                    <button onclick="clearLog()" class="text-gray-500 hover:text-gray-700 text-sm">
                        Clear Log
                    </button>
                </div>
                <div id="log" class="bg-gray-900 text-green-400 p-4 rounded-lg h-48 overflow-y-auto font-mono text-sm">
                    <div class="log-entry">üéØ Ready to scan your Google Drive folder...</div>
                    <div class="log-entry">üìÅ Target folder: Ikhaya/OzzSA</div>
                    <div class="log-entry">üîç Will search for images matching your ${PRODUCT_SKUS.length} product SKUs</div>
                    <div class="log-entry">‚ñ∂Ô∏è Click "Generate Image Mapping Code" to start</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_KEY: 'AIzaSyDHKDrY2UUT9_HZhBY6GMAkyHYHIdv7OsA',
            FOLDER_ID: '1tG66zQTXGR-BQwjYZheRHVQ7s4n6-Jan',
            CACHE_KEY: 'ozz_image_mapping_v2',
            CACHE_TTL: 24 * 60 * 60 * 1000, // 24 hours
            PAGE_SIZE: 1000,
            PREVIEW_LIMIT: 12
        };

        // All your product SKUs
        const PRODUCT_SKUS = [
            "455641", "455642", "455639", "455650", "455644", "455643", "455640", "455649", 
            "455634", "455636", "455647", "455648", "444984", "4161", "455080", "454437", 
            "455428", "455427", "455426", "453704", "440728", "453261", "446223", "444971", 
            "444970", "444974", "444973", "455646", "10836", "304", "314", "307", "10833", 
            "14996", "31735", "31750", "31754", "31755", "22951", "31753", "318", "317", 
            "319", "320", "217", "221", "136", "234", "23777", "31756", "237", "451170", 
            "454978", "455512", "451169", "26926", "455407", "455406", "455408", "455409", 
            "27004", "455410", "455513", "26927", "27005", "455517", "455645", "455637", 
            "455638", "455635", "26918", "26912", "26913", "449950", "195", "206", "455009", 
            "455008", "455200", "455012", "455011", "455010", "455013", "455035", "455034", 
            "455003", "455203", "455204", "455205", "455017", "455018", "455019", "455022", 
            "455023", "455036", "455002", "455001", "455000", "455037", "455514", "455510", 
            "455509", "455511", "455508", "455006", "455005", "455007", "455201", "455516", 
            "455515", "455084", "455082", "455086", "455088", "449949", "449947", "449948", 
            "259", "269", "255", "454979", "455384", "455321", "455322", "455323"
        ];

        // State
        let imageMapping = {};
        let scanInProgress = false;

        // DOM Elements
        const elements = {
            scanBtn: document.getElementById('scanBtn'),
            clearCacheBtn: document.getElementById('clearCacheBtn'),
            progress: document.getElementById('progress'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            results: document.getElementById('results'),
            imagePreview: document.getElementById('imagePreview'),
            stats: document.getElementById('stats'),
            codeSection: document.getElementById('codeSection'),
            generatedCode: document.getElementById('generatedCode'),
            log: document.getElementById('log')
        };

        // Utility Functions
        function log(message, type = 'info') {
            const colors = {
                info: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                success: 'text-green-500'
            };
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${colors[type] || 'text-green-400'}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            elements.log.appendChild(logEntry);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function updateProgress(percent, text) {
            elements.progress.classList.remove('hidden');
            elements.progressBar.style.width = percent + '%';
            elements.progressText.textContent = text;
        }

        function clearLog() {
            elements.log.innerHTML = '';
            log('Log cleared', 'info');
        }

        // Cache Management
        function loadCache() {
            try {
                const cachedData = localStorage.getItem(CONFIG.CACHE_KEY);
                if (!cachedData) return null;
                
                const { data, timestamp } = JSON.parse(cachedData);
                if (Date.now() - timestamp < CONFIG.CACHE_TTL) {
                    return data;
                }
                log('Cache expired', 'warning');
            } catch (e) {
                log('Error loading cache: ' + e.message, 'error');
            }
            return null;
        }

        function saveCache(data) {
            try {
                const cacheData = {
                    data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(cacheData));
                return true;
            } catch (e) {
                log('Error saving cache: ' + e.message, 'error');
                return false;
            }
        }

        function clearCache() {
            if (scanInProgress) {
                log('Cannot clear cache during active scan', 'warning');
                return;
            }
            
            localStorage.removeItem(CONFIG.CACHE_KEY);
            imageMapping = {};
            elements.results.classList.add('hidden');
            elements.codeSection.classList.add('hidden');
            log('Cache cleared successfully', 'success');
        }

        // Drive API Functions
        async function fetchDriveImages(pageToken = '') {
            const url = new URL('https://www.googleapis.com/drive/v3/files');
            const params = {
                key: CONFIG.API_KEY,
                q: `'${CONFIG.FOLDER_ID}' in parents and mimeType contains 'image/'`,
                fields: 'files(id,name,mimeType,webViewLink,thumbnailLink),nextPageToken',
                pageSize: CONFIG.PAGE_SIZE,
                pageToken: pageToken
            };
            
            Object.entries(params).forEach(([key, value]) => {
                if (value) url.searchParams.append(key, value);
            });

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                log(`Drive API error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Image Matching
        function findBestImageMatch(images, sku) {
            const skuLower = sku.toLowerCase();
            const skuNumeric = skuLower.replace(/\D/g, '');
            
            // Score images based on match quality
            const scoredImages = images.map(img => {
                const filename = img.name.toLowerCase();
                let score = 0;
                
                // Exact match gets highest score
                if (filename === skuLower || filename === `${skuLower}.jpg`) score = 100;
                // Starts with SKU
                else if (filename.startsWith(skuLower)) score = 80;
                // Contains SKU with separator
                else if (filename.includes(`_${skuLower}`) || filename.includes(`-${skuLower}`)) score = 60;
                // Contains numeric SKU
                else if (filename.includes(skuNumeric)) score = 40;
                // Contains part of SKU
                else if (new RegExp(`\\b${skuLower}\\b`).test(filename)) score = 20;
                
                return { ...img, score };
            }).filter(img => img.score > 0);
            
            if (scoredImages.length === 0) return null;
            
            // Return highest scored image
            return scoredImages.reduce((best, current) => 
                current.score > best.score ? current : best
            );
        }

        // Main Functions
        async function startAutoMapping() {
            if (scanInProgress) {
                log('Scan already in progress', 'warning');
                return;
            }
            
            scanInProgress = true;
            elements.scanBtn.disabled = true;
            elements.scanBtn.textContent = 'üîÑ Scanning...';
            
            try {
                log('üöÄ Starting automated image mapping...', 'info');
                updateProgress(5, 'Initializing...');
                
                // Try to load from cache first
                const cachedMapping = loadCache();
                if (cachedMapping) {
                    imageMapping = cachedMapping;
                    updateProgress(100, 'Loaded from cache');
                    displayResults();
                    generateMappingCode();
                    log('‚úÖ Loaded mapping from cache', 'success');
                    return;
                }
                
                updateProgress(10, 'Connecting to Google Drive...');
                
                // Fetch all images
                let allImages = [];
                let nextPageToken = '';
                let pageCount = 0;
                
                do {
                    pageCount++;
                    const data = await fetchDriveImages(nextPageToken);
                    allImages = allImages.concat(data.files || []);
                    nextPageToken = data.nextPageToken || '';
                    
                    const progress = 10 + Math.min(60, Math.floor((pageCount * 30) / (allImages.length / CONFIG.PAGE_SIZE));
                    updateProgress(progress, `Fetched ${allImages.length} images...`);
                    
                    log(`üìÑ Page ${pageCount}: Found ${data.files?.length || 0} images`, 'info');
                } while (nextPageToken && pageCount < 10); // Safety limit
                
                log(`üì∏ Total images found: ${allImages.length}`, 'info');
                updateProgress(70, `Mapping ${PRODUCT_SKUS.length} SKUs...`);
                
                // Map images to SKUs
                imageMapping = {};
                let matchCount = 0;
                
                for (const sku of PRODUCT_SKUS) {
                    const bestMatch = findBestImageMatch(allImages, sku);
                    if (bestMatch) {
                        imageMapping[sku] = {
                            url: `https://drive.google.com/uc?id=${bestMatch.id}`,
                            filename: bestMatch.name,
                            id: bestMatch.id,
                            thumbnail: bestMatch.thumbnailLink
                        };
                        matchCount++;
                        log(`‚úÖ ${sku} ‚Üí ${bestMatch.name} (score: ${bestMatch.score})`, 'info');
                    } else {
                        log(`‚ùå No image found for SKU: ${sku}`, 'warning');
                    }
                    
                    // Update progress
                    const progress = 70 + Math.floor(30 * (PRODUCT_SKUS.indexOf(sku) + 1) / PRODUCT_SKUS.length);
                    updateProgress(progress, `Mapping ${PRODUCT_SKUS.indexOf(sku) + 1}/${PRODUCT_SKUS.length} SKUs...`);
                }
                
                // Save to cache
                if (saveCache(imageMapping)) {
                    log('üíæ Mapping saved to cache', 'success');
                }
                
                updateProgress(100, 'Mapping complete!');
                log(`üéØ Mapping complete: ${matchCount}/${PRODUCT_SKUS.length} products matched`, 'success');
                
                displayResults();
                generateMappingCode();
                
            } catch (error) {
                log(`‚ùå Scan failed: ${error.message}`, 'error');
                updateProgress(0, 'Scan failed');
            } finally {
                scanInProgress = false;
                elements.scanBtn.disabled = false;
                elements.scanBtn.textContent = 'üîÑ Scan Again';
            }
        }

        function displayResults() {
            elements.results.classList.remove('hidden');
            
            // Show image previews
            const previewItems = Object.entries(imageMapping)
                .slice(0, CONFIG.PREVIEW_LIMIT)
                .map(([sku, data]) => `
                    <div class="border rounded-lg p-2 bg-gray-50 text-center hover:shadow-md transition-shadow">
                        <img src="${data.thumbnail || data.url}" 
                             alt="SKU ${sku}" 
                             class="w-full h-20 object-cover rounded mb-2"
                             onerror="this.src='https://via.placeholder.com/80x80/ddd/999?text=Image+Error'">
                        <div class="text-xs font-semibold">${sku}</div>
                        <div class="text-xs text-gray-500 truncate" title="${data.filename}">${data.filename}</div>
                    </div>
                `).join('');
            
            elements.imagePreview.innerHTML = previewItems;
            
            // Show statistics
            const mappedCount = Object.keys(imageMapping).length;
            const missingCount = PRODUCT_SKUS.length - mappedCount;
            const percentage = Math.round((mappedCount / PRODUCT_SKUS.length) * 100);
            
            elements.stats.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${mappedCount}</div>
                        <div class="text-sm text-gray-600">Mapped</div>
                    </div>
                    <div class="bg-red-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-red-600">${missingCount}</div>
                        <div class="text-sm text-gray-600">Missing</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${percentage}%</div>
                        <div class="text-sm text-gray-600">Coverage</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${PRODUCT_SKUS.length}</div>
                        <div class="text-sm text-gray-600">Total SKUs</div>
                    </div>
                </div>
            `;
        }

        function generateMappingCode() {
            const mappingEntries = Object.entries(imageMapping)
                .map(([sku, data]) => `    '${sku}': '${data.url}',`)
                .join('\n');

            const code = `// Auto-generated Google Drive image mapping for OZZ Promotions
// Generated on: ${new Date().toLocaleString()}
// Mapped ${Object.keys(imageMapping).length}/${PRODUCT_SKUS.length} products

const IMAGE_MAPPING = {
${mappingEntries}
};

function getImageUrl(sku) {
    return IMAGE_MAPPING[sku] || \`https://via.placeholder.com/300x200/e2e8f0/64748b?text=\${sku}\`;
}`;

            elements.generatedCode.textContent = code;
            elements.codeSection.classList.remove('hidden');
            log('üìã JavaScript code generated', 'success');
        }

        function copyCode() {
            const code = elements.generatedCode.textContent;
            navigator.clipboard.writeText(code).then(() => {
                log('‚úÖ Code copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                log('‚úÖ Code copied to clipboard (fallback method)', 'success');
            });
        }

        function downloadCode() {
            const code = elements.generatedCode.textContent;
            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ozz-image-mapping-${new Date().toISOString().split('T')[0]}.js`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('üíæ Code downloaded as file', 'success');
        }

        function exportMapping() {
            const data = {
                meta: {
                    generated: new Date().toISOString(),
                    skuCount: PRODUCT_SKUS.length,
                    mappedCount: Object.keys(imageMapping).length,
                    folderId: CONFIG.FOLDER_ID
                },
                mapping: imageMapping
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ozz-image-mapping-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('üì§ JSON mapping exported', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check for cached data on load
            const cachedMapping = loadCache();
            if (cachedMapping) {
                imageMapping = cachedMapping;
                log('Found cached image mapping', 'info');
                elements.results.classList.remove('hidden');
                displayResults();
            }
        });
    </script>
</body>
</html>
