<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>üñºÔ∏è OZZ Drive Image Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        .log-entry { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold text-red-600 mb-4">üñºÔ∏è Google Drive Image Mapper</h1>
        
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h2 class="text-lg font-semibold mb-2">üîë Configuration</h2>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>üìÅ Folder ID: <code class="bg-gray-100 p-1 rounded">${CONFIG.FOLDER_ID}</code></div>
                <div>üîÑ Cache Duration: 24 hours</div>
                <div>üõí Products: ${CONFIG.PRODUCT_SKUS.length} SKUs</div>
            </div>
        </div>

        <div class="flex gap-4 mb-6">
            <button id="scanBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
                üöÄ Scan Drive Now
            </button>
            <button id="clearCacheBtn" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                üßπ Clear Cache
            </button>
        </div>

        <div id="progress" class="hidden mb-6">
            <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="progressText" class="text-center mt-2 text-gray-600">Initializing...</p>
        </div>

        <div id="results" class="hidden">
            <h2 class="text-xl font-semibold mb-4">üìä Mapping Results</h2>
            <div id="stats" class="grid grid-cols-4 gap-4 mb-6"></div>
            <div id="preview" class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6"></div>
            
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto">
                <pre id="codeOutput" class="text-sm"></pre>
            </div>
        </div>

        <div class="mt-6">
            <h3 class="text-lg font-semibold mb-2">üìù Activity Log</h3>
            <div id="log" class="bg-gray-100 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm"></div>
        </div>
    </div>

    <script>
        let imageMapping = {};
        let isScanning = false;

        // DOM elements
        const el = {
            scanBtn: document.getElementById('scanBtn'),
            clearCacheBtn: document.getElementById('clearCacheBtn'),
            progress: document.getElementById('progress'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            results: document.getElementById('results'),
            stats: document.getElementById('stats'),
            preview: document.getElementById('preview'),
            codeOutput: document.getElementById('codeOutput'),
            log: document.getElementById('log')
        };

        // Logging system
        function log(message, type = 'info') {
            const colors = {
                info: 'text-gray-800',
                success: 'text-green-600',
                warning: 'text-yellow-600',
                error: 'text-red-600'
            };
            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[type]}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            el.log.appendChild(entry);
            el.log.scrollTop = el.log.scrollHeight;
        }

        // Progress tracking
        function updateProgress(percent, message) {
            el.progress.classList.remove('hidden');
            el.progressBar.style.width = `${percent}%`;
            el.progressText.textContent = message;
        }

        // Cache management
        function loadCache() {
            try {
                const cached = localStorage.getItem(CONFIG.CACHE_KEY);
                if (!cached) return null;
                
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < CONFIG.CACHE_TTL) {
                    return data;
                }
            } catch (e) {
                log('Failed to load cache', 'error');
            }
            return null;
        }

        function saveCache(data) {
            const cacheData = {
                data,
                timestamp: Date.now()
            };
            localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(cacheData));
        }

        function clearCache() {
            localStorage.removeItem(CONFIG.CACHE_KEY);
            log('Cache cleared successfully', 'success');
        }

        // Drive API functions
        async function fetchDriveImages(pageToken = '') {
            const url = new URL('https://www.googleapis.com/drive/v3/files');
            url.searchParams.append('key', CONFIG.API_KEY);
            url.searchParams.append('q', `'${CONFIG.FOLDER_ID}' in parents and mimeType contains 'image/'`);
            url.searchParams.append('fields', 'files(id,name,thumbnailLink,webViewLink),nextPageToken');
            url.searchParams.append('pageSize', 1000);
            if (pageToken) url.searchParams.append('pageToken', pageToken);

            const response = await fetch(url);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            return await response.json();
        }

        // Image matching algorithm
        function findBestMatch(images, sku) {
            const skuLower = sku.toLowerCase();
            const skuNumeric = skuLower.replace(/\D/g, '');
            
            return images.reduce((best, img) => {
                const fileName = img.name.toLowerCase();
                let score = 0;
                
                // Exact match
                if (fileName === skuLower || fileName === `${skuLower}.jpg`) score = 100;
                // Starts with SKU
                else if (fileName.startsWith(skuLower)) score = 80;
                // Contains SKU with separator
                else if (fileName.includes(`_${skuLower}`) || fileName.includes(`-${skuLower}`)) score = 60;
                // Contains numeric SKU
                else if (fileName.includes(skuNumeric)) score = 40;
                
                return score > best.score ? { ...img, score } : best;
            }, { score: 0 }).score > 0;
        }

        // Main scanning function
        async function scanDrive() {
            if (isScanning) return;
            isScanning = true;
            el.scanBtn.disabled = true;
            el.scanBtn.textContent = 'üîÑ Scanning...';
            
            try {
                log('Starting Drive scan...');
                updateProgress(5, 'Initializing scan');
                
                // Check cache first
                const cached = loadCache();
                if (cached) {
                    imageMapping = cached;
                    showResults();
                    log('Loaded from cache', 'success');
                    return;
                }
                
                // Fetch all images
                let allImages = [];
                let nextPageToken = '';
                let page = 0;
                
                do {
                    page++;
                    const data = await fetchDriveImages(nextPageToken);
                    allImages = [...allImages, ...(data.files || [])];
                    nextPageToken = data.nextPageToken || '';
                    
                    const progress = Math.min(50, 5 + (page * 45));
                    updateProgress(progress, `Fetched ${allImages.length} images...`);
                    log(`Page ${page}: Found ${data.files?.length || 0} images`);
                } while (nextPageToken && page < 10);
                
                // Map images to SKUs
                imageMapping = {};
                let matched = 0;
                
                updateProgress(60, 'Matching images to products');
                
                for (const sku of CONFIG.PRODUCT_SKUS) {
                    const match = findBestMatch(allImages, sku);
                    if (match) {
                        imageMapping[sku] = {
                            url: `https://drive.google.com/uc?id=${match.id}`,
                            thumbnail: match.thumbnailLink,
                            filename: match.name
                        };
                        matched++;
                        log(`‚úÖ ${sku} ‚Üí ${match.name} (score: ${match.score})`, 'success');
                    } else {
                        log(`‚ö†Ô∏è No match for ${sku}`, 'warning');
                    }
                    
                    updateProgress(60 + (40 * matched / CONFIG.PRODUCT_SKUS.length), 
                        `Matched ${matched}/${CONFIG.PRODUCT_SKUS.length} SKUs`);
                }
                
                // Save results
                saveCache(imageMapping);
                showResults();
                log(`Scan complete! ${matched} products matched`, 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                isScanning = false;
                el.scanBtn.disabled = false;
                el.scanBtn.textContent = 'üîÑ Scan Again';
            }
        }

        // Display results
        function showResults() {
            const matched = Object.keys(imageMapping).length;
            const coverage = Math.round((matched / CONFIG.PRODUCT_SKUS.length) * 100);
            
            el.stats.innerHTML = `
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold">${matched}</div>
                    <div class="text-sm">Products Mapped</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold">${CONFIG.PRODUCT_SKUS.length}</div>
                    <div class="text-sm">Total Products</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold">${coverage}%</div>
                    <div class="text-sm">Coverage</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold">${new Date().toLocaleDateString()}</div>
                    <div class="text-sm">Last Scan</div>
                </div>
            `;
            
            // Show preview of first 8 matches
            const previewItems = Object.entries(imageMapping).slice(0, 8).map(([sku, data]) => `
                <div class="border rounded-lg p-2 text-center">
                    <img src="${data.thumbnail || data.url}" 
                         alt="${sku}" 
                         class="w-full h-20 object-contain mb-2"
                         onerror="this.src='https://via.placeholder.com/150'">
                    <div class="text-xs font-semibold">${sku}</div>
                    <div class="text-xs text-gray-500 truncate">${data.filename}</div>
                </div>
            `).join('');
            
            el.preview.innerHTML = previewItems;
            
            // Generate code output
            const code = `// Auto-generated image mapping
// ${new Date().toLocaleString()}
// ${matched}/${CONFIG.PRODUCT_SKUS.length} products matched

const IMAGE_MAPPING = {
${Object.entries(imageMapping).map(([sku, data]) => `    '${sku}': '${data.url}',`).join('\n')}
};

export default IMAGE_MAPPING;`;
            
            el.codeOutput.textContent = code;
            el.results.classList.remove('hidden');
        }

        // Event listeners
        el.scanBtn.addEventListener('click', scanDrive);
        el.clearCacheBtn.addEventListener('click', clearCache);

        // Initialize
        log('Ready to scan Google Drive folder');
        log(`Target folder: ${CONFIG.FOLDER_ID}`);
        log(`Will match ${CONFIG.PRODUCT_SKUS.length} product SKUs`);
    </script>
</body>
</html>
